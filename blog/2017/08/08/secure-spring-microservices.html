<!doctype html>
<!--[if lt IE 7 ]> <html class="ie6 no-flexbox"> <![endif]-->
<!--[if IE 7 ]>    <html class="ie7 no-flexbox"> <![endif]-->
<!--[if IE 8 ]>    <html class="ie8 no-flexbox"> <![endif]-->
<!--[if IE 9 ]>    <html class="ie9 no-flexbox"> <![endif]-->
<!--[if IE 10 ]>    <html class="ie10 no-flexbox"> <![endif]-->
<!--[if (gt IE 10)|!(IE)]><!--> <html class="modern wf-loading" lang="en"> <!--<![endif]-->
  <head><head>
  <script>
    var isProduction = window.location.hostname === 'developer.okta.com';
    if (isProduction) {
      // TypeKit
      (function(d) {
        var config = {
          kitId: 'jff5neq',
          scriptTimeout: 3000,
          async: true
        },
        h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
      })(document);

      // Google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-15777010-3', 'auto');
      ga('send', 'pageview');

      // START Google Tag Manager
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-TJ45R6');
      // END Google Tag Manager
    }
	</script>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
 	
  <link type="text/css" rel="stylesheet" href="/assets/animate-ec43d72c3ed45e08a460b8a2966d8dba6006aebfa0530935c3973fa493a8771f.css">
  <link type="text/css" rel="stylesheet" href="/assets/okta-5e6bf910e5a0721d71d9fb9af76c9807c5c9ba9a0cabb9b78fee8698d30b6b2c.css">
  
  
    <link type="text/css" rel="stylesheet" href="/assets/page-blog-367850afad8093d512ce46256493ec36aa919ccb2ed99af419063c06816ac5d8.css">
  
  <link rel="shortcut icon" type="image/vnd.microsoft.icon" href="/favicon.ico">
  <title>Secure a Spring Microservices Architecture with Spring Security, JWTs, Juiser, and Okta | Okta Developer</title>
  <meta name="description" content="You’ve built a microservices architecture with Spring Boot and Spring Cloud. You’re happy with the results, and you like how it adds resiliency to your appli...">
  <link rel="canonical" href="https://developer.okta.com/blog/2017/08/08/secure-spring-microservices">
  <link rel="alternate" type="application/rss+xml" title="Okta Developer" href="https://developer.okta.com/feed.xml"><!-- GA -->
</head>

    <body id="blog">
	
<header id="header">
      <div class="Wrap">
        <h1 class="logo"><a href="/">Okta</a></h1><!-- START Primary Nav -->
        <nav>
          <div id="top-nav">
            <a href="#" id="mobile-close" class="mobile-toggle">
              <span></span>
              <span></span>
            </a>
            <a class="Button--green" href="https://developer.okta.com/signup/" id="top-nav-cta">Get Started</a>
            <a class="SearchIcon" href="#"></a>
            <ul>
              <li>
                <a href="/product/">Product</a>
              </li>
              <li>
                <a href="/documentation/">Documentation</a>
              </li>
              <li>
                <a href="/code/">Code</a>
              </li>
              <li>
                <a href="/blog/">Blog</a>
              </li>
              <li class="has-dropdown">
                <a href="#">Support</a>
                <div class="dropdown-window">
                  <p class="devforum">Post your question on <a href="https://devforum.okta.com/" title="Okta Developer Forums" target="_blank">Okta Developer Forums</a></p>
                  <p class="email">Email us:<br>
                  <a href="mailto:developers@okta.com">developers@okta.com</a></p>
                  <p class="tel">Call us:<br>
                  <a href="tel:18887227871">1 (888) 722-7871</a></p>
                </div>
              </li>
            </ul>
            <form id="form_search" method="get" action="/search/" name="form_search">
              <input type="text" name="q" id="q" autocomplete="off">
            </form>
          </div>
          <div id="mobile-nav">
            <a id="mobile-search" href="/search/"><span class="icon-search-light"></span></a>
            <a id="mobile-open" class="mobile-toggle" href="#top-nav">
              <span></span>
              <span></span>
              <span></span>
            </a>
          </div>
        </nav><!-- END Primary Nav -->
      </div>
    </header>

	<div class="page-content">
		<section id="blog-post" class="main-container">
	<div class="wrap blog">
		<section >
  <div class="wrap">
    <article class="post-block">
      <header class="post-title-block">
        <h1><a href="/blog/2017/08/08/secure-spring-microservices">Secure a Spring Microservices Architecture with Spring Security, JWTs, Juiser, and Okta</a></h1>
        <div class="attribution">
          
            
            
              <img src="/assets/avatar-matt_raible-9974af6192eb1753b7137c8fff0a2c6e6bb9736a2517986cb5cc50bb040e83d4.jpg" alt="avatar-matt_raible.jpg" class="author-avatar">
            
            <address>Matt Raible</address>&nbsp;
            
              <a class="social_link" href="https://github.com/mraible"><i class="fa fa-github-square"></i></a>
            
            
              <a class="social_link" href="https://twitter.com/mraible"><i class="fa fa-twitter-square"></i></a>
            
            
            
              <a class="social_link" href="http://raibledesigns.com"><i class="fa fa-external-link-square"></i></a>
            
            <span class="sepr">&middot;</span>
          
          <time datetime="2017-08-08">August 8, 2017</time>
	      </div>
	    </header>
	    <section class="post-content">
	     <p>You’ve built a microservices architecture with Spring Boot and Spring Cloud. You’re happy with the results, and you like how it adds resiliency to your application. You’re also pleased with how it scales and how different teams can deploy microservices independently. But what about security?</p>

<p>Are you using Spring Security to lock everything down? Are your microservices locked down too, or are they just behind the firewall?</p>

<p>This tutorial shows you how you can use Spring Security, Okta, and a few Java libraries to secure your microservices architecture. Not only that, but I’ll show you how to secure <em>everything</em>, so even your backend services communicate securely. You’ll learn how to use JWTs and <a href="https://github.com/juiser/juiser">Juiser</a> to read an <code class="highlighter-rouge">X-Forwarded-User</code> header and turn it into a Spring Security <code class="highlighter-rouge">User</code>.</p>

<p>This tutorial builds off <a href="/blog/2017/06/15/build-microservices-architecture-spring-boot">Build a Microservices Architecture for Microbrews with Spring Boot</a>. A simple microservices architecture with Spring Boot and Spring Cloud looks as follows. It uses Stormpath’s Spring Boot Starter (it’s been modified to work with Okta while we work on building up Okta’s Java support) and Juiser, a library created by <a href="https://twitter.com/lhazlewood">Les Hazlewood</a>. Juiser is independent and open source, and is not tied to a particular identity provider.</p>

<p><img src="/assets/blog/microservices-spring-secure/spring-microservices-diagram-4ab97ef8fd57e8c120dfcda47985d571070bfe39df2cbf1b582fb05ab524d96b.png" alt="Spring Boot + Cloud Microservices Architecture" width="800" /></p>

<p>Once you’ve completed this tutorial, you’ll have Spring Security locking things down, and Okta providing authentication and JWT validation.</p>

<p><img src="/assets/blog/microservices-spring-secure/spring-secure-microservices-diagram-f94c76eebed54e7e070d97adad7987c4e2ccfd95c478a330b334de16fefd840a.png" alt="Secure Spring Microservices" width="800" /></p>

<p>To begin, you’ll need to clone the aforementioned article’s completed project.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>git clone https://github.com/oktadeveloper/spring-boot-microservices-example.git
</code></pre>
</div>

<p><a href="https://github.com/stormpath/stormpath-sdk-java/blob/okta/OktaGettingStarted.md">Create an Okta Developer account</a>. After completing these steps, you should have the information you need to set the following environment variables.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">export </span><span class="nv">STORMPATH_CLIENT_BASEURL</span><span class="o">=[</span>base-url]
<span class="nb">export </span><span class="nv">OKTA_APPLICATION_ID</span><span class="o">=[</span>application-id]
<span class="nb">export </span><span class="nv">OKTA_API_TOKEN</span><span class="o">=[</span>api-token]
</code></pre>
</div>

<h2 id="add-stormpaths-zuul-support-to-the-edge-service">Add Stormpath’s Zuul Support to the Edge Service</h2>

<blockquote>
  <p><strong>NOTE:</strong> I’m using Stormpath’s Java SDK in this example. It has been updated to work with Okta’s API. We plan to release 
Okta libraries that have this same functionality soon. I’ll make sure to update this post when the Okta Zuul support has 
been released.</p>
</blockquote>

<p>The <strong>edge-service</strong> application handles the routing to the backend <code class="highlighter-rouge">beer-catalog-service</code>, so it’s the best place to start securing things. Add the Stormpath BOM (Bill Of Materials) in the <code class="highlighter-rouge">dependencyManagement</code> section of <code class="highlighter-rouge">edge-service/pom.xml</code>.</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.stormpath.sdk<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>stormpath-bom<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.0.0-okta-rc3<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre>
</div>

<p>Then add a dependency for Stormpath’s Zuul integration.</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.stormpath.spring<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>stormpath-zuul-spring-cloud-starter<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre>
</div>

<p>Add the following properties and values to the project’s <code class="highlighter-rouge">application.properties</code>.</p>

<div class="language-properties highlighter-rouge"><pre class="highlight"><code><span class="err">server.use-forward-</span><span class="py">headers</span><span class="p">=</span><span class="s">true</span>

<span class="err">zuul.routes.beer-catalog-</span><span class="py">service.path</span><span class="p">=</span><span class="s">/beers</span>
<span class="err">zuul.routes.beer-catalog-</span><span class="py">service.url</span><span class="p">=</span><span class="s">http://localhost:8080</span>

<span class="py">zuul.routes.home.path</span><span class="p">=</span><span class="s">/home</span>
<span class="py">zuul.routes.home.url</span><span class="p">=</span><span class="s">http://localhost:8080</span>

<span class="py">stormpath.web.cors.allowed.originUris</span><span class="p">=</span><span class="s">http://localhost:4200</span>

<span class="py">stormpath.zuul.account.header.jwt.key.resource</span><span class="p">=</span><span class="s">classpath:rsatest.priv.pem</span>
<span class="c"># This is just one example of a key ID - anything that the origin server can make sense of to lookup
# the corresponding public key is fine. Here we use the public key file name.
</span><span class="py">stormpath.zuul.account.header.jwt.key.id</span><span class="p">=</span><span class="s">rsatest.pub.pem</span>
</code></pre>
</div>

<p>Copy the <code class="highlighter-rouge">rsatest.*</code> files from the <a href="https://github.com/stormpath/stormpath-sdk-java/tree/master/examples/zuul-spring-cloud-starter/src/main/resources">Stormpath Zuul example project</a>, or create new ones using the following command:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>openssl genrsa -out rsatest.priv.pem 2048
</code></pre>
</div>

<p>Generate the private key’s corresponding <code class="highlighter-rouge">rsatest.pub.pem</code> public key with:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>openssl rsa -in rsatest.priv.pem -pubout &gt; rsatest.pub.pem
</code></pre>
</div>

<p>After copying (or generating), both <code class="highlighter-rouge">rsatest.priv.pem</code> and <code class="highlighter-rouge">rsatest.pub.pem</code> files should be in 
<code class="highlighter-rouge">edge-service/src/main/resources</code>.</p>

<h2 id="add-juiser-to-the-beer-catalog-service">Add Juiser to the Beer Catalog Service</h2>

<p><a href="https://github.com/juiser/juiser">Juiser</a> is a small Java library that automates token authentication during an HTTP request. In this example, Juiser reads the <code class="highlighter-rouge">X-Forwarded-User</code> header and creates a Spring Security <code class="highlighter-rouge">User</code> for you.</p>

<p>For Juiser to read the JWT sent by Stormpath’s Zuul support, you need to copy the public key (<code class="highlighter-rouge">rsatest.pub.pem</code>) from <code class="highlighter-rouge">edge-service/src/main/resources</code> to <code class="highlighter-rouge">beer-catalog-service/src/main/resources</code>. Then add the following dependencies to the Beer Catalog Service’s <code class="highlighter-rouge">pom.xml</code>.</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;properties&gt;</span>
    ...
    <span class="nt">&lt;bouncycastle.version&gt;</span>1.56<span class="nt">&lt;/bouncycastle.version&gt;</span>
    <span class="nt">&lt;juiser.version&gt;</span>1.0.0<span class="nt">&lt;/juiser.version&gt;</span>
<span class="nt">&lt;/properties&gt;</span>

<span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="c">&lt;!-- To handle the X-Forwarded-User header: --&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.juiser<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>juiser-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${juiser.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="c">&lt;!-- So juiser can read *.pem public key files to verify the signature of the JWT in the
             X-Forwarded-User header: --&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.bouncycastle<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>bcpkix-jdk15on<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${bouncycastle.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.security<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-security-config<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.security<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-security-web<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-thymeleaf<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    ...
<span class="nt">&lt;/dependencies&gt;</span>
</code></pre>
</div>

<p>Create a <code class="highlighter-rouge">HomeController</code> in <code class="highlighter-rouge">src/main/java/com/example/HomeController.java</code> to render the user’s information so you can verify authentication is working.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.juiser.model.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.ui.Model</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">User</span> <span class="n">user</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">HomeController</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/home"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">howdy</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"home"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p><strong>NOTE:</strong> There is an issue with Juiser 1.0.0 that it won’t initialize if you don’t have at least one <code class="highlighter-rouge">@Controller</code> in your project.</p>

<p>Create a <code class="highlighter-rouge">home.html</code> template in <code class="highlighter-rouge">src/main/resources/templates/home.html</code> and populate it with the following code.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="nt">&lt;html</span> <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;style&gt;</span>
        <span class="nt">th</span> <span class="p">{</span>
            <span class="nl">text-align</span><span class="p">:</span> <span class="nb">left</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nt">td</span> <span class="p">{</span>
            <span class="nl">white-space</span><span class="p">:</span> <span class="nb">nowrap</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nt">td</span><span class="nd">:first-child</span> <span class="p">{</span>
            <span class="nl">font-family</span><span class="p">:</span> <span class="s1">"Courier"</span><span class="p">,</span> <span class="nb">monospace</span><span class="p">;</span>
            <span class="nl">font-size</span><span class="p">:</span> <span class="m">0.9em</span><span class="p">;</span>
            <span class="nl">color</span><span class="p">:</span> <span class="m">#343434</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;h1&gt;</span>Hello<span class="nt">&lt;span</span> <span class="na">th:if=</span><span class="s">"${user.authenticated}"</span> <span class="na">th:text=</span><span class="s">"' ' + ${user.givenName}"</span><span class="nt">&gt;</span> Joe<span class="nt">&lt;/span&gt;</span>!<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;div</span> <span class="na">th:unless=</span><span class="s">"${user.authenticated}"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">th:href=</span><span class="s">"@{/login}"</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">th:if=</span><span class="s">"${user.authenticated}"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">"logoutForm"</span> <span class="na">th:action=</span><span class="s">"@{/logout}"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Logout"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;h2&gt;</span>User Properties<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;table&gt;</span>
    <span class="nt">&lt;thead&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;th&gt;</span>Name<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;th&gt;</span>Value<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/thead&gt;</span>
    <span class="nt">&lt;tbody&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>anonymous<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.anonymous}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>authenticated<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.authenticated}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>href<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.href}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>id<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.id}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>name<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.name}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>givenName<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.givenName}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>middleName<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.middleName}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>familyName<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.familyName}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>nickname<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.nickname}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>username<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.username}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>profile<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.profile}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>picture<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.picture}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>website<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.website}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>email<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.email}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>emailVerified<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.emailVerified}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>gender<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.gender}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>birthdate<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.birthdate}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>zoneInfo<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.zoneInfo}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>phoneNumber<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.phone}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>phoneNumberVerified<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.phoneNumberVerified}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>createdAt<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.createdAt}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>updatedAt<span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${user.updatedAt}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/tbody&gt;</span>
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>

<p>Add the following properties to <code class="highlighter-rouge">src/main/resources/application.properties</code> to configure Juiser.</p>

<div class="language-properties highlighter-rouge"><pre class="highlight"><code><span class="err">server.use-forward-</span><span class="py">headers</span><span class="p">=</span><span class="s">true</span>
<span class="py">juiser.header.jwt.key.resource</span><span class="p">=</span><span class="s">classpath:rsatest.pub.pem</span>
</code></pre>
</div>

<p>Create a <code class="highlighter-rouge">SecurityConfig.java</code> class in the same package as <code class="highlighter-rouge">HomeController</code>. This class configures Spring Security so it secures all endpoints.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">().</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">fullyAuthenticated</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h3 id="add-requestinterceptor-for-feign">Add RequestInterceptor for Feign</h3>

<p>The <code class="highlighter-rouge">@FeignClient</code> used to talk to <code class="highlighter-rouge">beer-catalog-service</code> is not aware of the <code class="highlighter-rouge">X-Forwarded-User</code> header. To make it aware, create a <code class="highlighter-rouge">ForwardedAccountRequestInterceptor</code> class in the same directory as <code class="highlighter-rouge">EdgeServiceApplication</code>.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.stormpath.sdk.servlet.http.Resolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.stormpath.zuul.account.ForwardedAccountHeaderFilter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">feign.RequestInterceptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">feign.RequestTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.RequestContextHolder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.context.request.ServletRequestAttributes</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ForwardedAccountRequestInterceptor</span> <span class="kd">implements</span> <span class="n">RequestInterceptor</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">ForwardedAccountRequestInterceptor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Resolver</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">valueResolver</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ForwardedAccountRequestInterceptor</span><span class="o">(</span><span class="n">Resolver</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">accountStringResolver</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">valueResolver</span> <span class="o">=</span> <span class="n">accountStringResolver</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">apply</span><span class="o">(</span><span class="n">RequestTemplate</span> <span class="n">template</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">template</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">containsKey</span><span class="o">(</span><span class="n">ForwardedAccountHeaderFilter</span><span class="o">.</span><span class="na">DEFAULT_HEADER_NAME</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"The X-Forwarded-User has been already set"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Constructing Header {} for Account"</span><span class="o">,</span> <span class="n">ForwardedAccountHeaderFilter</span><span class="o">.</span><span class="na">DEFAULT_HEADER_NAME</span><span class="o">);</span>
            <span class="n">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="o">((</span><span class="n">ServletRequestAttributes</span><span class="o">)</span> <span class="n">RequestContextHolder</span><span class="o">.</span><span class="na">getRequestAttributes</span><span class="o">()).</span><span class="na">getRequest</span><span class="o">();</span>
            <span class="n">HttpServletResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="o">((</span><span class="n">ServletRequestAttributes</span><span class="o">)</span> <span class="n">RequestContextHolder</span><span class="o">.</span><span class="na">getRequestAttributes</span><span class="o">()).</span><span class="na">getResponse</span><span class="o">();</span>
            <span class="n">template</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="n">ForwardedAccountHeaderFilter</span><span class="o">.</span><span class="na">DEFAULT_HEADER_NAME</span><span class="o">,</span> <span class="n">valueResolver</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Register it as a <code class="highlighter-rouge">@Bean</code> in <code class="highlighter-rouge">EdgeServiceApplication</code>.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">RequestInterceptor</span> <span class="nf">forwardedAccountRequestInterceptor</span><span class="o">(</span>
        <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"stormpathForwardedAccountHeaderValueResolver"</span><span class="o">)</span> <span class="n">Resolver</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">accountStringResolver</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ForwardedAccountRequestInterceptor</span><span class="o">(</span><span class="n">accountStringResolver</span><span class="o">);</span>
<span class="o">}</span>
</code></pre>
</div>

<p>While you’re modifying <code class="highlighter-rouge">EdgeServiceApplication</code>, change the <code class="highlighter-rouge">HystrixCommand</code> in <code class="highlighter-rouge">BeerController</code> to make Hystrix <a href="http://stackoverflow.com/q/29566777/65681">execute on the calling thread</a> (so it’s aware of the security context).</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@HystrixCommand</span><span class="o">(</span><span class="n">fallbackMethod</span> <span class="o">=</span> <span class="s">"fallback"</span><span class="o">,</span> <span class="n">commandProperties</span> <span class="o">=</span> <span class="o">{</span>
        <span class="nd">@HystrixProperty</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"execution.isolation.strategy"</span><span class="o">,</span> <span class="n">value</span><span class="o">=</span><span class="s">"SEMAPHORE"</span><span class="o">)</span>
<span class="o">})</span>
</code></pre>
</div>

<h3 id="verify-secure-communication">Verify Secure Communication</h3>

<p>Verify communication between the <code class="highlighter-rouge">edge-service</code> and <code class="highlighter-rouge">beer-catalog-service</code> works by starting all the Spring Boot applications. First, start <code class="highlighter-rouge">eureka-service</code>:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">cd </span>eureka-service
./mvnw spring-boot:run
</code></pre>
</div>

<p>In a new terminal window, start <code class="highlighter-rouge">beer-catalog-service</code>:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">cd </span>beer-catalog-service
./mvnw spring-boot:run
</code></pre>
</div>

<p>In another terminal window, start <code class="highlighter-rouge">edge-service</code>:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">cd </span>edge-service
./mvnw spring-boot:run
</code></pre>
</div>

<p>Open your browser and navigate to <a href="http://localhost:8081/home">http://localhost:8081/home</a>. You should see a login page, prompting for your credentials.</p>

<p><img src="/assets/blog/microservices-spring-secure/zuul-login-27417121eb49acb2bf1e659e6b760a7586129d21031917a419c3cddb1cc4236a.png" alt="Stormpath Zuul Login" width="800" /></p>

<p>This page is served up from the <code class="highlighter-rouge">stormpath-zuul-spring-cloud-starter</code> using <a href="http://www.thymeleaf.org/">Thymeleaf</a>. Spring Boot auto-activates Thymeleaf when it finds it in the classpath.</p>

<p>After logging in, you should see a page displaying your user’s information.</p>

<p><img src="/assets/blog/microservices-spring-secure/zuul-home-e50e722717c7924beb4cb1b267de314f7223ba987f5408c33a9dd71da2ccbf12.png" alt="Stormpath Zuul Home" width="800" /></p>

<p>Click the <strong>Logout</strong> button to delete the cookies in your browser and end your session.</p>
<h2 id="add-oktas-sign-in-widget-to-the-client">Add Okta’s Sign-In Widget to the Client</h2>

<p>Install <a href="https://developer.okta.com/code/javascript/okta_sign-in_widget">Okta’s Sign-In Widget</a> to make it possible to communicate with the secured server.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nb">cd </span>client
npm install @okta/okta-signin-widget --save
</code></pre>
</div>

<p>Create <code class="highlighter-rouge">client/src/app/shared/okta/okta.service.ts</code> and use it to configure the widget to talk to your Okta instance.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">OktaSignIn</span> <span class="k">from</span> <span class="s1">'@okta/okta-signin-widget/dist/js/okta-sign-in.min.js'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">ReplaySubject</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs/ReplaySubject'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs/Observable'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">OktaAuthService</span> <span class="p">{</span>

  <span class="nx">signIn</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OktaSignIn</span><span class="p">({</span>
    <span class="na">baseUrl</span><span class="p">:</span> <span class="s1">'https://{yourOktaDomain}.com'</span><span class="p">,</span>
    <span class="na">clientId</span><span class="p">:</span> <span class="s1">'{clientId}'</span><span class="p">,</span>
    <span class="na">authParams</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">issuer</span><span class="p">:</span> <span class="s1">'https://{yourOktaDomain}'</span><span class="p">,</span>
      <span class="na">responseType</span><span class="p">:</span> <span class="p">[</span><span class="s1">'id_token'</span><span class="p">,</span> <span class="s1">'token'</span><span class="p">],</span>
      <span class="na">scopes</span><span class="p">:</span> <span class="p">[</span><span class="s1">'openid'</span><span class="p">,</span> <span class="s1">'email'</span><span class="p">,</span> <span class="s1">'profile'</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="k">public</span> <span class="nx">user</span><span class="na">$</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">public</span> <span class="na">userSource</span><span class="p">:</span> <span class="nx">ReplaySubject</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">userSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReplaySubject</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="c1">// create an observable that can be subscribed to for user events</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">user$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">userSource</span><span class="p">.</span><span class="nx">asObservable</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">isAuthenticated</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Checks if there is a current accessToken in the TokenManger.</span>
    <span class="k">return</span> <span class="o">!!</span><span class="k">this</span><span class="p">.</span><span class="nx">signIn</span><span class="p">.</span><span class="nx">tokenManager</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'accessToken'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">login</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Launches the widget and stores the tokens.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">signIn</span><span class="p">.</span><span class="nx">renderEl</span><span class="p">({</span><span class="na">el</span><span class="p">:</span> <span class="s1">'#okta-signin-container'</span><span class="p">},</span> <span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="s1">'SUCCESS'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">token</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">idToken</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">signIn</span><span class="p">.</span><span class="nx">tokenManager</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">'idToken'</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">accessToken</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">signIn</span><span class="p">.</span><span class="nx">tokenManager</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">'accessToken'</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">userSource</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">idTokenAsUser</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">signIn</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
        <span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">get</span> <span class="nx">idTokenAsUser</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">signIn</span><span class="p">.</span><span class="nx">tokenManager</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'idToken'</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">name</span><span class="p">:</span> <span class="nx">token</span><span class="p">.</span><span class="nx">claims</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
      <span class="na">email</span><span class="p">:</span> <span class="nx">token</span><span class="p">.</span><span class="nx">claims</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
      <span class="na">username</span><span class="p">:</span> <span class="nx">token</span><span class="p">.</span><span class="nx">claims</span><span class="p">.</span><span class="nx">preferred_username</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">logout</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Terminates the session with Okta and removes current tokens.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">signIn</span><span class="p">.</span><span class="nx">tokenManager</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">signIn</span><span class="p">.</span><span class="nx">signOut</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">signIn</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">userSource</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="kc">undefined</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Make sure to replace <code class="highlighter-rouge"><span class="p">{</span><span class="err">yourOktaDomain</span><span class="p">}</span></code> and <code class="highlighter-rouge"><span class="p">{</span><span class="err">client</span><span class="p">}</span></code> in the above code.</p>

<p>Add <code class="highlighter-rouge">OktaAuthService</code> as a provider to <code class="highlighter-rouge">client/src/app/app.module.ts</code>.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">OktaAuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./shared/okta/okta.service'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">NgModule</span><span class="p">({</span>
  <span class="p">...</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">BeerService</span><span class="p">,</span> <span class="nx">GiphyService</span><span class="p">,</span> <span class="nx">OktaAuthService</span>
  <span class="p">],</span>
  <span class="na">bootstrap</span><span class="p">:</span> <span class="p">[</span><span class="nx">AppComponent</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">AppModule</span> <span class="p">{</span> <span class="p">}</span>
</code></pre>
</div>

<p>Modify <code class="highlighter-rouge">client/src/app/shared/beer/beer.service.ts</code> to read the access token and set it in an <code class="highlighter-rouge">Authorization</code> header when 
it exists.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Http</span><span class="p">,</span> <span class="nx">Headers</span><span class="p">,</span> <span class="nx">RequestOptions</span><span class="p">,</span> <span class="nx">Response</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/http'</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">'rxjs/add/operator/map'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">OktaAuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../okta/okta.service'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">BeerService</span> <span class="p">{</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">http</span><span class="err">:</span> <span class="nx">Http</span><span class="p">,</span> <span class="k">private</span> <span class="nx">oktaService</span><span class="err">:</span> <span class="nx">OktaAuthService</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="nx">getAll</span><span class="p">()</span><span class="err">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="na">headers</span><span class="p">:</span> <span class="nx">Headers</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Headers</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">oktaService</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">())</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">accessToken</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">oktaService</span><span class="p">.</span><span class="nx">signIn</span><span class="p">.</span><span class="nx">tokenManager</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'accessToken'</span><span class="p">);</span>
      <span class="nx">headers</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">'Authorization'</span><span class="p">,</span> <span class="nx">accessToken</span><span class="p">.</span><span class="nx">tokenType</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span> <span class="nx">accessToken</span><span class="p">.</span><span class="nx">accessToken</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RequestOptions</span><span class="p">({</span> <span class="na">headers</span><span class="p">:</span> <span class="nx">headers</span> <span class="p">});</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'http://localhost:8081/good-beers'</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="na">response</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Modify <code class="highlighter-rouge">app.component.html</code> to add a placeholder for the widget and a section to show the user’s name and a logout button.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;md-toolbar</span> <span class="na">color=</span><span class="s">"primary"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;span&gt;</span>{{title}}<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/md-toolbar&gt;</span>

<span class="c">&lt;!-- Container to inject the Sign-In Widget --&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"okta-signin-container"</span><span class="nt">&gt;&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="err">*</span><span class="na">ngIf=</span><span class="s">"user"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h2&gt;</span>
    Welcome {{user?.name}}!
  <span class="nt">&lt;/h2&gt;</span>

  <span class="nt">&lt;button</span> <span class="na">md-raised-button</span> <span class="err">(</span><span class="na">click</span><span class="err">)="</span><span class="na">oktaService</span><span class="err">.</span><span class="na">logout</span><span class="err">()"</span><span class="nt">&gt;</span>Logout<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;md-progress-bar</span> <span class="na">mode=</span><span class="s">"indeterminate"</span> <span class="err">*</span><span class="na">shellRender</span><span class="nt">&gt;&lt;/md-progress-bar&gt;</span>
<span class="nt">&lt;div</span> <span class="err">[</span><span class="na">hidden</span><span class="err">]="!</span><span class="na">user</span><span class="err">"</span> <span class="err">*</span><span class="na">shellNoRender</span><span class="nt">&gt;</span>
  <span class="nt">&lt;app-beer-list&gt;&lt;/app-beer-list&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>
</div>

<p>You’ll notice the <code class="highlighter-rouge">user</code> variable in the HTML. To resolve this, you need to change your <code class="highlighter-rouge">AppComponent</code>, so it 1) shows
the login or converts the token on initial load and 2) subscribes to changes in the <code class="highlighter-rouge">user$</code> observable from <code class="highlighter-rouge">OktaAuthService</code>.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">ChangeDetectorRef</span><span class="p">,</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">OktaAuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./shared/okta/okta.service'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-root'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./app.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./app.component.css'</span><span class="p">],</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">AppComponent</span> <span class="k">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>
  <span class="nx">title</span> <span class="o">=</span> <span class="s1">'app works!'</span><span class="p">;</span>
  <span class="nx">user</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">public</span> <span class="nx">oktaService</span><span class="err">:</span> <span class="nx">OktaAuthService</span><span class="p">,</span> <span class="k">private</span> <span class="nx">changeDetectorRef</span><span class="err">:</span> <span class="nx">ChangeDetectorRef</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 1. for initial load and browser refresh</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">oktaService</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">oktaService</span><span class="p">.</span><span class="nx">idTokenAsUser</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">oktaService</span><span class="p">.</span><span class="nx">login</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// 2. register a listener for authentication and logout</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">oktaService</span><span class="p">.</span><span class="nx">user$</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">oktaService</span><span class="p">.</span><span class="nx">login</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="c1">// Let Angular know that model changed.</span>
      <span class="c1">// See https://github.com/okta/okta-signin-widget/issues/268 for more info.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">changeDetectorRef</span><span class="p">.</span><span class="nx">detectChanges</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Okta’s Sign-In Widget ships with CSS that make it looks good out-of-the-box. To use them in your application, modify 
 <code class="highlighter-rouge">client/src/styles.css</code> to have the following two imports.</p>

<div class="language-css highlighter-rouge"><pre class="highlight"><code><span class="k">@import</span> <span class="s2">'~https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/2.1.0/css/okta-sign-in.min.css'</span><span class="p">;</span>
<span class="k">@import</span> <span class="s2">'~https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/2.1.0/css/okta-theme.css'</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="verify-authentication-works">Verify Authentication Works</h3>

<p>Navigate to <a href="http://localhost:4200">http://localhost:4200</a>, and you should see a login form like the following.</p>

<p><img src="/assets/blog/microservices-spring-secure/angular-login-fff6e25e2a4037b9c42f4247422436f5a92da4a84cdc6361fed3c6c7659afef6.png" alt="Angular Login" width="800" /></p>

<p><strong>NOTE:</strong> If it logs you in automatically, this is likely because you have cookies for <code class="highlighter-rouge">http://localhost:8080</code> still in 
your browser. Clear your cookies, or try an incognito window.</p>

<p>If you want to adjust the style of the form, so it isn’t right up against the top toolbar, add the following to <code class="highlighter-rouge">styles.css</code>.</p>

<div class="language-css highlighter-rouge"><pre class="highlight"><code><span class="nf">#okta-signin-container</span> <span class="p">{</span>
  <span class="nl">margin-top</span><span class="p">:</span> <span class="m">25px</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p><img src="/assets/blog/microservices-spring-secure/angular-login-top-margin-ccb5bbecb9f8c8ff71fba24d0f2a742ee11fcf72960a181c7bde9bd39d8e0aea.png" alt="Angular Login Styled" width="800" /></p>

<p>You should be able to log in, see a welcome message, as well as a logout button.</p>

<p><img src="/assets/blog/microservices-spring-secure/angular-welcome-3041f05a81f1b808c394676dbaf50e73c88f3032628c1a7bf3ceffd705fb2c62.png" alt="Angular Welcome" width="800" /></p>

<h2 id="learn-more">Learn More</h2>

<p>This article showed you how to use Spring Security, Okta, and a few Java libraries to secure a microservices architecture. With JWTs, Zuul, Spring Security, and Juiser, you can ensure your backend services communicate securely.</p>

<p>The source code for this tutorial is <a href="https://github.com/oktadeveloper/spring-boot-microservices-example/">available on GitHub</a>, in the <a href="https://github.com/oktadeveloper/spring-boot-microservices-example/tree/okta">“okta” branch</a>.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>git clone https://github.com/oktadeveloper/spring-boot-microservices-example.git
git checkout okta
</code></pre>
</div>

<p>Learn more about Okta and its APIs at <a href="http://developer.okta.com">developer.okta.com</a>. If you have questions about this tutorial, please hit me up on Twitter <a href="https://twitter.com/mraible">@mraible</a> or post a question to <a href="https://stackoverflow.com/questions/tagged/okta">Stack Overflow with an “okta” tag</a>.</p>

	    </section>
	  </article>
  </div>
</section>

	</div>
</section>

		
	</div><footer class="footer">
      <div class="Wrap">
        <ul>
          <li>
            <a href="https://www.okta.com" target="_blank">Okta.com</a>
          </li>
          <li>
            <a href="/docs/platform-release-notes/platform-release-notes.html">Platform Release Notes</a>
          </li>
          <li>
            <a href="/terms/">Terms & Conditions</a>
          </li>
          <li>
            <a href="/3rd_party_notices/">3rd Party Notices</a>
          </li>
          <li>
            <a href="/privacy/">Privacy Policy</a>
          </li>
          <li>
            <a href="/contact/">Contact Sales</a>
          </li>
          <li>
            <a href="mailto:developers@okta.com">Contact Support</a>
          </li>
        </ul>
        <ul>
          <li>
            <a class="icon" href="http://github.com/oktadeveloper" target="_blank"><i class="fa fa-github"></i></a>
          </li>
          <li>
            <a class="icon" href="http://twitter.com/OktaDev" target="_blank"><i class="fa fa-twitter"></i></a>
          </li>
          <li>
            <a class="icon" href="https://devforum.okta.com/" title="Okta Developer Forums" target="_blank"><i class="fa fa-comments"></i></a>
          </li>
          <li>
            <a class="icon" href="http://feeds.feedburner.com/OktaBlog" target="_blank"><i class="fa fa-rss"></i></a>
          </li><!-- <li><a class="icon" href="http://community.okta.com" target="_blank"><i class="fa fa-comments"></i></a></li> -->
        </ul>
      </div>
    </footer>
    <script type="text/javascript" src="/assets/master-d164e3cb90ad42ea74c141546269db0efdbc2259b7d44b7f52babb60097099a8.js"></script>
    
    
    
    

  <!-- START Post Footer -->
  
  <!-- START Google Tag Manager -->
  <!-- https://support.google.com/tagmanager/answer/6103696?hl=en -->
  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-TJ45R6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- END Google Tag Manager -->
  <!-- START Google Remarketing Tag -->
  <script type="text/javascript">
    /* <![CDATA[ */
    var google_conversion_id = 1006913831;
    var google_custom_params = window.google_tag_params;
    var google_remarketing_only = true;
    /* ]]> */
  </script>
  <div style="display:none;"><script type="text/javascript" src="//www.googleadservices.com/pagead/conversion.js"></script></div>
  <noscript><div style="display:inline;"><img height="1" width="1" style="border-style:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/1006913831/?value=0&amp;guid=ON&amp;script=0"></div></noscript>
  <!-- END Google Remarketing Tag -->
  <!-- START Crazy Egg Tracking -->
  <script type="text/javascript">
    setTimeout(function(){var a=document.createElement("script");
    var b=document.getElementsByTagName("script")[0];
    a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0021/9333.js?"+Math.floor(new Date().getTime()/3600000);
    a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
  </script>
  <!-- END Crazy Egg Tracking -->

  <!-- END Post Footer -->
</body>
</html>
