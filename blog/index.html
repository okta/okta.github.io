<!doctype html>
<!--[if lt IE 7 ]> <html class="ie6 no-flexbox"> <![endif]-->
<!--[if IE 7 ]>    <html class="ie7 no-flexbox"> <![endif]-->
<!--[if IE 8 ]>    <html class="ie8 no-flexbox"> <![endif]-->
<!--[if IE 9 ]>    <html class="ie9 no-flexbox"> <![endif]-->
<!--[if IE 10 ]>    <html class="ie10 no-flexbox"> <![endif]-->
<!--[if (gt IE 10)|!(IE)]><!--> <html class="modern wf-loading" lang="en"> <!--<![endif]-->
  <head><head>
  <script>
  (function(d) {
    var config = {
      kitId: 'jff5neq',
      scriptTimeout: 3000,
      async: true
    },
    h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
  })(document);
	</script>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
 	
  <link rel="shortcut icon" type="image/vnd.microsoft.icon" href="/favicon.ico">
  <link rel="stylesheet" href="/assets/css/page-blog.css">
  <link rel="stylesheet" type="text/css" media="all" href="/assets/css/animate.css">
  <link rel="stylesheet" type="text/css" media="all" href="/assets/css/okta.css">
  <title>Blog | Okta Developer</title>
  <meta name="description" content="Secure, scalable, and highly available authentication and user management for any app.
">
  <link rel="canonical" href="http://developer.okta.com/blog/">
  <link rel="alternate" type="application/rss+xml" title="Okta Developer" href="http://developer.okta.com/feed.xml"><!-- GA -->

  <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-15777010-3', 'auto');
        ga('send', 'pageview');
  </script>
</head>

    <body id="blog">
	<header id="header">
      <div class="Wrap">
        <h1 class="logo"><a href="/">Okta</a></h1><!-- START Primary Nav -->
        <nav>
          <div id="top-nav">
            <a href="#" id="mobile-close" class="mobile-toggle">
              <span></span>
              <span></span>
            </a>
            <a class="Button--green" href="https://www.okta.com/developer/signup" id="top-nav-cta">Get Started</a>
            <a class="SearchIcon" href="#"></a>
            <ul>
              <li>
                <a href="/product/">Product</a>
              </li>
              <li>
                <a href="/documentation/">Documentation</a>
              </li>
              <li>
                <a href="/code/">Code</a>
              </li>
              <li class="has-dropdown">
                <a href="#">Support</a>
                <div class="dropdown-window">
                  <p class="stack-overflow">Post your question on <a href="http://stackoverflow.com/search?q=okta" target="_blank">Stack Overflow</a></p>
                  <p class="email">Email us:<br>
                  <a href="mailto:developers@okta.com">developers@okta.com</a></p>
                  <p class="tel">Call us:<br>
                  <a href="tel:18887227871">1 (888) 722-7871</a></p>
                </div>
              </li>
            </ul>
            <form id="form_search" method="get" action="http://developer.okta.com/search/" name="form_search">
              <input type="text" name="q" id="q" autocomplete="off">
            </form>
          </div>
          <div id="mobile-nav">
            <a id="mobile-search" href="http://developer.okta.com/search/"><span class="icon-search-light"></span></a>
            <a id="mobile-open" class="mobile-toggle" href="#top-nav">
              <span></span>
              <span></span>
              <span></span>
            </a>
          </div>
        </nav><!-- END Primary Nav -->
      </div>
    </header><!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-TJ45R6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TJ45R6');
    </script> <!-- End Google Tag Manager -->

	<div class="page-content">
		<section id="blog-index" class="main-container">
    <div class="wrap blog"><section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2017/04/26/bootiful-development-with-spring-boot-and-angular">Bootiful Development with Spring Boot and Angular</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-matt_raible.jpg"
	           alt="avatar-matt_raible.jpg"
	           class="author-avatar">
	      <address>Matt Raible</address>
	      &nbsp;
		  <a class="social_link" href="https://github.com/mraible"><i class="fa fa-github-square"></i></a>
		  <a class="social_link" href="https://twitter.com/mraible"><i class="fa fa-twitter-square"></i></a>
		  <a class="social_link" href="http://raibledesigns.com"><i class="fa fa-external-link-square"></i></a>
		  <span class="sepr">&middot;</span>
	      <time datetime="2017-04-26">April 26, 2017</time>
	    </div>
	  </header>
	  <section class="post-content">
	    <p>To simplify development and deployment, you want everything in the same artifact, so you put your Angular app “inside” your Spring Boot app, right? But what if you could create your Angular app as a standalone app and make cross-origin requests to your API? Hey guess what, you can do both!</p>

<p>I believe that most frontend developers are used to having their apps standalone and making cross-origin requests to APIs. The beauty of having a client app that can point to a server app is you can point it to <em>any</em> server and it makes it easy to test your current client code against other servers (e.g. test, staging, production).</p>

<p>This post shows how you can have the best of both worlds where the UI and the API are separate apps. You’ll learn how to create REST endpoints with Spring Data REST, configure Spring Boot to allow CORS, and create an Angular app to display its data. This app will display a list of beers from the API, then fetch a GIF from <a href="http://giphy.com">https://giphy.com/</a> that matches the beer’s name.</p>

<p>If you don’t want to code along, feel free to grab the <a href="https://github.com/oktadeveloper/spring-boot-angular-example">source code from GitHub</a>! You can also watch a video of this tutorial below.</p>

<div style="text-align: center">
<iframe width="560" height="315" style="max-width: 100%" src="https://www.youtube.com/embed/bUq83Rz4BHA" frameborder="0" allowfullscreen=""></iframe>
</div>

<h2 id="build-an-api-with-spring-boot">Build an API with Spring Boot</h2>

<p>To get started with Spring Boot, navigate to <a href="https://start.spring.io">start.spring.io</a>. In the “Search for dependencies” field, select the following:</p>

<ul>
  <li><a href="http://docs.spring.io/spring-boot/docs/current/reference/html/using-boot-devtools.html">DevTools</a>: Provides auto-reloading of your application when files change</li>
  <li><a href="http://www.h2database.com/html/main.html">H2</a>: An in-memory database</li>
  <li><a href="http://www.oracle.com/technetwork/java/javaee/tech/persistence-jsp-140049.html">JPA</a>: Standard ORM for Java</li>
  <li><a href="http://projects.spring.io/spring-data-rest/">Rest Repositories</a>: Allows you to expose your JPA repositories as REST endpoints</li>
  <li><a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-starters/spring-boot-starter-web/pom.xml">Web</a>: Spring MVC with Jackson (for JSON), Hibernate Validator, and embedded Tomcat</li>
</ul>

<p><img alt="start.spring.io" src="/assets/img/blog/angular-spring-boot/start.spring.png" style="width: 800px" /></p>

<p>If you like the command-line better, you can use the following command to download a <code class="highlighter-rouge">demo.zip</code> file with <a href="https://httpie.org/">HTTPie</a>.</p>

<pre>
http https://start.spring.io/starter.zip \
dependencies==devtools,h2,data-jpa,data-rest,web -d
</pre>

<p>Create a directory called <code class="highlighter-rouge">spring-boot-angular-example</code>, with a <code class="highlighter-rouge">server</code> directory inside it. Expand the contents of <code class="highlighter-rouge">demo.zip</code> into the <code class="highlighter-rouge">server</code> directory.</p>

<p>Open the “server” project in your favorite IDE and run <code class="highlighter-rouge">DemoApplication</code> or start it from the command line using <code class="highlighter-rouge">./mvnw spring-boot:run</code>.</p>

<p>Create a <code class="highlighter-rouge">com.example.beer</code> package and a <code class="highlighter-rouge">Beer.java</code> file in it. This will be the entity that holds your data.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">beer</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.Entity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.GeneratedValue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.Id</span><span class="o">;</span>

<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Beer</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Beer</span><span class="o">()</span> <span class="o">{}</span>

    <span class="kd">public</span> <span class="nf">Beer</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Long</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="n">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"Beer{"</span> <span class="o">+</span>
                <span class="s">"id="</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span>
                <span class="s">", name='"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
                <span class="sc">'}'</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Add a <code class="highlighter-rouge">BeerRepository</code> class that leverages Spring Data to do CRUD on this entity.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">beer</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>

<span class="kd">interface</span> <span class="nc">BeerRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Beer</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Add a <code class="highlighter-rouge">BeerCommandLineRunner</code> that uses this repository and creates a default set of data.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">beer</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.CommandLineRunner</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.stream.Stream</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeerCommandLineRunner</span> <span class="kd">implements</span> <span class="n">CommandLineRunner</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">BeerRepository</span> <span class="n">repository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">BeerCommandLineRunner</span><span class="o">(</span><span class="n">BeerRepository</span> <span class="n">repository</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">repository</span> <span class="o">=</span> <span class="n">repository</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">strings</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// Top beers from https://www.beeradvocate.com/lists/top/</span>
        <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"Kentucky Brunch Brand Stout"</span><span class="o">,</span> <span class="s">"Good Morning"</span><span class="o">,</span> <span class="s">"Very Hazy"</span><span class="o">,</span> <span class="s">"King Julius"</span><span class="o">,</span> 
                <span class="s">"Budweiser"</span><span class="o">,</span> <span class="s">"Coors Light"</span><span class="o">,</span> <span class="s">"PBR"</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="n">name</span> <span class="o">-&gt;</span>
                <span class="n">repository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="n">Beer</span><span class="o">(</span><span class="n">name</span><span class="o">))</span>
        <span class="o">);</span>
        <span class="n">repository</span><span class="o">.</span><span class="na">findAll</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Rebuild your project and you should see a list of beers printed in your terminal.</p>

<p><img alt="Beers printed in terminal" src="/assets/img/blog/angular-spring-boot/beers-in-terminal.png" style="width: 800px" /></p>

<p>Add a <a href="http://docs.spring.io/spring-data/rest/docs/current/api/org/springframework/data/rest/core/annotation/RepositoryRestResource.html"><code class="highlighter-rouge">@RepositoryRestResource</code></a> annotation to <code class="highlighter-rouge">BeerRepository</code> to expose all its CRUD operations as REST endpoints.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.data.rest.core.annotation.RepositoryRestResource</span><span class="o">;</span>

<span class="nd">@RepositoryRestResource</span>
<span class="kd">interface</span> <span class="nc">BeerRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Beer</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Add a <code class="highlighter-rouge">BeerController</code> class to create an endpoint that filters out less-than-great beers.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">beer</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Collectors</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeerController</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">BeerRepository</span> <span class="n">repository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">BeerController</span><span class="o">(</span><span class="n">BeerRepository</span> <span class="n">repository</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">repository</span> <span class="o">=</span> <span class="n">repository</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/good-beers"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="nf">goodBeers</span><span class="o">()</span> <span class="o">{</span>

        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">findAll</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">isGreat</span><span class="o">)</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
                    <span class="n">m</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="n">b</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
                    <span class="n">m</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="n">b</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
                    <span class="k">return</span> <span class="n">m</span><span class="o">;</span>
                <span class="o">}).</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isGreat</span><span class="o">(</span><span class="n">Beer</span> <span class="n">beer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="n">beer</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"Budweiser"</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="n">beer</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"Coors Light"</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="n">beer</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"PBR"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Re-build your application and navigate to http://localhost:8080/good-beers. You should see the list of good beers in your browser.</p>

<p><img alt="Good Beers JSON" src="/assets/img/blog/angular-spring-boot/good-beers-json.png" style="width: 800px" /></p>

<p>You should also see this same result in your terminal window when using HTTPie.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>http localhost:8080/good-beers
</code></pre>
</div>

<h2 id="create-a-project-with-angular-cli">Create a Project with Angular CLI</h2>

<p>It’s cool that you created an API to display a list of beers, but APIs aren’t <em>that</em> cool without a UI. In this section, you’ll create a new Angular app, build services to fetch beers/images, and create components to display this data.</p>

<p>To create an Angular project, make sure you have <a href="https://nodejs.org/">Node.js</a> and the latest <a href="https://github.com/angular/angular-cli#updating-angular-cli">Angular CLI installed</a>.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>npm install -g @angular/cli@latest
</code></pre>
</div>

<p>Run <code class="highlighter-rouge">ng --version</code> to confirm you’re using version 1.0.0 (or later). From a terminal window, cd into the root of the <code class="highlighter-rouge">spring-boot-angular-example</code> directory and run the following command.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>ng new client
</code></pre>
</div>

<p>This will create a new <code class="highlighter-rouge">client</code> directory and run <code class="highlighter-rouge">npm install</code> to install all the necessary dependencies. To verify everything works, run <code class="highlighter-rouge">ng e2e</code> in a terminal window. If everything works, you should see output like the following in your terminal.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="o">[</span>09:02:35] I/direct - Using ChromeDriver directly...
<span class="o">[</span>09:02:35] I/launcher - Running 1 instances of WebDriver
Spec started

  client App
    ✓ should display message saying app works

Executed 1 of 1 spec SUCCESS <span class="k">in </span>0.77 sec.
<span class="o">[</span>09:02:38] I/launcher - 0 instance<span class="o">(</span>s<span class="o">)</span> of WebDriver still running
<span class="o">[</span>09:02:38] I/launcher - chrome <span class="c">#01 passed</span>
</code></pre>
</div>

<p><strong>TIP:</strong> If you’re just getting started with Angular, you might want to <a href="https://www.youtube.com/watch?v=Jq3szz2KOOs">watch this video of my recent Getting Started with Angular webinar</a>.</p>

<p>If you’d rather not use the command line and have <a href="https://www.jetbrains.com/idea/">IntelliJ IDEA</a> (or <a href="https://www.jetbrains.com/webstorm/">WebStorm</a>) installed, you can create a new Static Web Project and select Angular CLI.</p>

<p><img alt="IntelliJ new Static Web project" src="/assets/img/blog/angular-spring-boot/intellij-new-static-web-project.png" style="width: 800px" /></p>

<h3 id="create-a-beerlistcomponent-and-beerservice">Create a BeerListComponent and BeerService</h3>

<p>Thus far, you’ve created a <code class="highlighter-rouge">good-beers</code> API and an Angular app, but you haven’t created the UI to display the list of beers from your API. To do this, create a <code class="highlighter-rouge">&lt;beer-list&gt;</code> component by running Angular CLI’s <code class="highlighter-rouge">generate component</code> command.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>ng generate component beer-list
installing component
  create src/app/beer-list/beer-list.component.css
  create src/app/beer-list/beer-list.component.html
  create src/app/beer-list/beer-list.component.spec.ts
  create src/app/beer-list/beer-list.component.ts
  update src/app/app.module.ts
</code></pre>
</div>

<p><strong>TIP:</strong> There is a <code class="highlighter-rouge">g</code> alias for <code class="highlighter-rouge">generate</code> and a <code class="highlighter-rouge">c</code> alias for <code class="highlighter-rouge">component</code>, so you can type <code class="highlighter-rouge">ng g c beer-list</code> too.</p>

<p>Create a <code class="highlighter-rouge">beer</code> service:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>ng g s beer
installing service
  create src/app/beer.service.spec.ts
  create src/app/beer.service.ts
  WARNING Service is generated but not provided, it must be provided to be used
</code></pre>
</div>

<p>Create a <code class="highlighter-rouge">src/app/shared/beer</code> directory and move <code class="highlighter-rouge">beer.service.*</code> into it.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>mkdir -p src/app/shared/beer
mv src/app/beer.service.<span class="k">*</span> src/app/shared/beer/.
</code></pre>
</div>

<p>Create a <code class="highlighter-rouge">src/app/shared/index.ts</code> file and export the <code class="highlighter-rouge">BeerService</code>. The reason for this file is so you can export multiple classes and import them in one line rather than multiple.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">export</span> <span class="o">*</span> <span class="k">from</span> <span class="s1">'./beer/beer.service'</span><span class="p">;</span>
</code></pre>
</div>

<p>Modify <code class="highlighter-rouge">beer.service.ts</code> to call the “good-beers” API service.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Http</span><span class="p">,</span> <span class="nx">Response</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/http'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">BeerService</span> <span class="p">{</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">http</span><span class="err">:</span> <span class="nx">Http</span><span class="p">)</span> <span class="p">{}</span>

  <span class="nx">getAll</span><span class="p">()</span><span class="err">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'http://localhost:8080/good-beers'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="na">response</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Modify <code class="highlighter-rouge">beer-list.component.ts</code> to use the <code class="highlighter-rouge">BeerService</code> and store the results in a local variable. Notice that you need to add the service as a provider in the <code class="highlighter-rouge">@Component</code> definition or you will see an error.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">BeerService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../shared'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-beer-list'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./beer-list.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./beer-list.component.css'</span><span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">BeerService</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">BeerListComponent</span> <span class="k">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>
  <span class="nl">beers</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">beerService</span><span class="err">:</span> <span class="nx">BeerService</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">beerService</span><span class="p">.</span><span class="nx">getAll</span><span class="p">().</span><span class="nx">subscribe</span><span class="p">(</span>
      <span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">beers</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
      <span class="p">},</span>
      <span class="nx">error</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Modify <code class="highlighter-rouge">beer-list.component.html</code> so it renders the list of beers.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;h2&gt;</span>Beer List<span class="nt">&lt;/h2&gt;</span>

<span class="nt">&lt;div</span> <span class="err">*</span><span class="na">ngFor=</span><span class="s">"let b of beers"</span><span class="nt">&gt;</span>
  {{b.name}}
<span class="nt">&lt;/div&gt;</span>
</code></pre>
</div>

<p>Update <code class="highlighter-rouge">app.component.html</code> to have the <code class="highlighter-rouge">BeerListComponent</code> rendered when you’re logged in.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;app-beer-list&gt;&lt;/app-beer-list&gt;</span>
</code></pre>
</div>

<p>Make sure both apps are started (with <code class="highlighter-rouge">mvn spring-boot:run</code> in the server directory, and <code class="highlighter-rouge">ng serve</code> in the client directory) and navigate to <a href="http://localhost:4200">http://localhost:4200</a>. You should see an error in your console that you means you have to configure cross-origin resource sharing (CORS) on the server.</p>

<pre style="color: red">
XMLHttpRequest cannot load http://localhost:8080/good-beers. No 'Access-Control-Allow-Origin' header 
is present on the requested resource. Origin 'http://localhost:4200' is therefore not allowed access.
</pre>

<p>To fix this issue, you’ll need to configure Spring Boot to allow cross-domain access from <code class="highlighter-rouge">http://localhost:4200</code>.</p>

<h3 id="configure-cors-for-spring-boot">Configure CORS for Spring Boot</h3>

<p>In the server project, open <code class="highlighter-rouge">BeerController.java</code> and add a <code class="highlighter-rouge">@CrossOrigin</code> annotation to enable cross-origin resource sharing (CORS) from the client (http://localhost:4200).</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.CrossOrigin</span><span class="o">;</span>
<span class="o">...</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/good-beers"</span><span class="o">)</span>
    <span class="nd">@CrossOrigin</span><span class="o">(</span><span class="n">origins</span> <span class="o">=</span> <span class="s">"http://localhost:4200"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="nf">goodBeers</span><span class="o">()</span> <span class="o">{</span>
</code></pre>
</div>

<p>After making these changes, you should be able to see a list of beers from your Spring Boot API.</p>

<p><img alt="Beer List in Angular" src="/assets/img/blog/angular-spring-boot/angular-beer-list.png" style="width: 800px" /></p>

<p>To make it look a little better, add a <a href="http://giphy.com">Giphy</a> service to fetch images based on the beer’s name. Create <code class="highlighter-rouge">src/app/shared/giphy/giphy.service.ts</code> and place the following code inside it.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Http</span><span class="p">,</span> <span class="nx">Response</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/http'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Injectable</span><span class="p">()</span>
<span class="c1">// http://tutorials.pluralsight.com/front-end-javascript/getting-started-with-angular-2-by-building-a-giphy-search-application</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">GiphyService</span> <span class="p">{</span>


  <span class="c1">// Public beta key: https://github.com/Giphy/GiphyAPI#public-beta-key</span>
  <span class="nx">giphyApi</span> <span class="o">=</span> <span class="s1">'//api.giphy.com/v1/gifs/search?api_key=dc6zaTOxFJmzC&amp;q='</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">public</span> <span class="nx">http</span><span class="err">:</span> <span class="nx">Http</span><span class="p">)</span> <span class="p">{}</span>

  <span class="nx">get</span><span class="p">(</span><span class="nx">searchTerm</span><span class="p">)</span><span class="err">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">apiLink</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">giphyApi</span> <span class="o">+</span> <span class="nx">searchTerm</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">apiLink</span><span class="p">).</span><span class="nx">map</span><span class="p">((</span><span class="na">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">giphies</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="nx">data</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">giphies</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">images</span><span class="p">.</span><span class="nx">original</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Add an export for this class in <code class="highlighter-rouge">src/app/shared/index.ts</code>.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">export</span> <span class="o">*</span> <span class="k">from</span> <span class="s1">'./beer/beer.service'</span><span class="p">;</span>
<span class="k">export</span> <span class="o">*</span> <span class="k">from</span> <span class="s1">'./giphy/giphy.service'</span><span class="p">;</span>
</code></pre>
</div>

<p>Then add it to <code class="highlighter-rouge">BeerListComponent</code> to set a <code class="highlighter-rouge">giphyUrl</code> on each <code class="highlighter-rouge">beer</code> object.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">BeerService</span><span class="p">,</span> <span class="nx">GiphyService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../shared'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-beer-list'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./beer-list.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./beer-list.component.css'</span><span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">BeerService</span><span class="p">,</span> <span class="nx">GiphyService</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">BeerListComponent</span> <span class="k">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>
  <span class="nl">beers</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">beerService</span><span class="err">:</span> <span class="nx">BeerService</span><span class="p">,</span>
              <span class="k">private</span> <span class="nx">giphyService</span><span class="err">:</span> <span class="nx">GiphyService</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">beerService</span><span class="p">.</span><span class="nx">getAll</span><span class="p">().</span><span class="nx">subscribe</span><span class="p">(</span>
      <span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">beers</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">beer</span> <span class="nx">of</span> <span class="k">this</span><span class="p">.</span><span class="nx">beers</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">giphyService</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">beer</span><span class="p">.</span><span class="nx">name</span><span class="p">).</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">url</span> <span class="o">=&gt;</span> <span class="nx">beer</span><span class="p">.</span><span class="nx">giphyUrl</span> <span class="o">=</span> <span class="nx">url</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">error</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Then update <code class="highlighter-rouge">beer-list.component.html</code> to include a reference to this image.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="err">*</span><span class="na">ngFor=</span><span class="s">"let b of beers"</span><span class="nt">&gt;</span>
  {{b.name}}<span class="nt">&lt;br&gt;</span>
  <span class="nt">&lt;img</span> <span class="na">width=</span><span class="s">"200"</span> <span class="na">src=</span><span class="s">"{{b.giphyUrl}}"</span> <span class="na">alt=</span><span class="s">"{{b.name}}"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>
</div>

<p>The result should look something like the following list of beer names with images.</p>

<p><img alt="Beer list with Giphy images" src="/assets/img/blog/angular-spring-boot/angular-beer-list-giphy.png" style="width: 800px" /></p>

<p>You’ve just created an Angular app that talks to a Spring Boot API using cross-domain requests. Congratulations!</p>

<h2 id="learn-more-about-spring-boot-and-angular">Learn More About Spring Boot and Angular</h2>

<p>To learn more about Angular, Spring Boot, or Okta, check out the following resources:</p>

<ul>
  <li><a href="http://developer.okta.com/blog/2017/04/17/angular-authentication-with-oidc">Angular with OpenID Connect</a></li>
  <li><a href="http://developer.okta.com/blog/2017/03/21/spring-boot-oauth">Get Started with Spring Boot, OAuth 2.0, and Okta</a></li>
  <li><a href="https://youtu.be/sbPSjI4tt10">Getting Started with Spring Boot by Josh Long</a> (SF JUG 2015)</li>
  <li><a href="https://youtu.be/hHNUohOPCCo">Angular Best Practices by Stephen Fluin</a> (ng-conf 2017)</li>
</ul>

<p>You can find the source code associated with this article <a href="https://github.com/oktadeveloper/spring-boot-angular-example">on GitHub</a>. If you find any bugs, please file an issue on GitHub, or ask your question on Stack Overflow with an <a href="http://stackoverflow.com/questions/tagged/okta">okta tag</a>. Of course, you can always <a href="https://twitter.com/mraible">ping me on Twitter</a> too.</p>

	  </section>
	</article>
</div>
</section>
<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2017/04/17/angular-authentication-with-oidc">Angular Authentication with OpenID Connect and Okta in 20 Minutes</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-matt_raible.jpg"
	           alt="avatar-matt_raible.jpg"
	           class="author-avatar">
	      <address>Matt Raible</address>
	      &nbsp;
		  <a class="social_link" href="https://github.com/mraible"><i class="fa fa-github-square"></i></a>
		  <a class="social_link" href="https://twitter.com/mraible"><i class="fa fa-twitter-square"></i></a>
		  <a class="social_link" href="http://raibledesigns.com"><i class="fa fa-external-link-square"></i></a>
		  <span class="sepr">&middot;</span>
	      <time datetime="2017-04-17">April 17, 2017</time>
	    </div>
	  </header>
	  <section class="post-content">
	    <p>Angular (formerly called Angular 2.0) is quickly becoming one of the most powerful ways to build a modern single-page app. A core strength is Angular’s focus on building reusable components, which help you decouple the various concerns in your application. Take authentication, for example: it can be painful to build, but once you wrap it in a component, the authentication logic can be reused throughout your application.</p>

<p>The Angular CLI makes it easy to scaffold new components, and even entire project. If you haven’t used the Angular CLI to quickly generate Angular code, you’re in for a treat!</p>

<p>In this example, you’ll build a simple web application with Angular CLI, a tool for Angular development. You’ll create an application with search and edit features, then add authentication.</p>

<h2 id="create-an-angular-application">Create an Angular Application</h2>

<p><em>TIP: If you’d like to skip building the Angular application and get right to adding authentication, you can clone my <code class="highlighter-rouge">ng-demo</code> project, then skip to the <a href="#create-open-id-connect-app">Create an OpenID Connect App in Okta</a> section.</em></p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>git clone https://github.com/mraible/ng-demo.git
</code></pre>
</div>

<h3 id="what-youll-need">What You’ll Need</h3>

<ul>
  <li>About 20 minutes</li>
  <li>A favorite text editor or IDE. I recommend <a href="https://www.jetbrains.com/idea/">IntelliJ IDEA</a></li>
  <li><a href="https://nodejs.org">Node.js</a> and npm installed. I recommend using <a href="https://github.com/creationix/nvm">nvm</a></li>
  <li><a href="https://cli.angular.io/">Angular CLI</a> installed. If you don’t have Angular CLI installed, install it using <code class="highlighter-rouge">npm install -g @angular/cli</code></li>
</ul>

<p>Create a new project using the <code class="highlighter-rouge">ng new</code> command:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>ng new ng-demo
</code></pre>
</div>

<p>This will create a <code class="highlighter-rouge">ng-demo</code> project and run <code class="highlighter-rouge">npm install</code> in it. It should take about a minute to complete, but that could vary depending on your connection speed.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="o">[</span>mraible:~/dev] <span class="nv">$ </span>ng new ng-demo
installing ng
  create .editorconfig
  create README.md
  create src/app/app.component.css
  create src/app/app.component.html
  create src/app/app.component.spec.ts
  create src/app/app.component.ts
  create src/app/app.module.ts
  create src/assets/.gitkeep
  create src/environments/environment.prod.ts
  create src/environments/environment.ts
  create src/favicon.ico
  create src/index.html
  create src/main.ts
  create src/polyfills.ts
  create src/styles.css
  create src/test.ts
  create src/tsconfig.app.json
  create src/tsconfig.spec.json
  create src/typings.d.ts
  create .angular-cli.json
  create e2e/app.e2e-spec.ts
  create e2e/app.po.ts
  create e2e/tsconfig.e2e.json
  create .gitignore
  create karma.conf.js
  create package.json
  create protractor.conf.js
  create tsconfig.json
  create tslint.json
Successfully initialized git.
Installing packages <span class="k">for </span>tooling via npm.
Installed packages <span class="k">for </span>tooling via npm.
You can <span class="sb">`</span>ng <span class="nb">set</span> --global <span class="nv">packageManager</span><span class="o">=</span>yarn<span class="sb">`</span>.
Project <span class="s1">'ng-demo'</span> successfully created.
<span class="o">[</span>mraible:~] 46s <span class="err">$</span>
</code></pre>
</div>

<p>You can see the what version of Angular CLI you’re using with <code class="highlighter-rouge">ng --version</code>.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>ng --version
    _                      _                 ____ _     ___
   / <span class="se">\ </span>  _ __   __ _ _   _| | __ _ _ __     / ___| |   |_ _|
  / △ <span class="se">\ </span>| <span class="s1">'_ \ / _` | | | | |/ _` | '</span>__|   | |   | |    | |
 / ___ <span class="se">\|</span> | | | <span class="o">(</span>_| | |_| | | <span class="o">(</span>_| | |      | |___| |___ | |
/_/   <span class="se">\_\_</span>| |_|<span class="se">\_</span>_, |<span class="se">\_</span>_,_|_|<span class="se">\_</span>_,_|_|       <span class="se">\_</span>___|_____|___|
               |___/
@angular/cli: 1.0.0
node: 6.9.5
os: darwin x64
</code></pre>
</div>

<h2 id="run-your-angular-application">Run Your Angular Application</h2>

<p>The project is configured with <a href="https://webpack.github.io/docs/webpack-dev-server.html">webpack dev server</a>. To start it, make sure you’re in the <code class="highlighter-rouge">ng-demo</code> directory, then run:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>ng serve
</code></pre>
</div>

<p>You should see a screen like the one below at <a href="http://localhost:4200">http://localhost:4200</a>.</p>

<p><img alt="Default Homepage" src="/assets/img/blog/angular-oidc/default-homepage.png" style="width: 800px" /></p>

<p>You can make sure your new project’s tests pass, run <code class="highlighter-rouge">ng test</code>:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>ng <span class="nb">test</span>
...
Chrome 56.0.2924 <span class="o">(</span>Mac OS X 10.12.2<span class="o">)</span>: Executed 3 of 3 SUCCESS <span class="o">(</span>0.377 secs / 0.341 secs<span class="o">)</span>
</code></pre>
</div>

<h2 id="add-a-search-feature">Add a Search Feature</h2>

<p>To add a search feature, open the project in an IDE or your favorite text editor. For IntelliJ IDEA, use File &gt; New Project &gt; Static Web and point to the <code class="highlighter-rouge">ng-demo</code> directory.</p>

<p>In a terminal window, cd into your project’s directory and run the following command. This will create a search component.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>ng g component search
installing component
  create src/app/search/search.component.css
  create src/app/search/search.component.html
  create src/app/search/search.component.spec.ts
  create src/app/search/search.component.ts
  update src/app/app.module.ts
</code></pre>
</div>

<p>Open <code class="highlighter-rouge">src/app/search/search.component.html</code> and replace its default HTML with the following:</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;h2&gt;</span>Search<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;form&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"search"</span> <span class="na">name=</span><span class="s">"query"</span> <span class="err">[(</span><span class="na">ngModel</span><span class="err">)]="</span><span class="na">query</span><span class="err">"</span> <span class="err">(</span><span class="na">keyup</span><span class="err">.</span><span class="na">enter</span><span class="err">)="</span><span class="na">search</span><span class="err">()"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="err">(</span><span class="na">click</span><span class="err">)="</span><span class="na">search</span><span class="err">()"</span><span class="nt">&gt;</span>Search<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;pre&gt;</span>{{searchResults | json}}<span class="nt">&lt;/pre&gt;</span>
</code></pre>
</div>

<p>The <a href="https://angular.io/docs/ts/latest/guide/router.html">Router documentation</a> for Angular provides the information you need to setup a route to the <code class="highlighter-rouge">SearchComponent</code> you just generated. Here’s a quick summary:</p>

<p>In <code class="highlighter-rouge">src/app/app.module.ts</code>, add an <code class="highlighter-rouge">appRoutes</code> constant and import it in <code class="highlighter-rouge">@NgModule</code>:</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Routes</span><span class="p">,</span> <span class="nx">RouterModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">appRoutes</span><span class="err">:</span> <span class="nx">Routes</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'search'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">SearchComponent</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="na">redirectTo</span><span class="p">:</span> <span class="s1">'/search'</span><span class="p">,</span> <span class="na">pathMatch</span><span class="p">:</span> <span class="s1">'full'</span> <span class="p">}</span>
<span class="p">];</span>

<span class="err">@</span><span class="nx">NgModule</span><span class="p">({</span>
  <span class="p">...</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">...</span>
    <span class="nx">RouterModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">(</span><span class="nx">appRoutes</span><span class="p">)</span>
  <span class="p">]</span>
  <span class="p">...</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">AppModule</span> <span class="p">{</span> <span class="p">}</span>
</code></pre>
</div>

<p>In <code class="highlighter-rouge">src/app/app.component.html</code>, add a <code class="highlighter-rouge">RouterOutlet</code> to display routes.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;router-outlet&gt;&lt;/router-outlet&gt;</span>
</code></pre>
</div>

<p>Now that you have routing setup, you can continue writing the search feature.</p>

<p>If you still have <code class="highlighter-rouge">ng serve</code> running, your browser should refresh automatically. If not, navigate to <a href="http://localhost:4200">http://localhost:4200</a>, and you should see the search form.</p>

<p><img alt="Search component" src="/assets/img/blog/angular-oidc/search-without-css.png" style="width: 800px" /></p>

<p>If you want to add CSS for this components, open <code class="highlighter-rouge">src/app/search/search.component.css</code> and add some CSS. For example:</p>

<div class="language-css highlighter-rouge"><pre class="highlight"><code><span class="nd">:host</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">0</span> <span class="m">20px</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>This section has shown you how to generate a new component to a basic Angular application with Angular CLI. The next section will show you how to create a use a JSON file and <code class="highlighter-rouge">localStorage</code> to create a fake API.</p>

<p>To get search results, create a <code class="highlighter-rouge">SearchService</code> that makes HTTP requests to a JSON file. Start by generating a new service.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>ng g service search
installing service
  create src/app/search.service.spec.ts
  create src/app/search.service.ts
  WARNING Service is generated but not provided, it must be provided to be used
</code></pre>
</div>

<p>Move the generated <code class="highlighter-rouge">search.service.ts</code> and its test to <code class="highlighter-rouge">app/shared/search</code>. You’ll need to create this directory. Create <code class="highlighter-rouge">src/assets/data/people.json</code> to hold your data.</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Peyton Manning"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"phone"</span><span class="p">:</span><span class="w"> </span><span class="s2">"(303) 567-8910"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"address"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"street"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1234 Main Street"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Greenwood Village"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CO"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"zip"</span><span class="p">:</span><span class="w"> </span><span class="s2">"80111"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Demaryius Thomas"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"phone"</span><span class="p">:</span><span class="w"> </span><span class="s2">"(720) 213-9876"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"address"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"street"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5555 Marion Street"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Denver"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CO"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"zip"</span><span class="p">:</span><span class="w"> </span><span class="s2">"80202"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Von Miller"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"phone"</span><span class="p">:</span><span class="w"> </span><span class="s2">"(917) 323-2333"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"address"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"street"</span><span class="p">:</span><span class="w"> </span><span class="s2">"14 Mountain Way"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Vail"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CO"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"zip"</span><span class="p">:</span><span class="w"> </span><span class="s2">"81657"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre>
</div>

<p>Modify <code class="highlighter-rouge">src/app/shared/search/search.service.ts</code> and provide <code class="highlighter-rouge">Http</code> as a dependency in its constructor. In this same file, create a <code class="highlighter-rouge">getAll()</code> method to gather all the people. Also, define the <code class="highlighter-rouge">Address</code> and <code class="highlighter-rouge">Person</code> classes that JSON will be marshalled to.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Http</span><span class="p">,</span> <span class="nx">Response</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/http'</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">'rxjs/add/operator/map'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">SearchService</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">http</span><span class="err">:</span> <span class="nx">Http</span><span class="p">)</span> <span class="p">{}</span>

  <span class="nx">getAll</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'assets/data/people.json'</span><span class="p">).</span><span class="nx">map</span><span class="p">((</span><span class="nx">res</span><span class="err">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kr">class</span> <span class="nx">Address</span> <span class="p">{</span>
  <span class="nl">street</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">city</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">state</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">zip</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="nx">obj</span><span class="p">?:</span> <span class="kr">any</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">street</span> <span class="o">=</span> <span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">street</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">city</span> <span class="o">=</span> <span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">city</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">state</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">zip</span> <span class="o">=</span> <span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">zip</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kr">class</span> <span class="nx">Person</span> <span class="p">{</span>
  <span class="nl">id</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
  <span class="nl">name</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">phone</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">address</span><span class="p">:</span> <span class="nx">Address</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="nx">obj</span><span class="p">?:</span> <span class="kr">any</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">phone</span> <span class="o">=</span> <span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">phone</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">address</span> <span class="o">=</span> <span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">address</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>To make these classes available for consumption by your components, edit <code class="highlighter-rouge">src/app/shared/index.ts</code> and add the following:</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">export</span> <span class="o">*</span> <span class="k">from</span> <span class="s1">'./search/search.service'</span><span class="p">;</span>
</code></pre>
</div>

<p>The reason for creating this file is so you can import multiple classes on a single line rather than having to import each individual class on separate lines.</p>

<p>In <code class="highlighter-rouge">search.component.ts</code>, add imports for these classes.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Person</span><span class="p">,</span> <span class="nx">SearchService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../shared'</span><span class="p">;</span>
</code></pre>
</div>

<p>You can now add <code class="highlighter-rouge">query</code> and <code class="highlighter-rouge">searchResults</code> variables. While you’re there, modify the constructor to inject the <code class="highlighter-rouge">SearchService</code>.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">export</span> <span class="kr">class</span> <span class="nx">SearchComponent</span> <span class="k">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>
  <span class="nl">query</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">searchResults</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">Person</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">searchService</span><span class="err">:</span> <span class="nx">SearchService</span><span class="p">)</span> <span class="p">{}</span>
</code></pre>
</div>

<p>Then implement a <code class="highlighter-rouge">search()</code> method to call the service’s <code class="highlighter-rouge">getAll()</code> method.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="nx">search</span><span class="p">()</span><span class="err">:</span> <span class="k">void</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">searchService</span><span class="p">.</span><span class="nx">getAll</span><span class="p">().</span><span class="nx">subscribe</span><span class="p">(</span>
    <span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">searchResults</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">error</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>At this point, you’ll likely see the following message in your browser’s console.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>ORIGINAL EXCEPTION: No provider for SearchService!
</code></pre>
</div>

<p>To fix the “No provider” error from above, update <code class="highlighter-rouge">app.component.ts</code> to import the <code class="highlighter-rouge">SearchService</code>
and add the service to the list of providers.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">SearchService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./shared'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Component</span><span class="p">({</span>
  <span class="p">...</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./app.component.css'</span><span class="p">],</span>
  <span class="na">viewProviders</span><span class="p">:</span> <span class="p">[</span><span class="nx">SearchService</span><span class="p">]</span>
<span class="p">})</span>
</code></pre>
</div>

<p>Now clicking the search button should work. To make the results look better, remove the <code class="highlighter-rouge">&lt;pre&gt;</code> tag and replace it with a <code class="highlighter-rouge">&lt;table&gt;</code> in <code class="highlighter-rouge">src/app/search/search.component.html</code>.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;table</span> <span class="err">*</span><span class="na">ngIf=</span><span class="s">"searchResults"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;thead&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;th&gt;</span>Name<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;</span>Phone<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;</span>Address<span class="nt">&lt;/th&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/thead&gt;</span>
  <span class="nt">&lt;tbody&gt;</span>
  <span class="nt">&lt;tr</span> <span class="err">*</span><span class="na">ngFor=</span><span class="s">"let person of searchResults; let i=index"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{person.name}}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{person.phone}}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{person.address.street}}<span class="nt">&lt;br/&gt;</span>
      {{person.address.city}}, {{person.address.state}} {{person.address.zip}}
    <span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/tbody&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</code></pre>
</div>

<p>Then add some additional CSS in <code class="highlighter-rouge">src/app/search/search.component.css</code> to improve its table layout.</p>

<div class="language-css highlighter-rouge"><pre class="highlight"><code><span class="nt">table</span> <span class="p">{</span>
  <span class="nl">margin-top</span><span class="p">:</span> <span class="m">10px</span><span class="p">;</span>
  <span class="nl">border-collapse</span><span class="p">:</span> <span class="nb">collapse</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">th</span> <span class="p">{</span>
  <span class="nl">text-align</span><span class="p">:</span> <span class="nb">left</span><span class="p">;</span>
  <span class="nl">border-bottom</span><span class="p">:</span> <span class="m">2px</span> <span class="nb">solid</span> <span class="m">#ddd</span><span class="p">;</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">8px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">td</span> <span class="p">{</span>
  <span class="nl">border-top</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="m">#ddd</span><span class="p">;</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">8px</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now the search results look better.</p>

<p><img alt="Search Results" src="/assets/img/blog/angular-oidc/search-results.png" style="width: 800px" /></p>

<p>But wait, you still don’t have search functionality! To add a search feature, add a <code class="highlighter-rouge">search()</code> method to <code class="highlighter-rouge">SearchService</code>.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs'</span><span class="p">;</span>

<span class="nx">search</span><span class="p">(</span><span class="nx">q</span><span class="err">:</span> <span class="kr">string</span><span class="p">)</span><span class="err">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">q</span> <span class="o">||</span> <span class="nx">q</span> <span class="o">===</span> <span class="s1">'*'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">q</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">q</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getAll</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="nx">q</span><span class="p">)));</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Then refactor <code class="highlighter-rouge">SearchComponent</code> to call this method with its <code class="highlighter-rouge">query</code> variable.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="nx">search</span><span class="p">()</span><span class="err">:</span> <span class="k">void</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">searchService</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">).</span><span class="nx">subscribe</span><span class="p">(</span>
    <span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">searchResults</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">error</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now search results will be filtered by the query value you type in.</p>

<p>This section showed you how to fetch and display search results. The next section builds on this and shows how to edit and save a record.</p>

<h2 id="add-an-edit-feature">Add an Edit Feature</h2>

<p>Modify <code class="highlighter-rouge">search.component.html</code> to add a link for editing a person.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;td&gt;&lt;a</span> <span class="err">[</span><span class="na">routerLink</span><span class="err">]="['/</span><span class="na">edit</span><span class="err">',</span> <span class="na">person</span><span class="err">.</span><span class="na">id</span><span class="err">]"</span><span class="nt">&gt;</span>{{person.name}}<span class="nt">&lt;/a&gt;&lt;/td&gt;</span>
</code></pre>
</div>

<p>Run the following command to generate an <code class="highlighter-rouge">EditComponent</code>.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>ng g component edit
installing component
  create src/app/edit/edit.component.css
  create src/app/edit/edit.component.html
  create src/app/edit/edit.component.spec.ts
  create src/app/edit/edit.component.ts
  update src/app/app.module.ts
</code></pre>
</div>

<p>Add a route for this component in <code class="highlighter-rouge">app.module.ts</code>:</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">appRoutes</span><span class="err">:</span> <span class="nx">Routes</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'search'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">SearchComponent</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'edit/:id'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">EditComponent</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="na">redirectTo</span><span class="p">:</span> <span class="s1">'/search'</span><span class="p">,</span> <span class="na">pathMatch</span><span class="p">:</span> <span class="s1">'full'</span> <span class="p">}</span>
<span class="p">];</span>
</code></pre>
</div>

<p>Update <code class="highlighter-rouge">src/app/edit/edit.component.html</code> to display an editable form. You might notice I’ve added <code class="highlighter-rouge">id</code> attributes to most elements. This is to make things easier when writing integration tests with Protractor.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="err">*</span><span class="na">ngIf=</span><span class="s">"person"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h3&gt;</span>{{editName}}<span class="nt">&lt;/h3&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label&gt;</span>Id:<span class="nt">&lt;/label&gt;</span>
    {{person.id}}
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label&gt;</span>Name:<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="err">[(</span><span class="na">ngModel</span><span class="err">)]="</span><span class="na">editName</span><span class="err">"</span> <span class="na">name=</span><span class="s">"name"</span> <span class="na">id=</span><span class="s">"name"</span> <span class="na">placeholder=</span><span class="s">"name"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label&gt;</span>Phone:<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="err">[(</span><span class="na">ngModel</span><span class="err">)]="</span><span class="na">editPhone</span><span class="err">"</span> <span class="na">name=</span><span class="s">"phone"</span> <span class="na">id=</span><span class="s">"phone"</span> <span class="na">placeholder=</span><span class="s">"Phone"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;fieldset&gt;</span>
    <span class="nt">&lt;legend&gt;</span>Address:<span class="nt">&lt;/legend&gt;</span>
    <span class="nt">&lt;address&gt;</span>
      <span class="nt">&lt;input</span> <span class="err">[(</span><span class="na">ngModel</span><span class="err">)]="</span><span class="na">editAddress</span><span class="err">.</span><span class="na">street</span><span class="err">"</span> <span class="na">id=</span><span class="s">"street"</span><span class="nt">&gt;&lt;br/&gt;</span>
      <span class="nt">&lt;input</span> <span class="err">[(</span><span class="na">ngModel</span><span class="err">)]="</span><span class="na">editAddress</span><span class="err">.</span><span class="na">city</span><span class="err">"</span> <span class="na">id=</span><span class="s">"city"</span><span class="nt">&gt;</span>,
      <span class="nt">&lt;input</span> <span class="err">[(</span><span class="na">ngModel</span><span class="err">)]="</span><span class="na">editAddress</span><span class="err">.</span><span class="na">state</span><span class="err">"</span> <span class="na">id=</span><span class="s">"state"</span> <span class="na">size=</span><span class="s">"2"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;input</span> <span class="err">[(</span><span class="na">ngModel</span><span class="err">)]="</span><span class="na">editAddress</span><span class="err">.</span><span class="na">zip</span><span class="err">"</span> <span class="na">id=</span><span class="s">"zip"</span> <span class="na">size=</span><span class="s">"5"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/address&gt;</span>
  <span class="nt">&lt;/fieldset&gt;</span>
  <span class="nt">&lt;button</span> <span class="err">(</span><span class="na">click</span><span class="err">)="</span><span class="na">save</span><span class="err">()"</span> <span class="na">id=</span><span class="s">"save"</span><span class="nt">&gt;</span>Save<span class="nt">&lt;/button&gt;</span>
  <span class="nt">&lt;button</span> <span class="err">(</span><span class="na">click</span><span class="err">)="</span><span class="na">cancel</span><span class="err">()"</span> <span class="na">id=</span><span class="s">"cancel"</span><span class="nt">&gt;</span>Cancel<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>
</div>

<p>Modify <code class="highlighter-rouge">EditComponent</code> to import model and service classes and to use the <code class="highlighter-rouge">SearchService</code> to get data.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span><span class="p">,</span> <span class="nx">OnDestroy</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Address</span><span class="p">,</span> <span class="nx">Person</span><span class="p">,</span> <span class="nx">SearchService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../shared'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Subscription</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">ActivatedRoute</span><span class="p">,</span> <span class="nx">Router</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-edit'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./edit.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./edit.component.css'</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">EditComponent</span> <span class="k">implements</span> <span class="nx">OnInit</span><span class="p">,</span> <span class="nx">OnDestroy</span> <span class="p">{</span>
  <span class="nl">person</span><span class="p">:</span> <span class="nx">Person</span><span class="p">;</span>
  <span class="nl">editName</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">editPhone</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">editAddress</span><span class="p">:</span> <span class="nx">Address</span><span class="p">;</span>

  <span class="nl">sub</span><span class="p">:</span> <span class="nx">Subscription</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">route</span><span class="err">:</span> <span class="nx">ActivatedRoute</span><span class="p">,</span>
              <span class="k">private</span> <span class="nx">router</span><span class="err">:</span> <span class="nx">Router</span><span class="p">,</span>
              <span class="k">private</span> <span class="nx">service</span><span class="err">:</span> <span class="nx">SearchService</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">sub</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">params</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">id</span> <span class="o">=</span> <span class="o">+</span> <span class="nx">params</span><span class="p">[</span><span class="s1">'id'</span><span class="p">];</span> <span class="c1">// (+) converts string 'id' to a number</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">id</span><span class="p">).</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">person</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">person</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">editName</span> <span class="o">=</span> <span class="nx">person</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">editPhone</span> <span class="o">=</span> <span class="nx">person</span><span class="p">.</span><span class="nx">phone</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">editAddress</span> <span class="o">=</span> <span class="nx">person</span><span class="p">.</span><span class="nx">address</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">person</span> <span class="o">=</span> <span class="nx">person</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">gotoList</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">ngOnDestroy</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">unsubscribe</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">cancel</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">navigate</span><span class="p">([</span><span class="s1">'/search'</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="nx">save</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">person</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">editName</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">person</span><span class="p">.</span><span class="nx">phone</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">editPhone</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">person</span><span class="p">.</span><span class="nx">address</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">editAddress</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">person</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gotoList</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">gotoList</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">person</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">navigate</span><span class="p">([</span><span class="s1">'/search'</span><span class="p">,</span> <span class="p">{</span><span class="na">term</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">person</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span> <span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">navigate</span><span class="p">([</span><span class="s1">'/search'</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Modify <code class="highlighter-rouge">SearchService</code> to contain functions for finding a person by their id, and saving them. While you’re in there, modify the <code class="highlighter-rouge">search()</code> method to be aware of updated objects in <code class="highlighter-rouge">localStorage</code>.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="nx">search</span><span class="p">(</span><span class="nx">q</span><span class="err">:</span> <span class="kr">string</span><span class="p">)</span><span class="err">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">q</span> <span class="o">||</span> <span class="nx">q</span> <span class="o">===</span> <span class="s1">'*'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">q</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">q</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getAll</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="na">results</span><span class="p">:</span> <span class="kr">any</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// check for item in localStorage</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">localStorage</span><span class="p">[</span><span class="s1">'person'</span> <span class="o">+</span> <span class="nx">item</span><span class="p">.</span><span class="nx">id</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">item</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">[</span><span class="s1">'person'</span> <span class="o">+</span> <span class="nx">item</span><span class="p">.</span><span class="nx">id</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="nx">q</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="nx">get</span><span class="p">(</span><span class="na">id</span><span class="p">:</span> <span class="kr">number</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getAll</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">all</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">localStorage</span><span class="p">[</span><span class="s1">'person'</span> <span class="o">+</span> <span class="nx">id</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">[</span><span class="s1">'person'</span> <span class="o">+</span> <span class="nx">id</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">all</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="nx">save</span><span class="p">(</span><span class="na">person</span><span class="p">:</span> <span class="nx">Person</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">localStorage</span><span class="p">[</span><span class="s1">'person'</span> <span class="o">+</span> <span class="nx">person</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">person</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>You can add CSS to <code class="highlighter-rouge">src/app/edit/edit.component.css</code> if you want to make the form look a bit better.</p>

<div class="language-css highlighter-rouge"><pre class="highlight"><code><span class="nd">:host</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">0</span> <span class="m">20px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">button</span> <span class="p">{</span>
  <span class="nl">margin-top</span><span class="p">:</span> <span class="m">10px</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>At this point, you should be able to search for a person and update their information.</p>

<p><img alt="Edit form" src="/assets/img/blog/angular-oidc/edit-form.png" style="width: 800px" /></p>

<p>The <code class="highlighter-rouge">&lt;form&gt;</code> in <code class="highlighter-rouge">src/app/edit/edit.component.html</code> calls a <code class="highlighter-rouge">save()</code> function to update a person’s data. You already implemented this above.
The function calls a <code class="highlighter-rouge">gotoList()</code> function that appends the person’s name to the URL when sending the user back to the search screen.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="nx">gotoList</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">person</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">navigate</span><span class="p">([</span><span class="s1">'/search'</span><span class="p">,</span> <span class="p">{</span><span class="na">term</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">person</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span> <span class="p">]);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">navigate</span><span class="p">([</span><span class="s1">'/search'</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Since the <code class="highlighter-rouge">SearchComponent</code> doesn’t execute a search automatically when you execute this URL, add the following logic to do so in its constructor.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Router</span><span class="p">,</span> <span class="nx">ActivatedRoute</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Subscription</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs'</span><span class="p">;</span>
<span class="p">...</span>
  <span class="nl">sub</span><span class="p">:</span> <span class="nx">Subscription</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">searchService</span><span class="err">:</span> <span class="nx">SearchService</span><span class="p">,</span> <span class="k">private</span> <span class="nx">router</span><span class="err">:</span> <span class="nx">Router</span><span class="p">,</span> <span class="k">private</span> <span class="nx">route</span><span class="err">:</span> <span class="nx">ActivatedRoute</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">sub</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">params</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">[</span><span class="s1">'term'</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">params</span><span class="p">[</span><span class="s1">'term'</span><span class="p">]);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">search</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
</code></pre>
</div>

<p>You’ll want to implement <code class="highlighter-rouge">OnDestroy</code> and define the <code class="highlighter-rouge">ngOnDestroy</code> method to clean up this subscription.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span><span class="p">,</span> <span class="nx">OnDestroy</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>

<span class="k">export</span> <span class="kr">class</span> <span class="nx">SearchComponent</span> <span class="k">implements</span> <span class="nx">OnInit</span><span class="p">,</span> <span class="nx">OnDestroy</span> <span class="p">{</span>
<span class="p">...</span>
  <span class="nx">ngOnDestroy</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">sub</span><span class="p">.</span><span class="nx">unsubscribe</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>After making all these changes, you should be able to search/edit/update a person’s information. If it works - nice job!</p>

<h3 id="form-validation">Form Validation</h3>

<p>One thing you might notice is you can clear any input element in the form and save it. At the very least, the <code class="highlighter-rouge">name</code> field should be required. Otherwise, there’s nothing to click on in the search results.</p>

<p>To make name required, modify <code class="highlighter-rouge">edit.component.html</code> to add a <code class="highlighter-rouge">required</code> attribute to the name <code class="highlighter-rouge">&lt;input&gt;</code>.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;input</span> <span class="err">[(</span><span class="na">ngModel</span><span class="err">)]="</span><span class="na">editName</span><span class="err">"</span> <span class="na">name=</span><span class="s">"name"</span> <span class="na">id=</span><span class="s">"name"</span> <span class="na">placeholder=</span><span class="s">"name"</span> <span class="na">required</span><span class="nt">/&gt;</span>
</code></pre>
</div>

<p>You’ll also need to wrap everything in a <code class="highlighter-rouge">&lt;form&gt;</code> element. Add <code class="highlighter-rouge">&lt;form&gt;</code> after the <code class="highlighter-rouge">&lt;h3&gt;</code> tag and close it before the last <code class="highlighter-rouge">&lt;/div&gt;</code>. You’ll also need to add an <code class="highlighter-rouge">(ngSubmit)</code> handler to the form and change the save button to be a regular submit button.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;h3&gt;</span>{{editName}}<span class="nt">&lt;/h3&gt;</span>
<span class="nt">&lt;form</span> <span class="err">(</span><span class="na">ngSubmit</span><span class="err">)="</span><span class="na">save</span><span class="err">()"</span> <span class="na">ngNativeValidate</span><span class="nt">&gt;</span>
  ...
  <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">id=</span><span class="s">"save"</span><span class="nt">&gt;</span>Save<span class="nt">&lt;/button&gt;</span>
  <span class="nt">&lt;button</span> <span class="err">(</span><span class="na">click</span><span class="err">)="</span><span class="na">cancel</span><span class="err">()"</span> <span class="na">id=</span><span class="s">"cancel"</span><span class="nt">&gt;</span>Cancel<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre>
</div>

<p>After making these changes, any field with a <code class="highlighter-rouge">required</code> attribute will be required.</p>

<p><img alt="Edit form with validation" src="/assets/img/blog/angular-oidc/edit-form-validation.png" style="width: 800px" /></p>

<p>In this screenshot, you might notice the address fields are blank. This is explained by the error in your console.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>If ngModel is used within a form tag, either the name attribute must be set or the form 
control must be defined as 'standalone' in ngModelOptions.

Example 1: &lt;input [(ngModel)]="person.firstName" name="first"&gt;
Example 2: &lt;input [(ngModel)]="person.firstName" [ngModelOptions]="{standalone: true}"&gt;
</code></pre>
</div>

<p>To fix, add a <code class="highlighter-rouge">name</code> attribute to all the address fields. For example:</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;address&gt;</span>
  <span class="nt">&lt;input</span> <span class="err">[(</span><span class="na">ngModel</span><span class="err">)]="</span><span class="na">editAddress</span><span class="err">.</span><span class="na">street</span><span class="err">"</span> <span class="na">name=</span><span class="s">"street"</span> <span class="na">id=</span><span class="s">"street"</span><span class="nt">&gt;&lt;br/&gt;</span>
  <span class="nt">&lt;input</span> <span class="err">[(</span><span class="na">ngModel</span><span class="err">)]="</span><span class="na">editAddress</span><span class="err">.</span><span class="na">city</span><span class="err">"</span> <span class="na">name=</span><span class="s">"city"</span> <span class="na">id=</span><span class="s">"city"</span><span class="nt">&gt;</span>,
  <span class="nt">&lt;input</span> <span class="err">[(</span><span class="na">ngModel</span><span class="err">)]="</span><span class="na">editAddress</span><span class="err">.</span><span class="na">state</span><span class="err">"</span> <span class="na">name=</span><span class="s">"state"</span> <span class="na">id=</span><span class="s">"state"</span> <span class="na">size=</span><span class="s">"2"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="err">[(</span><span class="na">ngModel</span><span class="err">)]="</span><span class="na">editAddress</span><span class="err">.</span><span class="na">zip</span><span class="err">"</span> <span class="na">name=</span><span class="s">"zip"</span> <span class="na">id=</span><span class="s">"zip"</span> <span class="na">size=</span><span class="s">"5"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/address&gt;</span>
</code></pre>
</div>

<p>Now values should display in all fields and <code class="highlighter-rouge">name</code> should be required.</p>

<p><img alt="Edit form with names and validation" src="/assets/img/blog/angular-oidc/edit-form-names.png" style="width: 800px" /></p>

<p>With Angular 2, this is all you’ll need to do. However, with Angular 4+, you need to a little more work to stop the form from submitting.</p>

<ul>
  <li>To display HTML5 validation messages, add the <code class="highlighter-rouge">ngNativeValidate</code> directive to the <code class="highlighter-rouge">&lt;form&gt;</code> tag.</li>
  <li>If you want to provide your own validation messages:
    <ul>
      <li>Add <code class="highlighter-rouge">#editForm="ngForm"</code> to the <code class="highlighter-rouge">&lt;form&gt;</code> element.</li>
      <li>Add <code class="highlighter-rouge">#name="ngModel"</code> to the <code class="highlighter-rouge">&lt;input id="name"&gt;</code> element.</li>
      <li>Add <code class="highlighter-rouge">[disabled]="!editForm.form.valid"</code> to the <em>Save</em> button.</li>
      <li>
        <p>Add the following under the <code class="highlighter-rouge">name</code> field to display a validation error.</p>

        <div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="err">[</span><span class="na">hidden</span><span class="err">]="</span><span class="na">name</span><span class="err">.</span><span class="na">valid</span> <span class="err">||</span> <span class="na">name</span><span class="err">.</span><span class="na">pristine</span><span class="err">"</span> <span class="na">style=</span><span class="s">"color: red"</span><span class="nt">&gt;</span>
  Name is required
<span class="nt">&lt;/div&gt;</span>
</code></pre>
        </div>
      </li>
    </ul>
  </li>
</ul>

<p>To learn more about forms and validation, see <a href="https://angular.io/docs/ts/latest/guide/forms.html">Angular forms documentation</a>.</p>

<p><a name="create-open-id-connect-app"></a></p>
<h2 id="create-an-openid-connect-app-in-okta">Create an OpenID Connect App in Okta</h2>

<p>OpenID Connect (OIDC) is built on top of the OAuth 2.0 protocol. It allows clients to verify the identity of the user and, as well as to obtain their basic profile information. To learn more, see <a href="https://openid.net/connect/">https://openid.net/connect/</a>.</p>

<p>To integrate <a href="http://developer.okta.com">Okta</a> for user authentication, you’ll first need to <a href="https://www.okta.com/developer/signup/">register</a> and create an OIDC application.</p>

<p>Login to your Okta account, or <a href="https://www.okta.com/developer/signup/">create one</a> if you don’t have one. Navigate to <strong>Admin &gt; Add Applications</strong> and click on the <strong>Create New App</strong> button. Select <strong>Single Page App (SPA)</strong> for the Platform and <strong>OpenID Connect</strong> for the sign on method. Click the <strong>Create</strong> button and give your application a name. On the next screen, add <code class="highlighter-rouge">http://localhost:4200</code> as a Redirect URI and click *Finish**. You should see settings like the following.</p>

<p><img alt="OIDC App Settings" src="/assets/img/blog/angular-oidc/oidc-settings.png" style="width: 800px" /></p>

<p>Click on the <strong>People</strong> tab and the <strong>Assign to People</strong> button. Assign yourself as a user, or someone else that you know the credentials for.</p>

<p>Install <a href="https://github.com/manfredsteyer">Manfred Steyer’s</a> project to <a href="https://github.com/manfredsteyer/angular-oauth2-oidc">add OAuth 2 and OpenID Connect support</a> using npm.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>npm install --save angular-oauth2-oidc
</code></pre>
</div>

<p>Modify <code class="highlighter-rouge">app.component.ts</code> to import <code class="highlighter-rouge">OAuthService</code> and configure your app to use your Okta application settings.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">OAuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'angular-oauth2-oidc'</span><span class="p">;</span>

<span class="p">...</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">oauthService</span><span class="err">:</span> <span class="nx">OAuthService</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">oauthService</span><span class="p">.</span><span class="nx">redirectUri</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">origin</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">oauthService</span><span class="p">.</span><span class="nx">clientId</span> <span class="o">=</span> <span class="s1">'[client-id]'</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">oauthService</span><span class="p">.</span><span class="nx">scope</span> <span class="o">=</span> <span class="s1">'openid profile email'</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">oauthService</span><span class="p">.</span><span class="nx">oidc</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">oauthService</span><span class="p">.</span><span class="nx">issuer</span> <span class="o">=</span> <span class="s1">'https://dev-[dev-id].oktapreview.com'</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">oauthService</span><span class="p">.</span><span class="nx">loadDiscoveryDocument</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">oauthService</span><span class="p">.</span><span class="nx">tryLogin</span><span class="p">({});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">...</span>
</code></pre>
</div>

<p>Create <code class="highlighter-rouge">src/app/home/home.component.ts</code> and configure it to have <strong>Login</strong> and <strong>Logout</strong> buttons.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">OAuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'angular-oauth2-oidc'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Component</span><span class="p">({</span>
  <span class="na">template</span><span class="p">:</span> <span class="err">`</span><span class="o">&lt;</span><span class="nx">div</span> <span class="o">*</span><span class="nx">ngIf</span><span class="o">=</span><span class="s2">"givenName"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="nx">Welcome</span><span class="p">,</span> <span class="p">{{</span><span class="nx">givenName</span><span class="p">}}</span><span class="o">!&lt;</span><span class="sr">/h2</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">button</span> <span class="p">(</span><span class="nx">click</span><span class="p">)</span><span class="o">=</span><span class="s2">"logout()"</span><span class="o">&gt;</span><span class="nx">Logout</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="nx">routerLink</span><span class="o">=</span><span class="s2">"/search"</span> <span class="nx">routerLinkActive</span><span class="o">=</span><span class="s2">"active"</span><span class="o">&gt;</span><span class="nx">Search</span><span class="o">&lt;</span><span class="sr">/a&gt;&lt;/</span><span class="nx">p</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>
<span class="o">&lt;</span><span class="nx">div</span> <span class="o">*</span><span class="nx">ngIf</span><span class="o">=</span><span class="s2">"!givenName"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">button</span> <span class="p">(</span><span class="nx">click</span><span class="p">)</span><span class="o">=</span><span class="s2">"login()"</span><span class="o">&gt;</span><span class="nx">Login</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/div&gt;</span><span class="err">`
</span><span class="p">})</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">HomeComponent</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="na">oauthService</span><span class="p">:</span> <span class="nx">OAuthService</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="nx">login</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">oauthService</span><span class="p">.</span><span class="nx">initImplicitFlow</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">logout</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">oauthService</span><span class="p">.</span><span class="nx">logOut</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">get</span> <span class="nx">givenName</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">claims</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">oauthService</span><span class="p">.</span><span class="nx">getIdentityClaims</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">claims</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">claims</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Create <code class="highlighter-rouge">src/app/shared/auth/auth.guard.service.ts</code> to navigate to the <code class="highlighter-rouge">HomeComponent</code> if the user is not authenticated.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">ActivatedRouteSnapshot</span><span class="p">,</span> <span class="nx">CanActivate</span><span class="p">,</span> <span class="nx">Router</span><span class="p">,</span> <span class="nx">RouterStateSnapshot</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">OAuthService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'angular-oauth2-oidc'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">AuthGuard</span> <span class="k">implements</span> <span class="nx">CanActivate</span> <span class="p">{</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">oauthService</span><span class="err">:</span> <span class="nx">OAuthService</span><span class="p">,</span> <span class="k">private</span> <span class="nx">router</span><span class="err">:</span> <span class="nx">Router</span><span class="p">)</span> <span class="p">{}</span>

  <span class="nx">canActivate</span><span class="p">(</span><span class="nx">route</span><span class="err">:</span> <span class="nx">ActivatedRouteSnapshot</span><span class="p">,</span> <span class="nx">state</span><span class="err">:</span> <span class="nx">RouterStateSnapshot</span><span class="p">)</span><span class="err">:</span> <span class="kr">boolean</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">oauthService</span><span class="p">.</span><span class="nx">hasValidIdToken</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">navigate</span><span class="p">([</span><span class="s1">'/home'</span><span class="p">]);</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Import the <code class="highlighter-rouge">OAuthModule</code> in <code class="highlighter-rouge">app.module.ts</code>, configure the new <code class="highlighter-rouge">HomeComponent</code>, and lock the <code class="highlighter-rouge">/search</code> and <code class="highlighter-rouge">/edit</code> routes down with the <code class="highlighter-rouge">AuthGuard</code>.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">OAuthModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'angular-oauth2-oidc'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">HomeComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./home/home.component'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AuthGuard</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./shared/auth/auth.guard.service'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">appRoutes</span><span class="err">:</span> <span class="nx">Routes</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'search'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">SearchComponent</span><span class="p">,</span> <span class="na">canActivate</span><span class="p">:</span> <span class="p">[</span><span class="nx">AuthGuard</span><span class="p">]</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'edit/:id'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">EditComponent</span><span class="p">,</span> <span class="na">canActivate</span><span class="p">:</span> <span class="p">[</span><span class="nx">AuthGuard</span><span class="p">]},</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'home'</span><span class="p">,</span> <span class="na">component</span><span class="p">:</span> <span class="nx">HomeComponent</span><span class="p">},</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="na">redirectTo</span><span class="p">:</span> <span class="s1">'home'</span><span class="p">,</span> <span class="na">pathMatch</span><span class="p">:</span> <span class="s1">'full'</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="s1">'**'</span><span class="p">,</span> <span class="na">redirectTo</span><span class="p">:</span> <span class="s1">'home'</span> <span class="p">}</span>
<span class="p">];</span>

<span class="err">@</span><span class="nx">NgModule</span><span class="p">({</span>
  <span class="na">declarations</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">...</span>
    <span class="nx">HomeComponent</span>
  <span class="p">],</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">...</span>
    <span class="nx">OAuthModule</span><span class="p">.</span><span class="nx">forRoot</span><span class="p">()</span>
  <span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">AuthGuard</span><span class="p">],</span>
  <span class="na">bootstrap</span><span class="p">:</span> <span class="p">[</span><span class="nx">AppComponent</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">AppModule</span> <span class="p">{</span> <span class="p">}</span>
</code></pre>
</div>

<p>After making these changes, you should be able to run <code class="highlighter-rouge">ng serve</code> and see a login button.</p>

<p><img alt="Login button" src="/assets/img/blog/angular-oidc/okta-login-button.png" style="width: 800px" /></p>

<p>Click the <strong>Login</strong> button and sign-in with one of the people that’s configured in your Okta application.</p>

<p><img alt="Okta Login form" src="/assets/img/blog/angular-oidc/okta-login-form.png" style="width: 800px" /></p>

<p>After logging in, you’ll be able to click <em>Search</em> and view people’s information.</p>

<p><img alt="View after login" src="/assets/img/blog/angular-oidc/okta-post-login.png" style="width: 800px" /></p>

<p>If it works - great! If you want to build your own login form in your app, continue reading to learn how to use the <a href="https://github.com/okta/okta-auth-js">Okta Auth SDK</a> with <code class="highlighter-rouge">OAuthService</code>.</p>

<h3 id="authentication-with-the-okta-auth-sdk">Authentication with the Okta Auth SDK</h3>

<p>The Okta Auth SDK builds on top of Otka’s <a href="http://developer.okta.com/docs/api/resources/authn.html">Authentication API</a> and <a href="http://developer.okta.com/docs/api/resources/oidc.html">OAuth 2.0 API</a> to enable you to create a fully branded sign-in experience using JavaScript.</p>

<p>Install it using npm:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>npm install @okta/okta-auth-js --save
</code></pre>
</div>

<p>Add a reference to this library’s main JavaScript file in <code class="highlighter-rouge">.angular-cli.json</code>:</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="s2">"scripts"</span><span class="err">:</span><span class="w"> </span><span class="p">[</span><span class="w">
  </span><span class="s2">"../node_modules/@okta/okta-auth-js/dist/okta-auth-js.min.js"</span><span class="w">
</span><span class="p">]</span><span class="err">,</span><span class="w">
</span></code></pre>
</div>

<p>The components in this section use Bootstrap CSS classes. Add a reference to Bootstrap’s CSS in the <code class="highlighter-rouge">&lt;head&gt;</code> of <code class="highlighter-rouge">src/index.html</code>.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;head&gt;</span>
  ...
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
</code></pre>
</div>

<p>Change <code class="highlighter-rouge">HomeComponent</code> to declare <code class="highlighter-rouge">OktaAuth</code> and modify its <code class="highlighter-rouge">template</code> so it has a button to login, as well as a sign-in form.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="kr">declare</span> <span class="kd">let</span> <span class="nx">OktaAuth</span><span class="err">:</span> <span class="kr">any</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Component</span><span class="p">({</span>
  <span class="na">template</span><span class="p">:</span> <span class="err">`</span><span class="o">&lt;</span><span class="nx">div</span> <span class="o">*</span><span class="nx">ngIf</span><span class="o">=</span><span class="s2">"givenName"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="nx">Welcome</span><span class="p">,</span> <span class="p">{{</span><span class="nx">givenName</span><span class="p">}}</span><span class="o">!&lt;</span><span class="sr">/h2</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">button</span> <span class="p">(</span><span class="nx">click</span><span class="p">)</span><span class="o">=</span><span class="s2">"logout()"</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"btn btn-default"</span><span class="o">&gt;</span><span class="nx">Logout</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="nx">routerLink</span><span class="o">=</span><span class="s2">"/search"</span> <span class="nx">routerLinkActive</span><span class="o">=</span><span class="s2">"active"</span><span class="o">&gt;</span><span class="nx">Search</span><span class="o">&lt;</span><span class="sr">/a&gt;&lt;/</span><span class="nx">p</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>
<span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"panel panel-default"</span> <span class="o">*</span><span class="nx">ngIf</span><span class="o">=</span><span class="s2">"!givenName"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"panel-body"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Login</span> <span class="kd">with</span> <span class="nx">Authorization</span> <span class="nx">Server</span><span class="o">&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">button</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"btn btn-default"</span> <span class="p">(</span><span class="nx">click</span><span class="p">)</span><span class="o">=</span><span class="s2">"login()"</span><span class="o">&gt;</span><span class="nx">Login</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>
<span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"panel panel-default"</span> <span class="o">*</span><span class="nx">ngIf</span><span class="o">=</span><span class="s2">"!givenName"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"panel-body"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Login</span> <span class="kd">with</span> <span class="nx">Username</span><span class="o">/</span><span class="nx">Password</span><span class="o">&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>
        <span class="o">&lt;</span><span class="nx">p</span> <span class="nx">style</span><span class="o">=</span><span class="s2">"color:red; font-weight:bold"</span> <span class="o">*</span><span class="nx">ngIf</span><span class="o">=</span><span class="s2">"loginFailed"</span><span class="o">&gt;</span>
            <span class="nx">Login</span> <span class="nx">wasn</span><span class="err">'</span><span class="nx">t</span> <span class="nx">successful</span><span class="p">.</span>
        <span class="o">&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"form-group"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">label</span><span class="o">&gt;</span><span class="nx">Username</span><span class="o">&lt;</span><span class="sr">/label</span><span class="err">&gt;
</span>            <span class="o">&lt;</span><span class="nx">input</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"form-control"</span> <span class="p">[(</span><span class="nx">ngModel</span><span class="p">)]</span><span class="o">=</span><span class="s2">"username"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"form-group"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">label</span><span class="o">&gt;</span><span class="nx">Password</span><span class="o">&lt;</span><span class="sr">/label</span><span class="err">&gt;
</span>            <span class="o">&lt;</span><span class="nx">input</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"form-control"</span> <span class="kd">type</span><span class="o">=</span><span class="s2">"password"</span> <span class="p">[(</span><span class="nx">ngModel</span><span class="p">)]</span><span class="o">=</span><span class="s2">"password"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"form-group"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">button</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"btn btn-default"</span> <span class="p">(</span><span class="nx">click</span><span class="p">)</span><span class="o">=</span><span class="s2">"loginWithPassword()"</span><span class="o">&gt;</span><span class="nx">Login</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/div&gt;</span><span class="err">`
</span><span class="p">})</span>
</code></pre>
</div>

<p>After making these changes, the <code class="highlighter-rouge">HomeComponent</code> should render as follows.</p>

<p><img alt="Custom sign-in form" src="/assets/img/blog/angular-oidc/sign-in-form.png" style="width: 800px" /></p>

<p>Import Angular’s <code class="highlighter-rouge">Router</code>, add it as a dependency in the constructor, and add local variables for the username and password fields. Then implement a <code class="highlighter-rouge">loginWithPassword()</code> method in <code class="highlighter-rouge">HomeComponent</code>. This method uses the <code class="highlighter-rouge">OktaAuth</code> library to get a session token and exchange it for ID and access tokens.</p>

<div class="language-typescript highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Router</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>
<span class="p">...</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">HomeComponent</span> <span class="p">{</span>
  <span class="nx">username</span><span class="p">;</span>
  <span class="nx">password</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">oauthService</span><span class="err">:</span> <span class="nx">OAuthService</span><span class="p">,</span> <span class="k">private</span> <span class="nx">router</span><span class="err">:</span> <span class="nx">Router</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>  
  <span class="p">...</span>
  <span class="nx">loginWithPassword</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">oauthService</span><span class="p">.</span><span class="nx">createAndSaveNonce</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">nonce</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">authClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OktaAuth</span><span class="p">({</span>
        <span class="na">url</span><span class="p">:</span> <span class="s1">'https://dev-158606.oktapreview.com'</span>
      <span class="p">});</span>
      <span class="nx">authClient</span><span class="p">.</span><span class="nx">signIn</span><span class="p">({</span>
        <span class="na">username</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
        <span class="na">password</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">password</span>
      <span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="s1">'SUCCESS'</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">authClient</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">getWithoutPrompt</span><span class="p">({</span>
            <span class="na">clientId</span><span class="p">:</span> <span class="s1">'RqjWvpvWO77qMGgDfukY'</span><span class="p">,</span>
            <span class="na">responseType</span><span class="p">:</span> <span class="p">[</span><span class="s1">'id_token'</span><span class="p">,</span> <span class="s1">'token'</span><span class="p">],</span>
            <span class="na">scopes</span><span class="p">:</span> <span class="p">[</span><span class="s1">'openid'</span><span class="p">,</span> <span class="s1">'profile'</span><span class="p">,</span> <span class="s1">'email'</span><span class="p">],</span>
            <span class="na">sessionToken</span><span class="p">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">sessionToken</span><span class="p">,</span>
            <span class="na">nonce</span><span class="p">:</span> <span class="nx">nonce</span><span class="p">,</span>
            <span class="na">redirectUri</span><span class="p">:</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">origin</span>
          <span class="p">})</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">tokens</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">oauthService</span><span class="p">.</span><span class="nx">processIdToken</span><span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">idToken</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">accessToken</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">navigate</span><span class="p">([</span><span class="s1">'/home'</span><span class="p">]);</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'We cannot handle the '</span> <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">+</span> <span class="s1">' status'</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>You should be able to sign in using the form, using one of your app’s registered users. After logging in, you’ll be able to click the <strong>Search</strong> link and view people’s information.</p>

<p><img alt="View after sign-in" src="/assets/img/blog/angular-oidc/sign-in-form-success.png" style="width: 800px" /></p>

<h2 id="angular--okta">Angular + Okta</h2>

<p>If everything works - congrats! If you encountered issues, please post a question to Stack Overflow with an <a href="http://stackoverflow.com/questions/tagged/okta">okta tag</a>, or hit me up on Twitter <a href="https://twitter.com/mraible">@mraible</a>.</p>

<p>You can find a completed version of the application created in this blog post <a href="https://github.com/oktadeveloper/okta-angular-openid-connect-example">on GitHub</a>. To learn more about security in Angular, see <a href="https://angular.io/docs/ts/latest/guide/security.html">Angular’s Security documentation</a>. If you’d like to learn more about OpenID Connect, I’d recommend watching the soothing video below.</p>

<div style="max-width: 560px; margin: 0 auto">
<iframe width="560" height="315" src="https://www.youtube.com/embed/Kb56GzQ2pSk" frameborder="0" allowfullscreen=""></iframe>
</div>


	  </section>
	</article>
</div>
</section>
<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2017/03/30/react-okta-sign-in-widget">Build a React Application with User Authentication in 15 Minutes</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-leebrandt.jpg"
	           alt="avatar-leebrandt.jpg"
	           class="author-avatar">
	      <address>Lee Brandt</address>
	      &nbsp;
		  <a class="social_link" href="https://github.com/leebrandt"><i class="fa fa-github-square"></i></a>
		  <a class="social_link" href="https://twitter.com/leebrandt"><i class="fa fa-twitter-square"></i></a>
		  <a class="social_link" href="http://leebrandt.me"><i class="fa fa-external-link-square"></i></a>
		  <span class="sepr">&middot;</span>
	      <time datetime="2017-03-30">March 30, 2017</time>
	    </div>
	  </header>
	  <section class="post-content">
	    <p>React has quickly become one of the most favored front-end web frameworks, and is second only to plain old HTML5, <a href="https://jaxenter.com/technology-trends-2017-top-frameworks-131993.html">according to JAXenter</a>. So it’s no surprise that <a href="https://www.lynda.com/React-js-training-tutorials/7049-0.html">developers are learning it</a>, and <a href="https://stackoverflow.com/jobs?sort=i&amp;q=ReactJS">employers are asking for it</a>.</p>

<p>In this tutorial, you’ll start with a very simple React app with a couple of pages and some routing built in, and add authentication using <a href="http://developer.okta.com/code/javascript/okta_sign-in_widget">Okta’s Sign-In Widget</a>. The Sign-In Widget is an embeddable Javascript widget that allows developers to use Okta’s secure, scalable architecture with a minimum of effort from within React applications. Let’s get started!</p>
<h2 id="get-the-simple-react-seed-project">Get the Simple React Seed Project</h2>
<p>Start by cloning the simple React seed project.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>git clone https://github.com/leebrandt/simple-react-seed.git okta-react-widget-sample
<span class="nb">cd </span>okta-react-widget-sample
npm install
npm start
</code></pre>
</div>
<p>When you open <code class="highlighter-rouge">http://localhost:3000</code>, you should see something like this:</p>

<p><img src="/assets/img/blog/react-sign-in-widget/React-Simple-Seed-Screener.png" alt="Running Seed" /></p>

<p>When you click on the navigation links, you should see page placeholders for those links.</p>
<h2 id="add-the-okta-sign-in-widget">Add the Okta Sign-In Widget</h2>
<p>Install the <a href="https://github.com/okta/okta-signin-widget">Okta Sign-In Widget</a> using NPM. We’ll be using version 1.9.0 of the Sign-In Widget, which is the most recent version at the time of this writing. Note that <a href="https://github.com/okta/okta-signin-widget/issues/191">using Yarn won’t work</a>.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>npm install @okta/okta-signin-widget@1.9.0 --save
</code></pre>
</div>
<p>This will add the Okta Sign-In Widget code to your <code class="highlighter-rouge">node_modules</code> folder.</p>

<p><img src="/assets/img/blog/react-sign-in-widget/Okta-Widget-NPM-Modules-Screener.png" alt="Okta in node_modules" /></p>

<p>Then add the styles for the widget in your <code class="highlighter-rouge">index.html</code> file from the Okta CDN:</p>
<div class="language-html highlighter-rouge"><pre class="highlight"><code>    <span class="nt">&lt;link</span> 
     <span class="na">href=</span><span class="s">"https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/1.9.0/css/okta-sign-in.min.css"</span>
      <span class="na">type=</span><span class="s">"text/css"</span>
      <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!-- Theme file: Customize or replace this file if you want to override our default styles --&gt;</span>
    <span class="nt">&lt;link</span>
      <span class="na">href=</span><span class="s">"https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/1.9.0/css/okta-theme.css"</span>
      <span class="na">type=</span><span class="s">"text/css"</span>
      <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">/&gt;</span>
</code></pre>
</div>

<h2 id="the-loginpage-component">The LoginPage Component</h2>
<p>First, create a folder called <code class="highlighter-rouge">auth</code> in the <code class="highlighter-rouge">./src/components</code> folder, then create a file called <code class="highlighter-rouge">LoginPage.js</code> where the <code class="highlighter-rouge">LoginPage</code> component will go.</p>

<p>Start with the most basic of components</p>

<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">'react'</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">LoginPage</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span><span class="p">{</span>
  <span class="nx">render</span><span class="p">(){</span>
    <span class="k">return</span><span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">Login</span> <span class="nx">Page</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>This little component doesn’t <em>do</em> much but at least you now have a handle to add the <code class="highlighter-rouge">LoginPage</code> to your routing. So in your <code class="highlighter-rouge">./src/app.js</code> file, you’ll import the component with:</p>

<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="kr">import</span> <span class="nx">LoginPage</span> <span class="nx">from</span> <span class="s1">'./components/auth/LoginPage'</span><span class="p">;</span>
</code></pre>
</div>
<p>and then add the route inside the main route (the one with the path of “/”)</p>
<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">Route</span> <span class="nx">path</span><span class="o">=</span><span class="s2">"/login"</span> <span class="nx">component</span><span class="o">=</span><span class="p">{</span><span class="nx">LoginPage</span><span class="p">}</span><span class="sr">/</span><span class="err">&gt;
</span></code></pre>
</div>
<h2 id="add-the-openid-connect-application-in-okta">Add the OpenID Connect Application in Okta</h2>
<p>In order to <em>use</em> Okta as your OpenID Connect provider for authentication, you’ll need to set up an application in the <a href="http://developer.okta.com/">Okta developer portal</a>.</p>

<p>So log in to your Okta account, [or create one](http://developer.okta.com] if you haven’t yet. Navigate to Admin &gt; Add Applications and click on the Create New App button. Select Single Page App (SPA) for Platform and OpenID Connect for the sign on method. Click the Create button and give your application a name. On the next screen, add <code class="highlighter-rouge">http://localhost:3000</code> as a Redirect URI and click Finish. You should see settings like the following.</p>

<p><img alt="OIDC Application Settings" src="/assets/img/blog/react-sign-in-widget/Okta-Developer-Portal-OIDC-App-Screener.png" style="width: 800px" /></p>

<p>Make note of the <code class="highlighter-rouge">Client ID</code> (yours shouldn’t be blurred out) and make note of your Dev ID (it’s the number part of your subdomain of the URL) So if you are at https://dev-1234-admin.oktapreview.com/… your Dev ID is 1234.</p>

<p>Now that you have that, you can set up the widget to talk to your new app!</p>
<h2 id="add-the-widget-to-your-component">Add the Widget to Your Component</h2>
<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">'react'</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">OktaSignIn</span> <span class="nx">from</span> <span class="s1">'@okta/okta-signin-widget'</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">LoginPage</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span><span class="p">{</span>
  <span class="nx">constructor</span><span class="p">(){</span>
    <span class="kr">super</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">widget</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OktaSignIn</span><span class="p">({</span>
      <span class="na">baseUrl</span><span class="p">:</span> <span class="s1">'https://dev-[dev id].oktapreview.com'</span><span class="p">,</span>
      <span class="na">clientId</span><span class="p">:</span> <span class="s1">'[client id]'</span><span class="p">,</span>
      <span class="na">redirectUri</span><span class="p">:</span> <span class="s1">'http://localhost:3000'</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">(){</span>
    <span class="k">return</span><span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">Login</span> <span class="nx">Page</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Thus far you’ve imported the <code class="highlighter-rouge">OktaSignIn</code> function from the <a href="https://github.com/okta/okta-signin-widget">Okta Sign-In Widget</a> <code class="highlighter-rouge">npm</code> module you installed earlier. Next, in the constructor of the component, you initialized an instance of <code class="highlighter-rouge">OktaSignIn</code> with the configuration for the application. This way, the application code will be able to talk to Okta and Okta will recognize that this is the app you just created.</p>
<h2 id="show-the-login-widget">Show The Login Widget</h2>
<p>Next, you’ll create the code to actually render the Sign-In Widget to the page! You’ll need to change your render method to create an HTML element  you can render the widget into. Make sure to get a <a href="https://facebook.github.io/react/docs/refs-and-the-dom.html">reference to the element</a> that will be rendered. Then, add a <code class="highlighter-rouge">componentDidMount</code> function to make sure you don’t try to render the widget before the HTML element is on the page.</p>

<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">'react'</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">OktaSignIn</span> <span class="nx">from</span> <span class="s1">'@okta/okta-signin-widget'</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">LoginPage</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span><span class="p">{</span>
  <span class="nx">constructor</span><span class="p">(){</span>
    <span class="kr">super</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span><span class="na">user</span><span class="p">:</span><span class="kc">null</span><span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">widget</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OktaSignIn</span><span class="p">({</span>
      <span class="na">baseUrl</span><span class="p">:</span> <span class="s1">'https://dev-[dev id].oktapreview.com'</span><span class="p">,</span>
      <span class="na">clientId</span><span class="p">:</span> <span class="s1">'[client id]'</span><span class="p">,</span>
      <span class="na">redirectUri</span><span class="p">:</span> <span class="s1">'http://localhost:3000'</span><span class="p">,</span>
      <span class="na">authParams</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">responseType</span><span class="p">:</span> <span class="s1">'id_token'</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">componentDidMount</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">widget</span><span class="p">.</span><span class="nx">renderEl</span><span class="p">({</span><span class="na">el</span><span class="p">:</span><span class="k">this</span><span class="p">.</span><span class="nx">loginContainer</span><span class="p">},</span>
      <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">user</span><span class="p">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">claims</span><span class="p">.</span><span class="nx">email</span><span class="p">});</span>
      <span class="p">},</span>
      <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">(){</span>
    <span class="k">return</span><span class="p">(</span>
     <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">ref</span><span class="o">=</span><span class="p">{(</span><span class="nx">div</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">loginContainer</span> <span class="o">=</span> <span class="nx">div</span><span class="p">;</span> <span class="p">}}</span> <span class="sr">/</span><span class="err">&gt;
</span>    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>
<p>You also added state to your component. If you’re using a flux implementation, this would naturally come from the app state. But to keep this tutorial simple, let your <code class="highlighter-rouge">LoginPage</code> keep track of it’s own state.</p>
<h2 id="check-whether-the-user-is-logged-in">Check Whether the User is Logged In</h2>
<p>We’re almost there, but you don’t necessarily want to render the widget right away. You’ll need to add a check to make sure the user isn’t already logged in, and move your <code class="highlighter-rouge">renderEl</code> out to a function called <code class="highlighter-rouge">showLogin</code>.</p>

<div class="language-js highlighter-rouge"><pre class="highlight"><code> <span class="c1">// ...other stuff removed for brevity's sake</span>
 <span class="nx">componentDidMount</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">widget</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">get</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">!==</span> <span class="s1">'INACTIVE'</span><span class="p">){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">user</span><span class="p">:</span><span class="nx">response</span><span class="p">.</span><span class="nx">login</span><span class="p">});</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">showLogin</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">showLogin</span><span class="p">(){</span>
    <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">widget</span><span class="p">.</span><span class="nx">renderEl</span><span class="p">({</span><span class="na">el</span><span class="p">:</span><span class="k">this</span><span class="p">.</span><span class="nx">loginContainer</span><span class="p">},</span>
      <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">user</span><span class="p">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">claims</span><span class="p">.</span><span class="nx">email</span><span class="p">});</span>
      <span class="p">},</span>
      <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">);</span>
  <span class="p">}</span>
</code></pre>
</div>
<blockquote>
  <p><em>You might have noticed a weird bit of code in that <code class="highlighter-rouge">showLogin</code> method. That first line: <code class="highlighter-rouge">Backbone.history.stop()</code>. The widget itself uses <a href="http://backbonejs.org/">Backbone.js</a> to navigate between its own screens (login, forgot password, etc.), and when it renders, it starts the <code class="highlighter-rouge">Backbone.history</code>. Since you’ve now moved it out into a <code class="highlighter-rouge">showLogin</code> function, the widget is going to re-render whenever the function is called. So this is just a little trick to tell Backbone to stop the history, because it’s going to restart when the widget is rendered.</em></p>
</blockquote>

<h2 id="the-final-loginpage-react-component">The Final LoginPage React Component</h2>
<p>Let’s wrap this up. Make sure you bind the class’s <code class="highlighter-rouge">this</code> context to each of your methods. Add a <code class="highlighter-rouge">logout</code> method, and change your <code class="highlighter-rouge">render</code> method to make a decision on what to render, based on whether there is a currently logged in user.</p>

<p>So the final version of <code class="highlighter-rouge">LoginPage.js</code> should look like this.</p>

<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">'react'</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">OktaSignIn</span> <span class="nx">from</span> <span class="s1">'@okta/okta-signin-widget'</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">LoginPage</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span><span class="p">{</span>
  <span class="nx">constructor</span><span class="p">(){</span>
    <span class="kr">super</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span> <span class="na">user</span><span class="p">:</span> <span class="kc">null</span> <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">widget</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OktaSignIn</span><span class="p">({</span>
      <span class="na">baseUrl</span><span class="p">:</span> <span class="s1">'https://dev-[dev id].oktapreview.com'</span><span class="p">,</span>
      <span class="na">clientId</span><span class="p">:</span> <span class="s1">'[client id]'</span><span class="p">,</span>
      <span class="na">redirectUri</span><span class="p">:</span> <span class="s1">'http://localhost:3000'</span><span class="p">,</span>
      <span class="na">authParams</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">responseType</span><span class="p">:</span> <span class="s1">'id_token'</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">showLogin</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">showLogin</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logout</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">logout</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">componentDidMount</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">widget</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">get</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">!==</span> <span class="s1">'INACTIVE'</span><span class="p">){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">user</span><span class="p">:</span><span class="nx">response</span><span class="p">.</span><span class="nx">login</span><span class="p">});</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">showLogin</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">showLogin</span><span class="p">(){</span>
    <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">widget</span><span class="p">.</span><span class="nx">renderEl</span><span class="p">({</span><span class="na">el</span><span class="p">:</span><span class="k">this</span><span class="p">.</span><span class="nx">loginContainer</span><span class="p">},</span> 
      <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">user</span><span class="p">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">claims</span><span class="p">.</span><span class="nx">email</span><span class="p">});</span>
      <span class="p">},</span>
      <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">logout</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">widget</span><span class="p">.</span><span class="nx">signOut</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">user</span><span class="p">:</span> <span class="kc">null</span><span class="p">});</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">showLogin</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">(){</span>
    <span class="k">return</span><span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">user</span> <span class="p">?</span> <span class="p">(</span>
          <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"container"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">Welcome</span><span class="p">,</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">user</span><span class="p">}</span><span class="o">!&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>            <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">logout</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">Logout</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>          <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>        <span class="p">)</span> <span class="p">:</span> <span class="kc">null</span><span class="p">}</span>
        <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">user</span> <span class="p">?</span> <span class="kc">null</span> <span class="p">:</span> <span class="p">(</span>
          <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">ref</span><span class="o">=</span><span class="p">{(</span><span class="nx">div</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">loginContainer</span> <span class="o">=</span> <span class="nx">div</span><span class="p">;</span> <span class="p">}}</span> <span class="sr">/</span><span class="err">&gt;
</span>        <span class="p">)}</span>
      <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>
<h2 id="check-it-out">Check It Out</h2>
<p>When you run the app now (with <code class="highlighter-rouge">npm start</code>), you should see something like this:</p>

<p><img src="/assets/img/blog/react-sign-in-widget/Finished-Sample-Screener.gif" alt="Finished Sample" /></p>

<p>If it works - congrats! If it doesn’t, please post a question to Stack Overflow with an <a href="http://stackoverflow.com/questions/tagged/okta">okta tag</a>, or hit me up on Twitter <a href="https://twitter.com/leebrandt">@leebrandt</a>.</p>
<h2 id="known-issues">Known Issues</h2>
<p>There is one known issue in this tutorial. The widget’s CSS takes over the whole page and will override your app’s CSS. This is a <a href="https://github.com/okta/okta-signin-widget/issues/126">documented issue</a> and you can see <a href="https://github.com/okta">Matt Raible’s comment on it</a></p>
<h2 id="react--okta">React + Okta</h2>
<p>You can find a completed version of the application created in this blog post <a href="https://github.com/leebrandt/okta-react-widget-sample">on GitHub</a>.</p>

<p>Building authentication in an application is hard. It’s even less fun to build it over and over again in each application you build. Okta does the hard part for you and makes it a lot more fun to be a developer! <a href="https://www.okta.com/developer/signup/">Sign up for a forever-free developer account</a> and try Okta today!</p>

<p>I hope you’ve enjoyed this quick tour of our React support. If you have questions about Okta’s features, or what we’re building next, please hit me up on Twitter <a href="https://twitter.com/leebrandt">@leebrandt</a>, leave a comment below, or open an issue on GitHub.</p>

	  </section>
	</article>
</div>
</section>
<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2017/03/27/angular-okta-sign-in-widget">Build an Angular App with Okta's Sign-In Widget in 15 Minutes</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-matt_raible.jpg"
	           alt="avatar-matt_raible.jpg"
	           class="author-avatar">
	      <address>Matt Raible</address>
	      &nbsp;
		  <a class="social_link" href="https://github.com/mraible"><i class="fa fa-github-square"></i></a>
		  <a class="social_link" href="https://twitter.com/mraible"><i class="fa fa-twitter-square"></i></a>
		  <a class="social_link" href="http://raibledesigns.com"><i class="fa fa-external-link-square"></i></a>
		  <span class="sepr">&middot;</span>
	      <time datetime="2017-03-27">March 27, 2017</time>
	    </div>
	  </header>
	  <section class="post-content">
	    <p>AngularJS reigned as king of JavaScript MVC frameworks for several years. However, when the Angular team announced they would not provide backwards compatibility for their next version, there was a bit of a stir in its community, giving opportunities for frameworks like React and Vue.js to flourish. Fast forward a few years and both Angular 2 and Angular 4 have been released. Many developers are trying its TypeScript and finding the experience a pleasant one. <a href="https://jaxenter.com/technology-trends-2017-top-frameworks-131993.html">According to JAXenter</a>, it’s doing a pretty good job, and holding strong as the third most popular UI framework, behind React and HTML5.</p>

<p>In this article, I’ll show you a quick way to get started with Angular, and add user authentication with <a href="http://developer.okta.com/code/javascript/okta_sign-in_widget">Okta’s Sign-In Widget</a>. If you’re just getting started with Angular, you might want to read my <a href="http://gist.asciidoctor.org/?github-mraible/ng-demo//README.adoc">Angular tutorial</a>. If you’d like to get the source code used in this article, you can <a href="https://github.com/oktadeveloper/okta-angular-sign-in-widget-example">find it on GitHub</a>.</p>

<h2 id="why-user-authentication-with-okta">Why User Authentication with Okta?</h2>

<p>Okta provides an API service that allows developers to create, edit, and securely store user accounts and user account data, and connect them with one or multiple applications. We make user account management easier, more secure, and scalable so you can get to production sooner.</p>

<p>The <a href="http://developer.okta.com/code/javascript/okta_sign-in_widget_ref">Okta Sign-in Widget</a> provides an embeddable JavaScript sign-in implementation that can be easily customized. The Sign-in Widget carries the same feature set in the standard Okta sign-in page of every tenant – with the added flexibility to change the look-and-feel. Included in the widget is support for password reset, forgotten password and strong authentication – all of which are driven by policies configured in Okta. Developers don’t have to write a single line of code to trigger these functions from within the widget. For consumer facing sites, social providers are also supported in the widget.</p>

<h2 id="create-an-angular-application">Create an Angular Application</h2>

<p>Angular 4 was <a href="http://angularjs.blogspot.com/2017/03/angular-400-now-available.html">recently released</a>, as well as <a href="https://github.com/angular/angular-cli/blob/master/CHANGELOG.md#100-2017-03-24">Angular CLI 1.0</a>. To see how you might use Okta’s Sign-In Widget in a simple Angular application, create a new application with Angular CLI. First, you’ll need to install Angular CLI.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>npm install -g @angular/cli
</code></pre>
</div>

<p>After this command completes, you can create a new application.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="o">[</span>mraible:~] <span class="nv">$ </span>ng new angular-okta-example
installing ng
  create .editorconfig
  create README.md
  create src/app/app.component.css
  create src/app/app.component.html
  create src/app/app.component.spec.ts
  create src/app/app.component.ts
  create src/app/app.module.ts
  create src/assets/.gitkeep
  create src/environments/environment.prod.ts
  create src/environments/environment.ts
  create src/favicon.ico
  create src/index.html
  create src/main.ts
  create src/polyfills.ts
  create src/styles.css
  create src/test.ts
  create src/tsconfig.app.json
  create src/tsconfig.spec.json
  create src/typings.d.ts
  create .angular-cli.json
  create e2e/app.e2e-spec.ts
  create e2e/app.po.ts
  create e2e/tsconfig.e2e.json
  create .gitignore
  create karma.conf.js
  create package.json
  create protractor.conf.js
  create tsconfig.json
  create tslint.json
Successfully initialized git.
Installing packages <span class="k">for </span>tooling via npm.
Installed packages <span class="k">for </span>tooling via npm.
You can <span class="sb">`</span>ng <span class="nb">set</span> --global <span class="nv">packageManager</span><span class="o">=</span>yarn<span class="sb">`</span>.
Project <span class="s1">'angular-okta-example'</span> successfully created.
<span class="o">[</span>mraible:~] 1m40s <span class="err">$</span>
</code></pre>
</div>

<p>This will create a new <code class="highlighter-rouge">angular-okta-example</code> directory and install all the necessary dependencies. To verify everything works, run <code class="highlighter-rouge">ng e2e</code> in a terminal window. All tests should pass and you should see results like the following.</p>

<p><img alt="Running e2e" src="/assets/img/blog/angular-sign-in-widget/e2e-success.png" style="width: 800px" /></p>

<h2 id="integrate-oktas-sign-in-widget-in-angular">Integrate Okta’s Sign-In Widget in Angular</h2>

<p>Now we’re going to leverage Okta’s Sign-In Widget for an easily customizable login view. To start, install the <a href="https://github.com/okta/okta-signin-widget">Okta Sign-In Widget</a> using npm. Note that <a href="https://github.com/okta/okta-signin-widget/issues/191">using Yarn won’t work</a>.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>npm install --save @okta/okta-signin-widget
</code></pre>
</div>

<p>Add the widget’s CSS to <code class="highlighter-rouge">src/styles.css</code>:</p>

<div class="language-css highlighter-rouge"><pre class="highlight"><code><span class="k">@import</span> <span class="s2">'~@okta/okta-signin-widget/dist/css/okta-sign-in.min.css'</span><span class="p">;</span>
<span class="k">@import</span> <span class="s2">'~@okta/okta-signin-widget/dist/css/okta-theme.css'</span><span class="p">;</span>
</code></pre>
</div>

<p>Add the widget’s JavaScript file to <code class="highlighter-rouge">.angular-cli.json</code>:</p>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="s2">"scripts"</span><span class="err">:</span><span class="w"> </span><span class="p">[</span><span class="w">
  </span><span class="s2">"../node_modules/@okta/okta-signin-widget/dist/js/okta-sign-in.min.js"</span><span class="w">
</span><span class="p">]</span><span class="err">,</span><span class="w">
</span></code></pre>
</div>

<p>Create <code class="highlighter-rouge">src/app/shared/okta/okta.service.ts</code> and use it to wrap the widget’s configuration and make it an injectable service.</p>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="kr">declare</span> <span class="kd">let</span> <span class="nx">OktaSignIn</span><span class="err">:</span> <span class="kr">any</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">Okta</span> <span class="p">{</span>
  <span class="nx">widget</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">widget</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OktaSignIn</span><span class="p">({</span>
      <span class="na">baseUrl</span><span class="p">:</span> <span class="s1">'https://dev-{YOUR-ID}.oktapreview.com'</span><span class="p">,</span>
      <span class="na">clientId</span><span class="p">:</span> <span class="s1">'{CLIENT_ID}'</span><span class="p">,</span>
      <span class="na">redirectUri</span><span class="p">:</span> <span class="s1">'http://localhost:4200'</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">getWidget</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">widget</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>To make this service available to all components in the application, modify <code class="highlighter-rouge">app.module.ts</code> and list <code class="highlighter-rouge">Okta</code> as a provider.</p>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Okta</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./shared/okta/okta.service'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">NgModule</span><span class="p">({</span>
  <span class="p">...</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">Okta</span><span class="p">],</span>
  <span class="na">bootstrap</span><span class="p">:</span> <span class="p">[</span><span class="nx">AppComponent</span><span class="p">]</span>
<span class="p">})</span>
</code></pre>
</div>

<p><em>Thanks to <a href="https://twitter.com/nraboy">Nic Raboy</a> for teaching me that it’s pretty easy to <a href="https://www.thepolyglotdeveloper.com/2017/03/javascript-libraries-in-a-typescript-application-revisited/">include JavaScript libraries in a TypeScript application</a>. The key is the <code class="highlighter-rouge">declare</code> statement in the code above.</em></p>

<p>Before this will work, you’ll need to create an OpenID Connect (OIDC) application in Okta so you can replace the <code class="highlighter-rouge"><span class="p">{</span><span class="err">YOUR_ID</span><span class="p">}</span></code> and <code class="highlighter-rouge"><span class="p">{</span><span class="err">CLIENT_ID</span><span class="p">}</span></code> references when initializing the widget.</p>

<h2 id="create-an-openid-connect-app-in-okta">Create an OpenID Connect App in Okta</h2>

<p>OpenID Connect is built on top of the OAuth 2.0 protocol. It allows clients to verify the identity of the user and, as well as to obtain their basic profile information. To learn more, see http://openid.net/connect/.</p>

<p>Login to your Okta account, or create one at <a href="http://developer.okta.com">http://developer.okta.com</a> if you don’t have one. Navigate to <strong>Admin &gt; Add Applications</strong> and click on the <strong>Create New App</strong> button. Select <strong>Single Page App (SPA)</strong> for the Platform and <strong>OpenID Connect</strong> for the sign on method. Click the <strong>Create</strong> button and give your application a name. On the next screen, add <strong>http://localhost:4200</strong> as a Redirect URI and click <strong>Finish</strong>. You should see settings like the following.</p>

<p><img alt="OIDC App Settings" src="/assets/img/blog/angular-sign-in-widget/oidc-settings.png" style="width: 800px" /></p>

<p>Click on the <strong>People</strong> tab and the <strong>Assign to People</strong> button. Assign yourself as a user, or someone else that you know the credentials for.</p>

<h2 id="show-the-sign-in-widget">Show the Sign-In Widget</h2>

<p>After making these changes, copy the your Client ID and Platform ID into <code class="highlighter-rouge">okta.service.ts</code>. Then modify <code class="highlighter-rouge">app.component.ts</code> to use the <code class="highlighter-rouge">Okta</code> service and the widget to login/logout.</p>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Okta</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./shared/okta/okta.service'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-root'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./app.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./app.component.css'</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">AppComponent</span> <span class="k">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>
  <span class="nx">title</span> <span class="o">=</span> <span class="s1">'app works!'</span><span class="p">;</span>
  <span class="nx">user</span><span class="p">;</span>
  <span class="nx">oktaSignIn</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">okta</span><span class="err">:</span> <span class="nx">Okta</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">oktaSignIn</span> <span class="o">=</span> <span class="nx">okta</span><span class="p">.</span><span class="nx">getWidget</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">showLogin</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">oktaSignIn</span><span class="p">.</span><span class="nx">renderEl</span><span class="p">({</span><span class="na">el</span><span class="p">:</span> <span class="s1">'#okta-login-container'</span><span class="p">},</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="s1">'SUCCESS'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">claims</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">oktaSignIn</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">get</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">!==</span> <span class="s1">'INACTIVE'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">login</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">showLogin</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">logout</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">oktaSignIn</span><span class="p">.</span><span class="nx">signOut</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">showLogin</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>And modify <code class="highlighter-rouge">app.component.html</code> to have a <code class="highlighter-rouge">&lt;div&gt;</code> with <code class="highlighter-rouge">id="okta-login-container"</code> and a place to show the logged in user’s email.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="err">*</span><span class="na">ngIf=</span><span class="s">"!user"</span> <span class="na">id=</span><span class="s">"okta-login-container"</span><span class="nt">&gt;&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="err">*</span><span class="na">ngIf=</span><span class="s">"user"</span><span class="nt">&gt;</span>
  Hello {{user}}

  <span class="nt">&lt;button</span> <span class="err">(</span><span class="na">click</span><span class="err">)="</span><span class="na">logout</span><span class="err">()"</span><span class="nt">&gt;</span>Logout<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>
</div>

<p>Run <code class="highlighter-rouge">ng serve</code>, and open your browser to <a href="http://localhost:4200">http://localhost:4200</a>. You should see the sign-in widget.</p>

<p><img alt="Sign-In Widget" src="/assets/img/blog/angular-sign-in-widget/sign-in-widget.png" style="width: 800px" /></p>

<p>Enter an assigned person’s credentials to login. You should see a “Hello {email}” message with a logout button.</p>

<p><img alt="Login Success" src="/assets/img/blog/angular-sign-in-widget/login-success.png" style="width: 800px" /></p>

<p><strong>NOTE:</strong> You may experience an issue where the sign-in process seems to hang. Clicking anywhere in the browser window seems to solve this problem. I’m not sure why.</p>

<p>If it works - congrats! If it doesn’t, please post a question to Stack Overflow with an <a href="http://stackoverflow.com/questions/tagged/okta">okta tag</a>, or hit me up <a href="https://twitter.com/mraible">on Twitter</a>.</p>

<h3 id="known-issues">Known Issues</h3>

<p>There are a couple of known issues in this tutorial. The first is that the widget’s CSS takes over the whole page and will override your app’s CSS. This is a <a href="https://github.com/okta/okta-signin-widget/issues/126">documented issue</a> and you can see <a href="https://github.com/okta/okta-signin-widget/issues/126#issuecomment-286530056">my comment on it</a> to learn more.</p>

<p>The other issue is that clicking the <strong>Logout</strong> button doesn’t re-render the Sign-In Widget. You can do a <code class="highlighter-rouge">location.reload()</code> after logging out, but I’m guessing there’s a better way.</p>

<p>To workaround the first issue, you can remove the global CSS files from <code class="highlighter-rouge">styles.css</code> and add CSS that only affects the widget.</p>

<h4 id="customize-the-widget-css">Customize the Widget CSS</h4>

<p>Remove the CSS <code class="highlighter-rouge">@import</code> statements to added to <code class="highlighter-rouge">src/styles.css</code>. Add an <code class="highlighter-rouge">@import</code> for <a href="https://v4-alpha.getbootstrap.com/">Bootstrap 4</a> and a few style rules to position elements. Copy the following code into <code class="highlighter-rouge">src/styles.css</code>.</p>

<div class="language-css highlighter-rouge"><pre class="highlight"><code><span class="k">@import</span> <span class="sx">url(https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css)</span><span class="p">;</span>

<span class="nf">#okta-login-container</span> <span class="p">{</span>
  <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span> <span class="nb">auto</span><span class="p">;</span>
  <span class="nl">max-width</span><span class="p">:</span> <span class="m">400px</span><span class="p">;</span>
  <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="no">silver</span><span class="p">;</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">20px</span><span class="p">;</span>
  <span class="nl">box-shadow</span><span class="p">:</span> <span class="m">5px</span> <span class="m">5px</span> <span class="m">5px</span> <span class="m">0</span> <span class="no">silver</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#okta-login-container</span> <span class="nt">input</span> <span class="p">{</span>
  <span class="nl">margin-bottom</span><span class="p">:</span> <span class="m">5px</span><span class="p">;</span>
  <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">5px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#okta-login-container</span> <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="nt">checkbox</span><span class="o">]</span> <span class="p">{</span>
  <span class="nl">width</span><span class="p">:</span> <span class="m">25px</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>After making these changes, the sign-in widget will look like the following screenshot.</p>

<p><img alt="Custom CSS" src="/assets/img/blog/angular-sign-in-widget/custom-css.png" style="width: 800px" /></p>

<h2 id="fix-your-tests">Fix Your Tests</h2>
<p>If you try to run <code class="highlighter-rouge">npm test</code> or <code class="highlighter-rouge">ng test</code>, tests will fail:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Chrome 56.0.2924 <span class="o">(</span>Mac OS X 10.11.6<span class="o">)</span>: Executed 3 of 3 <span class="o">(</span>3 FAILED<span class="o">)</span> <span class="o">(</span>0 secs / 0.181 secs<span class="o">)</span>
Chrome 56.0.2924 <span class="o">(</span>Mac OS X 10.11.6<span class="o">)</span> AppComponent should render title <span class="k">in </span>a h1 tag FAILED
	Failed: No provider <span class="k">for </span>Okta!
</code></pre>
</div>

<p>To fix this, specify <code class="highlighter-rouge">Okta</code> as a provider in <code class="highlighter-rouge">src/app/app.component.spec.ts</code>.</p>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Okta</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./shared/okta/okta.service'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'AppComponent'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(</span><span class="k">async</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">TestBed</span><span class="p">.</span><span class="nx">configureTestingModule</span><span class="p">({</span>
      <span class="na">declarations</span><span class="p">:</span> <span class="p">[</span>
        <span class="nx">AppComponent</span>
      <span class="p">],</span>
      <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">Okta</span><span class="p">]</span>
    <span class="p">}).</span><span class="nx">compileComponents</span><span class="p">();</span>
  <span class="p">}));</span>

</code></pre>
</div>

<p>After making this changes, you should see the sweet smell of success.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Chrome 56.0.2924 <span class="o">(</span>Mac OS X 10.11.6<span class="o">)</span>: Executed 3 of 3 SUCCESS <span class="o">(</span>8.562 secs / 7.479 secs<span class="o">)</span>
</code></pre>
</div>

<p>Protractor tests should still work as well. You can prove this by running <code class="highlighter-rouge">ng e2e</code> in a terminal window.</p>

<h2 id="angular--okta">Angular + Okta</h2>

<p>You can find a completed version of the application created in this blog post <a href="https://github.com/oktadeveloper/okta-angular-sign-in-widget-example">on GitHub</a>. In a future post, I’ll show you how to create a more Angular-native experience, where you control the HTML for the login form.</p>

<p>Building authentication in an application is hard. It’s even less fun to build it over and over again in each application you build. Okta does the hard part for you and makes it a lot more fun to be a developer! <a href="https://www.okta.com/developer/signup/">Sign up for a forever-free developer account and try Okta today!</a>.</p>

<p>I hope you’ve enjoyed this quick tour of our Angular support. If you have questions about Okta’s features, or what we’re building next, please hit me up <a href="https://twitter.com/mraible">on Twitter</a>, <a href="http://stackoverflow.com/questions/tagged/okta">post a question to Stack Overflow with an “okta” tag</a>, or <a href="https://github.com/oktadeveloper/okta-angular-sign-in-widget-example/issues/new">open a new issue on GitHub</a>.</p>

	  </section>
	</article>
</div>
</section>
<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2017/03/21/spring-boot-oauth">Get Started with Spring Boot, OAuth 2.0, and Okta</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-matt_raible.jpg"
	           alt="avatar-matt_raible.jpg"
	           class="author-avatar">
	      <address>Matt Raible</address>
	      &nbsp;
		  <a class="social_link" href="https://github.com/mraible"><i class="fa fa-github-square"></i></a>
		  <a class="social_link" href="https://twitter.com/mraible"><i class="fa fa-twitter-square"></i></a>
		  <a class="social_link" href="http://raibledesigns.com"><i class="fa fa-external-link-square"></i></a>
		  <span class="sepr">&middot;</span>
	      <time datetime="2017-03-21">March 21, 2017</time>
	    </div>
	  </header>
	  <section class="post-content">
	    <p>If you’re building a Spring Boot application, you’ll eventually need to add user authentication. You can do this with OAuth 2.0 (henceforth: OAuth). OAuth is a standard that applications can use to provide client applications with “secure delegated access”. It works over HTTP and authorizes devices, APIs, servers, and applications with access tokens rather than credentials.</p>

<p>Very simply, OAuth is a protocol that supports authorization workflows. It gives you a way to ensure that a specific user has specific permission.</p>

<p>OAuth doesn’t validate a user’s identity — that’s taken care of by an authentication service like Okta. Authentication is when you validate a user’s identity (like asking for a username / password to log in), whereas authorization is when you check to see what permissions an existing user already has.</p>

<p>In this tutorial you’ll build an OAuth client for a Spring Boot application, plus add authentication with the Okta Platform API. You can sign up for a <a href="https://www.okta.com/developer/signup/">forever-free Okta developer account here</a>.</p>

<p>If you don’t want to code along, feel free to grab the <a href="https://github.com/oktadeveloper/okta-spring-boot-oauth-example">source code from GitHub</a>! You can also watch a video of this tutorial below.</p>

<div style="text-align: center">
<iframe width="560" height="315" style="max-width: 100%" src="https://www.youtube.com/embed/Rix3f3k64hI" frameborder="0" allowfullscreen=""></iframe>
</div>

<h2 id="get-started-with-spring-cloud">Get Started with Spring Cloud</h2>

<p>Spring Cloud Security is a project from the good folks at Pivotal that “offers a set of primitives for building secure applications and services with minimum fuss”. Not only is it easy to use in platforms like Cloud Foundry, but it builds on Spring Boot, Spring Security, and <a href="https://www.oauth.com/">OAuth</a>. Because it builds on OAuth, it’s easy to integrate it with an authentication API like Okta’s.</p>

<p>The Spring Cloud Security project includes a <a href="https://github.com/spring-cloud/spring-cloud-security/blob/master/docs/src/main/asciidoc/quickstart.adoc">great quickstart</a> that will help you get started with very few lines of code.</p>

<h2 id="create-a-secure-spring-boot-app">Create a Secure Spring Boot App</h2>

<p>Creating a Spring Boot application is dirt simple if you use the Spring CLI. It allows you to write Groovy scripts that get rid of the boilerplate Java and build file configuration. This allows you, the developer, to focus on the necessary code. Refer to the project’s <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started-installing-spring-boot.html#getting-started-installing-the-cli">official documentation for installation instructions</a>. To install Spring CLI, I recommend using <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started-installing-spring-boot.html#getting-started-sdkman-cli-installation">SDKMAN!</a>:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sdk install springboot
</code></pre>
</div>

<p>Or <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started-installing-spring-boot.html#getting-started-homebrew-cli-installation">Homebrew</a> if you’re on a Mac.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>brew tap pivotal/tap
brew install springboot
</code></pre>
</div>

<p>Create a <code class="highlighter-rouge">helloWorld.groovy</code> file that has a Controller in it.</p>

<div class="language-groovy highlighter-rouge"><pre class="highlight"><code><span class="nd">@Grab</span><span class="o">(</span><span class="s1">'spring-boot-starter-security'</span><span class="o">)</span>
<span class="nd">@RestController</span>
<span class="kd">class</span> <span class="nc">Application</span> <span class="o">{</span>

  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s1">'/'</span><span class="o">)</span>
  <span class="n">String</span> <span class="nf">home</span><span class="o">()</span> <span class="o">{</span>
    <span class="s1">'Hello World'</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">@Grab</code> annotation invokes <a href="http://docs.groovy-lang.org/latest/html/documentation/grape.html">Grape</a> to download dependencies and having Spring Security in the classpath causes its default security rules to be used. That is, protect everything, allow a user with the username <code class="highlighter-rouge">user</code>, and generate a random password on startup for said user.</p>

<p>Run this app with the following command:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>spring run helloGroovy.groovy
</code></pre>
</div>

<p>Navigate to <a href="http://localhost:8080">http://localhost:8080</a> and you’ll be prompted to login with your browser’s basic authentication dialog. Enter <code class="highlighter-rouge">user</code> for the username and copy/paste the generated password from your console. If you copied and pasted the password successfully, you’ll see <code class="highlighter-rouge">Hello World</code> in your browser.</p>

<p><img alt="Hello World" src="/assets/img/blog/spring-boot-oauth/0-hello-world.png" style="width: 800px" /></p>

<h2 id="create-an-authorization-server-in-okta">Create an Authorization Server in Okta</h2>

<p>To start authenticating against Okta’a API, you have to first create a developer account on <a href="http://developer.okta.com">http://developer.okta.com</a>. After activating your account, sign in and navigate to <strong>Security &gt; API</strong> and click on the <strong>Add Authorization Server</strong> button.</p>

<p><img alt="Add Authorization Server" src="/assets/img/blog/spring-boot-oauth/1-add-auth-server.png" style="width: 800px" /></p>

<p>Enter the name and Resource URI of your choosing. The names aren’t important at this time. I used the following values:</p>

<ul>
  <li><strong>Name:</strong> Oktamus Prime</li>
  <li><strong>Resource URI:</strong> http://authenticat.is.easy/withokta</li>
</ul>

<p><img alt="Authorization Server Settings" src="/assets/img/blog/spring-boot-oauth/2-auth-server-settings.png" style="width: 800px" /></p>

<p>The Metadata URI you see in this screenshot will come in handy later when you need to specify <code class="highlighter-rouge">accessTokenUri</code> and <code class="highlighter-rouge">userAuthorizationUri</code> values.</p>

<h2 id="create-an-openid-connect-app-in-okta">Create an OpenID Connect App in Okta</h2>

<p>To get a client id and secret, you need to create a new OpenID Connect (OIDC) app. Navigate to <strong>Applications &gt; Add Application</strong> and click on the <strong>Create New App</strong> button. The application name isn’t important, you can use whatever you like.</p>

<p><img alt="OIDC App Name" src="/assets/img/blog/spring-boot-oauth/4-oidc-name.png" style="width: 800px" /></p>

<p>Click <strong>Next</strong> to configure OIDC. Add <code class="highlighter-rouge">http://localhost:8080</code> as a Redirect URI and click <strong>Finish</strong>.</p>

<p><img alt="OIDC Redirects" src="/assets/img/blog/spring-boot-oauth/5-redirect-uris.png" style="width: 800px" /></p>

<p>The next screen should look similar to the following screenshot.</p>

<p><img alt="OIDC Settings" src="/assets/img/blog/spring-boot-oauth/6-oidc-settings.png" style="width: 800px" /></p>

<p>Your <code class="highlighter-rouge">clientId</code> and <code class="highlighter-rouge">clientSecret</code> values for this app will be just below the fold.</p>

<h2 id="create-a-spring-boot-oauth-client">Create a Spring Boot OAuth Client</h2>

<p>Create a <code class="highlighter-rouge">helloOAuth.groovy</code> file that uses Spring Security and its <a href="https://spring.io/guides/tutorials/spring-boot-oauth2/">OAuth2 support</a>.</p>

<div class="language-groovy highlighter-rouge"><pre class="highlight"><code><span class="nd">@Grab</span><span class="o">(</span><span class="s1">'spring-boot-starter-security'</span><span class="o">)</span>
<span class="nd">@RestController</span>
<span class="nd">@EnableOAuth2Sso</span>
<span class="kd">class</span> <span class="nc">Application</span> <span class="o">{</span>

  <span class="nd">@GetMapping</span><span class="o">(</span><span class="s1">'/'</span><span class="o">)</span>
  <span class="n">String</span> <span class="nf">home</span><span class="o">()</span> <span class="o">{</span>
    <span class="s1">'Hello World'</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Adding the <code class="highlighter-rouge">@EnableOAuth2Sso</code> annotation causes Spring Security to look for a number of properties. Create <code class="highlighter-rouge">application.yml</code> in the same directory and specify the following key/value pairs.</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">security</span><span class="pi">:</span>
  <span class="s">oauth2</span><span class="pi">:</span>
    <span class="s">client</span><span class="pi">:</span>
      <span class="c1"># From OIDC app</span>
      <span class="s">clientId</span><span class="pi">:</span> <span class="c1"># clientId</span>
      <span class="s">clientSecret</span><span class="pi">:</span> <span class="c1"># clientSecret</span>
      <span class="c1"># From Authorization Server's metadata</span>
      <span class="s">accessTokenUri</span><span class="pi">:</span> <span class="c1"># token_endpoint</span>
      <span class="s">userAuthorizationUri</span><span class="pi">:</span> <span class="c1"># authorization_endpoint </span>
      <span class="s">clientAuthenticationScheme</span><span class="pi">:</span> <span class="s">form</span>
    <span class="s">resource</span><span class="pi">:</span>
      <span class="c1"># from your Auth Server's metadata, check .well-known/openid-configuration </span>
      <span class="c1"># if not in .well-known/oauth-authorization-server</span>
      <span class="s">userInfoUri</span><span class="pi">:</span> <span class="c1"># userinfo_endpoint</span>
      <span class="s">preferTokenInfo</span><span class="pi">:</span> <span class="s">false</span>
</code></pre>
</div>

<p>Start your app with <code class="highlighter-rouge">spring run helloOAuth.groovy</code> and navigate to <a href="http://localhost:8080">http://localhost:8080</a>. You’ll be redirected to Okta, but likely see the following error.</p>

<p><img alt="Bad Request, Invalid Redirect" src="/assets/img/blog/spring-boot-oauth/7-bad-request-invalid-redirect.png" style="width: 800px" /></p>

<p>This happens because Spring Security sends a <code class="highlighter-rouge">redirect_uri</code> value of <code class="highlighter-rouge">http://localhost:8080/login</code>. Navigate to your Okta developer instance and change your OIDC app to have this as a Redirect URI.</p>

<p><img alt="Add Redirect URI" src="/assets/img/blog/spring-boot-oauth/8-add-redirect-uri.png" style="width: 800px" /></p>

<p>If you hit <a href="http://localhost:8080">http://localhost:8080</a> again, this time you’ll get an error that doesn’t explain as much.</p>

<p><img alt="No Scopes" src="/assets/img/blog/spring-boot-oauth/9-no-scopes.png" style="width: 800px" /></p>

<p>The whitelabel error page doesn’t tell you anything, but your browser’s address window does: <em>no scopes were requested</em>. Modify <code class="highlighter-rouge">application.yml</code> to have a <code class="highlighter-rouge">scope</code> property at the same level as <code class="highlighter-rouge">clientAuthenticationScheme</code>. These are some standard OIDC scopes.</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code>      <span class="s">clientAuthenticationScheme</span><span class="pi">:</span> <span class="s">form</span>
      <span class="s">scope</span><span class="pi">:</span> <span class="s">openid profile email</span>
</code></pre>
</div>

<p>Try <a href="http://localhost:8080">http://localhost:8080</a> again and you’ll get an error that <em>User is not assigned to the client app</em>. Again, you’ll have to look in the address bar to see it.</p>

<p><img alt="User Not Assigned" src="/assets/img/blog/spring-boot-oauth/10-user-not-assigned.png" style="width: 800px" /></p>

<p>Open your OIDC app in Okta and <strong>Assign People</strong> to it. Adding your own account is the easiest way to do this.</p>

<p>The next error you’ll see when trying to authenticate is <em>Policy evaluation failed</em>.</p>

<p><img alt="Policy Evaluation Failure" src="/assets/img/blog/spring-boot-oauth/11-policy-evaluation-failure.png" style="width: 800px" /></p>

<p>In Okta’s UI, navigate to <strong>Security &gt; API</strong> and click on your Authorization Server’s name and <strong>Access Policies</strong>. Click <strong>Add Policy</strong> to continue.</p>

<p><img alt="Access Policies" src="/assets/img/blog/spring-boot-oauth/12-access-policies.png" style="width: 800px" /></p>

<p>Enter a name and description and set it to apply to all clients.</p>

<p><img alt="Add Policy" src="/assets/img/blog/spring-boot-oauth/13-add-policy.png" style="width: 800px" /></p>

<p>Click <strong>Create Policy</strong> to continue. Once that completes, click the <strong>Add Rule</strong> button.</p>

<p><img alt="Add Rule" src="/assets/img/blog/spring-boot-oauth/14-add-rule.png" style="width: 800px" /></p>

<p>Give the rule a name, accept the default values, and click the <strong>Create Rule</strong> button.</p>

<p><img alt="Default Grant Rules" src="/assets/img/blog/spring-boot-oauth/15-default-grant-rules.png" style="width: 800px" /></p>

<p>Try <a href="http://localhost:8080">http://localhost:8080</a> again and this time it should work. If it does - congrats!</p>

<p>You can make one additional change to the <code class="highlighter-rouge">helloOAuth.groovy</code> file to prove it’s really working: change the <code class="highlighter-rouge">home()</code> method to return <code class="highlighter-rouge">Hello $name</code> where <code class="highlighter-rouge">$name</code> is from <code class="highlighter-rouge">javax.security.Principal</code>.</p>

<div class="language-groovy highlighter-rouge"><pre class="highlight"><code><span class="nd">@GetMapping</span><span class="o">(</span><span class="s1">'/'</span><span class="o">)</span>
<span class="n">String</span> <span class="nf">home</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">Principal</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
  <span class="s1">'Hello '</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">name</span>
<span class="o">}</span>
</code></pre>
</div>

<p>This should result in your app showing a result like the following.</p>

<p><img alt="Success" src="/assets/img/blog/spring-boot-oauth/16-success.png" style="width: 800px" /></p>

<h2 id="get-the-source-code">Get the Source Code</h2>

<p>The source code for this tutorial and the examples in it are available <a href="https://github.com/oktadeveloper/okta-spring-boot-oauth-example">on GitHub</a>.</p>

<h2 id="summary">Summary</h2>

<p>This tutorial showed you how to use Spring CLI, Groovy, Spring Boot, Spring Security, and Okta to quickly prototype an OAuth client. This information is useful for those that are developing a Spring MVC application with traditional server-rendered pages. However, these days, lots of developers are using JavaScript frameworks and mobile applications to build their UIs.</p>

<p>In a future tutorial, I’ll show you how to develop one of these fancy UIs in Angular and use the access token retrieved to talk to a Spring Boot API that’s secured by Spring Security and does JWT validation.</p>


	  </section>
	</article>
</div>
</section>
<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2017/03/16/spring-boot-saml">Get Started with Spring Boot, SAML, and Okta</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-matt_raible.jpg"
	           alt="avatar-matt_raible.jpg"
	           class="author-avatar">
	      <address>Matt Raible</address>
	      &nbsp;
		  <a class="social_link" href="https://github.com/mraible"><i class="fa fa-github-square"></i></a>
		  <a class="social_link" href="https://twitter.com/mraible"><i class="fa fa-twitter-square"></i></a>
		  <a class="social_link" href="http://raibledesigns.com"><i class="fa fa-external-link-square"></i></a>
		  <span class="sepr">&middot;</span>
	      <time datetime="2017-03-16">March 16, 2017</time>
	    </div>
	  </header>
	  <section class="post-content">
	    <p>Today I’d like to show you how build a Spring Boot application that leverages Okta’s Platform API for authentication via SAML. SAML (Security Assertion Markup Language) is an XML-based standard for securely exchanging authentication and authorization information between entities—specifically between identity providers, service providers, and users. Well-known IdPs include Salesforce, Okta, OneLogin, and Shibboleth.</p>

<p>My Okta developer experience began a couple years ago (in December 2014) when I worked for a client that was adopting it. I was tasked with helping them decide on a web framework to use, so I built prototypes with Node, Ruby, and Spring. I documented my findings in <a href="https://raibledesigns.com/rd/entry/integrating_node_js_ruby_and">a blog post</a>. Along the way, <a href="https://twitter.com/mraible/status/550057304331001856">I tweeted</a> my issues with Spring Boot, and <a href="http://stackoverflow.com/questions/27713524/how-do-i-configure-spring-security-saml-to-work-with-okta?stw=2">asked how to fix it</a> on Stack Overflow. I ended up figuring out the solution through trial-and-error and my findings made it into the <a href="http://docs.spring.io/autorepo/docs/spring-security-saml/1.0.x-SNAPSHOT/reference/html/chapter-idp-guide.html#d5e1816">official Spring documentation</a><a href="http://docs.spring.io/autorepo/docs/spring-security-saml/1.0.x-SNAPSHOT/reference/html/chapter-idp-guide.html#d5e1816">.</a> Things have changed a lot since then and now Spring Security 4.2 has support for auto-loading custom DSLs. And guess what, there’s even a DSL for SAML configuration!</p>

<p>Ready to get started? You can follow along in with the written tutorial below, <a href="https://github.com/oktadeveloper/okta-spring-boot-saml-example">check out the code on GitHub</a>, or watch the screencast I made to walk you through the same process.</p>

<div style="text-align: center">
<iframe width="560" height="315" src="https://www.youtube.com/embed/JBtyGfrz-jA" frameborder="0" allowfullscreen=""></iframe>
</div>

<h2 id="sign-up-for-an-okta-developer-account">Sign Up for an Okta Developer Account</h2>

<p>Fast forward two years, and I find myself as an Okta employee. To start developing with Okta, I created a new developer account at <a href="http://developer.okta.com">http://developer.okta.com</a>. Make sure you take a screenshot or write down your Okta URL after you’ve signed up. You’ll need this URL to get back to the admin console.</p>

<p>You’ll receive an email to activate your account and change your temporary password. After completing these steps, you’ll land on your dashboard with some annotations about “apps”.</p>

<h2 id="create-a-saml-application-on-okta">Create a SAML Application on Okta</h2>

<p>At the time of this writing, the easiest way to create a SAML-aware Spring Boot application is to use Spring Security’s <a href="https://github.com/spring-projects/spring-security-saml-dsl">SAML DSL project</a>. It contains a sample project that provides <a href="https://github.com/spring-projects/spring-security-saml-dsl/blob/master/samples/spring-security-saml-dsl-sample/README.md">instructions</a> for configuring Okta as a SAML provider. These instructions will likely work for you if you’re experienced Spring Boot and Okta developer. If you’re new to both, this “start from scratch” tutorial might work better for you.</p>

<p>Just like I did, the first thing you’ll need to do is create a developer account at <a href="https://developer.okta.com">https://developer.okta.com</a>. After activating your account, login to it and click on the “Admin” button in the top right.</p>

<p><img alt="Okta UserHome" src="/assets/img/blog/spring-boot-saml/okta-userhome.png" style="width: 800px" /></p>

<p>On the next screen, click “Add Applications” in the top right.</p>

<p><img alt="Okta Dashboard" src="/assets/img/blog/spring-boot-saml/okta-dashboard.png" style="width: 800px" /></p>

<p>This will bring you to a screen with a “Create New App” green button on the left.</p>

<p><img alt="Create New App" src="/assets/img/blog/spring-boot-saml/create-new-app.png" style="width: 800px" /></p>

<p>Click the button and choose “Web” for the platform and “SAML 2.0” for the sign on method.</p>

<p><img alt="New App with SAML 2.0" src="/assets/img/blog/spring-boot-saml/new-app-saml-2.0.png" style="width: 800px" /></p>

<p>Click the “Create” button. The next screen will prompt you for an application name. I used “Spring SAML”, but any name will work.</p>

<p><img alt="Enter App name" src="/assets/img/blog/spring-boot-saml/app-name.png" style="width: 800px" /></p>

<p>Click the “Next” button. This brings you to the second step, configuring SAML. Enter the following values:</p>

<ul>
  <li>Single sign on URL: <code class="highlighter-rouge">https://localhost:8443/saml/SSO</code></li>
  <li>Audience URI: <code class="highlighter-rouge">https://localhost:8443/saml/metadata</code></li>
</ul>

<p><img alt="SAML Integration" src="/assets/img/blog/spring-boot-saml/saml-integration.png" style="width: 800px" /></p>

<p>Scroll to the bottom of the form and click “Next”. This will bring you to the third step, feedback. Choose “I’m an Okta customer adding an internal app” and optionally select the App type.</p>

<p><img alt="Customer or Partner" src="/assets/img/blog/spring-boot-saml/customer-or-partner.png" style="width: 800px" /></p>

<p>Click the “Finish” button to continue. This will bring you to the application’s “Sign On” tab which has a section with a link to your applications metadata in a yellow box. Copy the <strong>Identity Provider metadata</strong> link as you’ll need it to configure your Spring Boot application.</p>

<p><img alt="SAML Metadata" src="/assets/img/blog/spring-boot-saml/saml-metadata.png" style="width: 800px" /></p>

<p>The final setup step you’ll need is to assign people to the application. Click on the “People” tab and the “Assign to People” button. You’ll see a list of people with your account in it.</p>

<p><img alt="Assign People" src="/assets/img/blog/spring-boot-saml/assign-people.png" style="width: 800px" /></p>

<p>Click the assign button, accept the default username (your email), and click the “Done” button.</p>

<h2 id="create-a-spring-boot-application-with-saml-support">Create a Spring Boot Application with SAML Support</h2>

<p>Navigate to <a href="https://start.spring.io">https://start.spring.io</a> in your favorite browser and select Security, Web, Thymeleaf, and DevTools as dependencies.</p>

<p><img alt="start.spring.io" src="/assets/img/blog/spring-boot-saml/start.spring.png" style="width: 800px" /></p>

<p>Click “Generate Project”, download the generated ZIP file and open it in your favorite editor. Add the <code class="highlighter-rouge">spring-security-saml-dsl</code> dependency to your <code class="highlighter-rouge">pom.xml</code>.</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.security.extensions<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-security-saml-dsl<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0.0.M3<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre>
</div>

<p>You’ll also need to add the Spring Milestone repository since a milestone release is all that’s available at the time of this writing.</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;repositories&gt;</span>
    <span class="nt">&lt;repository&gt;</span>
        <span class="nt">&lt;id&gt;</span>spring-milestones<span class="nt">&lt;/id&gt;</span>
        <span class="nt">&lt;name&gt;</span>Spring Milestones<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;url&gt;</span>https://repo.spring.io/libs-milestone<span class="nt">&lt;/url&gt;</span>
    <span class="nt">&lt;/repository&gt;</span>
<span class="nt">&lt;/repositories&gt;</span>
</code></pre>
</div>

<p>If you’d like to see instructions for Gradle, please view the project’s <a href="https://github.com/spring-projects/spring-security-saml-dsl/blob/master/README.md">README.md</a>.</p>

<p>In <code class="highlighter-rouge">src/main/resources/application.properties</code>, add the following key/value pairs. Make sure to use the “Identity Provider metadata” value you copied earlier (hint: you can find it again under the “Sign On” tab in your Okta application).</p>

<div class="highlighter-rouge"><pre class="highlight"><code>server.port = 8443
server.ssl.enabled = true
server.ssl.key-alias = spring
server.ssl.key-store = src/main/resources/saml/keystore.jks
server.ssl.key-store-password = secret

security.saml2.metadata-url = &lt;your metadata url&gt;
</code></pre>
</div>

<p>From a terminal window, navigate to the <code class="highlighter-rouge">src/main/resources</code> directory of your app and create a <code class="highlighter-rouge">saml</code> directory. Navigate into the directory and run the following command. Use “secret” when prompted for a keystore password.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>keytool -genkey -v -keystore keystore.jks -alias spring -keyalg RSA -keysize 2048 -validity 10000
</code></pre>
</div>

<p>The values for the rest of the questions don’t matter since you’re not generating a real certificate. However, you will need to answer “yes” to the following question.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Is <span class="nv">CN</span><span class="o">=</span>Unknown, <span class="nv">OU</span><span class="o">=</span>Unknown, <span class="nv">O</span><span class="o">=</span>Unknown, <span class="nv">L</span><span class="o">=</span>Unknown, <span class="nv">ST</span><span class="o">=</span>Unknown, <span class="nv">C</span><span class="o">=</span>Unknown correct?
  <span class="o">[</span>no]:
</code></pre>
</div>

<p>Create a <code class="highlighter-rouge">SecurityConfiguration.java</code> file in the <code class="highlighter-rouge">com.example</code> package.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">extensions</span><span class="o">.</span><span class="na">saml2</span><span class="o">.</span><span class="na">config</span><span class="o">.</span><span class="na">SAMLConfigurer</span><span class="o">.</span><span class="na">saml</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.EnableWebSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</span><span class="o">;</span>

<span class="nd">@EnableWebSecurity</span>
<span class="nd">@Configuration</span>
<span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityConfiguration</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${security.saml2.metadata-url}"</span><span class="o">)</span>
    <span class="n">String</span> <span class="n">metadataUrl</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${server.ssl.key-alias}"</span><span class="o">)</span>
    <span class="n">String</span> <span class="n">keyAlias</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${server.ssl.key-store-password}"</span><span class="o">)</span>
    <span class="n">String</span> <span class="n">password</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${server.port}"</span><span class="o">)</span>
    <span class="n">String</span> <span class="n">port</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${server.ssl.key-store}"</span><span class="o">)</span>
    <span class="n">String</span> <span class="n">keyStoreFilePath</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="kd">final</span> <span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">http</span>
            <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/saml*"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
            <span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">saml</span><span class="o">())</span>
                <span class="o">.</span><span class="na">serviceProvider</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">keyStore</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">storeFilePath</span><span class="o">(</span><span class="s">"saml/keystore.jks"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">password</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">keyname</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">keyAlias</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">keyPassword</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">password</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">and</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">protocol</span><span class="o">(</span><span class="s">"https"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">hostname</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s:%s"</span><span class="o">,</span> <span class="s">"localhost"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">port</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">basePath</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">and</span><span class="o">()</span>
                <span class="o">.</span><span class="na">identityProvider</span><span class="o">()</span>
                <span class="o">.</span><span class="na">metadataFilePath</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">metadataUrl</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Create an <code class="highlighter-rouge">IndexController.java</code> file in the same directory and use it to set the default view to <code class="highlighter-rouge">index</code>.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>

<span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexController</span> <span class="o">{</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">index</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"index"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Since you chose Thymeleaf when creating your application, you can create a <code class="highlighter-rouge">src/main/resources/templates/index.html</code> and it will automatically be rendered after you sign-in. Create this file and populate it with the following HTML.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Spring Security SAML Example<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
Hello SAML!
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>

<h2 id="run-the-app-and-login-with-okta">Run the App and Login with Okta</h2>

<p>Start the app using your IDE or <code class="highlighter-rouge">mvn spring-boot:run</code> and navigate to <a href="https://localhost:8443">https://localhost:8443</a>. If you’re using Chrome, you’ll likely see a privacy error.</p>

<p><img alt="Connection Not Private" src="/assets/img/blog/spring-boot-saml/connection-not-private.png" style="width: 800px" /></p>

<p>Click the “ADVANCED” link at the bottom. Then click the “proceed to localhost (unsafe)” link.</p>

<p><img alt="Proceed to localhost" src="/assets/img/blog/spring-boot-saml/connection-not-private-proceed.png" style="width: 800px" /></p>

<p>Next, you’ll be redirected to Okta to sign in and redirected back to your app. If you’re already logged in, you won’t see anything from Okta. If you sign out from Okta, you’ll see a login screen such as the one below.</p>

<p><img alt="Okta Login" src="/assets/img/blog/spring-boot-saml/okta-login.png" style="width: 800px" /></p>

<p>After you’ve logged in, you should see a screen like the one below.</p>

<p><img alt="Hello SAML" src="/assets/img/blog/spring-boot-saml/hello-saml.png" style="width: 800px" /></p>

<h2 id="source-code">Source Code</h2>

<p>You can find the source code for this article at <a href="https://github.com/oktadeveloper/okta-spring-boot-saml-example">https://github.com/oktadeveloper/okta-spring-boot-saml-example</a>.</p>

<h2 id="learn-more">Learn More</h2>

<p>This article showed you how to create a SAML application in Okta and talk to it using Spring Boot and Spring Security’s SAML extension. The SAML extension hasn’t had a GA release, but hopefully will soon. I also believe it’s possible to take the SAML DSL (in <code class="highlighter-rouge">SecurityConfiguration.java</code>) and create a Spring Boot starter that allows you to get started with SAML simply by configuring application properties.</p>

<p>Have questions or comments? Post your question to Stack Overflow with the “<a href="http://stackoverflow.com/questions/tagged/okta">okta</a>” or “<a href="http://stackoverflow.com/questions/tagged/okta-api">okta-api</a>” tag, hit me up via email at <a href="mailto:matt.raible@okta.com">matt.raible@okta.com</a>, or ping me on Twitter <a href="https://twitter.com/mraible">@mraible</a>. In future articles, I’ll show you to to configure Spring Boot with OAuth 2.0 and Okta. Then I’ll explore different techniques of authenticating with Angular and using the access token to talk to a secured Spring Boot application. Until then, happy authenticating! 😊</p>

<p><strong>Update:</strong> Thanks to <a href="https://github.com/AlexeySoshin">Alexey Soshin</a> for contributing a <a href="https://github.com/oktadeveloper/okta-spring-boot-saml-example/pull/2">pull request</a> to make the code in this blog post more bootiful!</p>


	  </section>
	</article>
</div>
</section>
<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2016/03/22/use-kentor-authservices-with-okta">How to use KentorIT AuthServices with Okta</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-raphael.jpg"
	           alt="avatar-raphael.jpg"
	           class="author-avatar">
	      <address>Raphael Londner</address>
	      &nbsp;
		  <a class="social_link" href="https://github.com/rlondner"><i class="fa fa-github-square"></i></a>
		  <a class="social_link" href="https://twitter.com/rlondner"><i class="fa fa-twitter-square"></i></a>
		  <a class="social_link" href="https://www.linkedin.com/in/londner"><i class="fa fa-external-link-square"></i></a>
		  <span class="sepr">&middot;</span>
	      <time datetime="2016-03-22">March 22, 2016</time>
	    </div>
	  </header>
	  <section class="post-content">
	    <p>If you’re wondering how to configure an ASP.NET application with <a href="https://github.com/KentorIT/authservices">KentorIT’s AuthServices</a> and Okta, you’ve come to the right place. But before delving into the specifics of how to make Okta work with an SAML-enabled ASP.NET application powered by KentorIT AuthServices, is is worth spending some time going over a critical, but easily fixable issue:</p>

<p><strong>Important note</strong> : As of March 22nd, 2016, you have 2 choices:</p>

<ol>
  <li>
    <p>Either get the source code of the AuthServices assemblies and compile them on your own machine. In this case, no specific adjustment is necessary.</p>
  </li>
  <li>
    <p>Or use the v0.17 KentorIT NuGet assemblies. In this case, if you plan to use the SampleApplication project (not the SampleMvcApplication) for testing purposes, make sure you remove the following line from the web.config file:</p>

    <p><code class="highlighter-rouge">&lt;requestedAuthnContextclassRef="Password" comparison="Minimum" /&gt;</code></p>

    <p>If you don’t, the SP-initiated login flow will fail because Okta won’t manage to deserialize the SAMLRequest parameter (due to a case issue).</p>
  </li>
</ol>

<p>Here’s how you should configure an app powered by Kentor AuthServices to make it work with Okta:</p>

<ol>
  <li>Download the latest version of KentorIT’s AuthServices from <a href="https://github.com/KentorIT/authservices">https://github.com/KentorIT/authservices</a> and open the Kentor.AuthServices.sln solution in Visual Studio.</li>
  <li>Identify the SampleApplication project and make a note of its URL property:
  <img src="/assets/img/KentorOkta/VSProjectProperties.png" alt="Visual Studio Project properties" /></li>
  <li>Go to you Okta organization and navigate to Admin =&gt; Applications.</li>
  <li>Press the <strong>Add Application</strong> button and the green <strong>Create New App</strong> button
  <img src="/assets/img/KentorOkta/CreateNewAppButton.png" alt="Press the Create a new Okta app" /></li>
  <li>Select the <strong>SAML 2.0</strong> option and press the <strong>Create</strong> button.
  <img src="/assets/img/KentorOkta/SAML2Option.png" alt="Choose the SAML 2.0 template" /></li>
  <li>Give your application a name and optionally upload a custom logo. We’ll call it “<strong>Kentor AuthServices App 1</strong>”
  <img src="/assets/img/KentorOkta/OktaAppName.png" alt="Give your Okta app a name" /></li>
  <li>Press <strong>Next</strong>.</li>
  <li>In the <strong>Single sign on URL</strong> field, enter the url you retrieved above in step #2 and append “ <strong>/AuthServices/Acs</strong>”, for instance <strong>http://localhost:18714/SamplePath/AuthServices/Acs</strong></li>
  <li>For the Audience URI field, enter the Url you retrieved above in step #2 and append “ <strong>/AuthServices</strong>”, for instance <strong>http://localhost:18714/SamplePath/AuthServices</strong></li>
  <li>In the <strong>Name ID format</strong> field, select the default <strong>Unspecified</strong> (or select any other value of your choice).</li>
  <li>
    <p>Select the <strong>Show Advanced Settings</strong> link. For the <strong>Signature Algorithm</strong> field, we suggest that you leave the default value, SHA-256. However, if you do, you will need to add the following line of code to the Application_Start() method of your Global.asax.cs file:</p>

    <p><code class="highlighter-rouge">Kentor.AuthServices.Configuration.Options.GlobalEnableSha256XmlSignatures();</code></p>

    <p>Otherwise, you may switch to RSA-SHA1 though we do not recommend it (as it less secure than SHA-256).</p>
  </li>
  <li>In the Attribute Statements section, optionally enter additional attributes, such as in the following screenshot:
  <img src="/assets/img/KentorOkta/OptionalAttributeStatements.png" alt="Optional Attribute Statements" /></li>
  <li>Press the <strong>Next</strong> button. Select the <strong>I’m a software vendor</strong> option (if you’re indeed a vendor - if you are developing an internal app, select the first option) and press the Finish button.
  <img src="/assets/img/KentorOkta/VendorOrCustomerOption.png" alt="Select the customer or vendor option" /></li>
  <li>Now edit the web.config file of the SampleApplication project.</li>
  <li>In the <code class="highlighter-rouge">&lt;kentor.authServices&gt;</code> section, enter the following values:
    <ul>
      <li><strong>entityId</strong> = same value as the Audience URI for the Okta app, e.g. <a href="http://localhost:18714/SamplePath/AuthServices">http://localhost:18714/SamplePath/AuthServices</a></li>
      <li><strong>returnUrl</strong> = value of the web application’s url, i.e. <a href="http://localhost:18714/SamplePath">http://localhost:18714/SamplePath</a></li>
    </ul>
  </li>
  <li>In the <identityProviders> section, enter the following values:
</identityProviders>    <ul>
      <li><strong>entityId</strong> = <strong>Identity Provider Issuer</strong> from <strong>Sign On</strong> =&gt; <strong>View Setup Instructions</strong>
<img src="/assets/img/KentorOkta/ViewSetupInstructions.png" alt="View setup instructions" />
<img src="/assets/img/KentorOkta/IdentityProviderIssuer.png" alt="Identity Provider Issuer" /></li>
      <li><strong>signOnUrl</strong> = value of the <strong>Identity Provider Single Sign-On URL</strong> below
<img src="/assets/img/KentorOkta/IdPSSOUrl.png" alt="Identity Provider Single Sign-On URL" /></li>
      <li>In the <code class="highlighter-rouge">&lt;signingCertificate&gt;</code> section, download the <strong>okta.cert</strong> X.509 certificate from the instructions page in the Okta app and put it in the <strong>App_Data</strong> folder of your web application. Then reference it accordingly (such as with <strong>fileName=”~/App_Data/okta.cert</strong>”) in the web.config file.</li>
    </ul>
  </li>
</ol>

<p>You should be good to go now! Don’t forget to assign users to your Okta application and test that you can sign in into your SAML application both from the Okta portal (IdP-initiated sign-in flow) and from your SAML application itself (SP-initiated sign-in flow).</p>

<p>If you run into any issue while using the SP-initiated login flow (when a user clicks on the “Sign In” link of the /SamplePath page), then try to recompile the KentorIT.AuthServices project and make sure it is used by your project. If your project uses v0.17 of the NuGet corresponding library, make sure to comment out any <code class="highlighter-rouge">&lt;requestedAuthnContext &gt;</code> section in your web.config file.</p>

<p><strong>Happy Okta’ing!</strong></p>

	  </section>
	</article>
</div>
</section>
<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2016/01/05/rest-service-auth-jwt">REST Service Authorization with JWTs</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-jon_todd.jpg"
	           alt="avatar-jon_todd.jpg"
	           class="author-avatar">
	      <address>Jon Todd</address>
	      &nbsp;
		  <a class="social_link" href="https://github.com/jontodd"><i class="fa fa-github-square"></i></a>
		  <a class="social_link" href="https://twitter.com/jonrtodd"><i class="fa fa-twitter-square"></i></a>
		  <a class="social_link" href="http://www.jontodd.com"><i class="fa fa-external-link-square"></i></a>
		  <span class="sepr">&middot;</span>
	      <address>William Dawson</address>
	      &nbsp;
		  <a class="social_link" href="https://github.com/wdawson"><i class="fa fa-github-square"></i></a>
		  <a class="social_link" href="https://twitter.com/wilsdawson"><i class="fa fa-twitter-square"></i></a>
	 	  <a class="social_link" href="https://linkedin.com/in/wilsdawson"><i class="fa fa-linkedin-square"></i></a>
		  <span class="sepr">&middot;</span>
	      <time datetime="2016-01-05">January 5, 2016</time>
	    </div>
	  </header>
	  <section class="post-content">
	    <p>Many companies are adopting micro-services based architectures to promote
decoupling and separation of concerns in their applications. One inherent
challenge with breaking applications up into small services is that now each
service needs to deal with authenticating and authorizing requests made to it.
<a href="https://tools.ietf.org/html/rfc7519">Json Web Tokens (JWTs)</a> offer a clean
solution to this problem along with
<a href="/blog/2015/12/02/tls-client-authentication-for-services">TLS client authentication</a>
lower down in the stack.</p>

<p>Wils Dawson and I presented these topics to the <a href="http://www.meetup.com/sfjava/">Java User Group</a>
at Okta’s HQ in December and are thrilled to offer the
<a href="http://www.slideshare.net/JonTodd1/rest-service-authetication-with-tls-jwts">slides</a>,
<a href="https://github.com/wdawson/dropwizard-auth-example">code</a>, and the following
recording of the presentation. In the talk, we cover authentication and
authorization both at a server level with TLS and a user level with OAuth 2.0.
In addition, we explain claims based auth and federation while walking through
demos for these concepts using Java and Dropwizard. We purposely skipped over
client (e.g. browser) side authentication as it’s enough material for a future
talk and focused on solutions for authentication and authorization between
services within an application.</p>

<iframe src="https://player.vimeo.com/video/150714428" width="500" height="281" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>

	  </section>
	</article>
</div>
</section>
<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2015/12/07/oauth">Demystifying OAuth</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-karl.png"
	           alt="avatar-karl.png"
	           class="author-avatar">
	      <address>Karl McGuinness</address>
	      &nbsp;
		  <a class="social_link" href="https://github.com/mcguinness"><i class="fa fa-github-square"></i></a>
		  <a class="social_link" href="https://twitter.com/jankytweet"><i class="fa fa-twitter-square"></i></a>
		  <a class="social_link" href="https://www.linkedin.com/in/karlmcguinness"><i class="fa fa-external-link-square"></i></a>
		  <span class="sepr">&middot;</span>
	      <time datetime="2015-12-07">December 7, 2015</time>
	    </div>
	  </header>
	  <section class="post-content">
	    <p>It seems that OAuth 2.0 is everywhere these days. Whether you are building a hot new single page web application (SPA), a native mobile experience, or just trying to integrate with the API economy, you can’t go far without running into the popular authorization framework for REST/APIs and social authentication.</p>

<p>During <a href="https://www.okta.com/oktane15/">Oktane15</a>, <a href="https://www.linkedin.com/in/karlmcguinness">Karl McGuinness</a>, our Senior Director of Identity, demystified the powerful, yet often misunderstood, world of OAuth 2.0 and shared details on Okta’s growing support for <a href="http://openid.net/connect/">OpenID Connect</a>.</p>

<p><a href="http://www.slideshare.net/karl_mcguinness/demystifying-oauth-20">Slides</a></p>

<iframe src="https://player.vimeo.com/video/148164438" width="500" height="281" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>

	  </section>
	</article>
</div>
</section>
<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2015/12/02/tls-client-authentication-for-services">TLS Client Authentication for Internal Services</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-william_dawson.jpg"
	           alt="avatar-william_dawson.jpg"
	           class="author-avatar">
	      <address>William Dawson</address>
	      &nbsp;
		  <a class="social_link" href="https://github.com/wdawson"><i class="fa fa-github-square"></i></a>
		  <a class="social_link" href="https://twitter.com/wilsdawson"><i class="fa fa-twitter-square"></i></a>
	 	  <a class="social_link" href="https://linkedin.com/in/wilsdawson"><i class="fa fa-linkedin-square"></i></a>
		  <span class="sepr">&middot;</span>
	      <time datetime="2015-12-02">December 2, 2015</time>
	    </div>
	  </header>
	  <section class="post-content">
	    <p>If you’re like me, the most aggravating thing is finding a Stack Overflow
question that exactly describes the issue you are facing, only to scroll down
and see that it has remained unanswered since 2011. I was recently trying to
configure Transport Layer Security (TLS) <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#Client-authenticated_TLS_handshake">client
authentication</a>
(also referred to as mutual SSL) between two internal services at Okta and
found the lack of complete examples astonishing. I hope that this blog post
provides a better understanding of how to accomplish client authentication in
your applications and makes all that hard security stuff a bit easier.</p>

<h2 id="tls-background">TLS Background</h2>

<p>In a normal TLS handshake, the server sends its certificate to the client so
that the client can verify the authenticity of the server. It does this by
following the certificate chain that issued the server’s certificate until it
arrives at a certificate that it trusts. If the client reaches the end of the
chain without finding a certificate that it trusts, it will reject the
connection. For an example of what a server might send, see <a href="https://gist.github.com/jpf/9282d558bcc105ae8e1a">this
gist</a>.</p>

<p style="text-align: center"><img src="/assets/img/2015-10-29-tls-client-authentication-for-services-tls-handshake.png" alt="TLS handshake" width="540px" /></p>

<p style="text-align: center;font-size: x-small;">Image reprinted with permission from
<a href="https://blog.cloudflare.com/protecting-the-origin-with-tls-authenticated-origin-pulls/">CloudFlare</a></p>

<p>In mutual SSL, the client also sends its certificate to the server
for the server to authenticate along with an additional message (called the
CertificateVerify message), which assures the server that the client is the true
owner of the certificate. The server follows the same process of checking the
certificate chain until it finds one it trusts, refusing the connection if it
can’t find such a certificate.</p>

<p>So why is that useful? You probably interact with typical TLS all the time in
your browser. For example, when you visit <a href="https://www.okta.com">https://www.okta.com</a>, your browser
is verifying that the server serving Okta’s site is authentic (that it’s not
impersonating a legitimate Okta server). But Okta’s server has no idea who your
browser is. In this case it doesn’t care too much, so it lets you connect.</p>

<p>When we start talking about services talking to each other, authenticating the
client becomes important because it lowers the risk of our servers divulging
information to machines impersonating our services. For example, let’s say we
have a service called the User Service that holds all the information about
users in our application. We have another service called the Home Page Service
that serves up the home page to the browser. The home page has the user’s name,
email, phone number, and other personal information. The Home Page Service needs
to talk to the User Service to get the user’s name to display on the page. In
this case, the Home Page Service is the client and the User Service is the
server. If we only used normal TLS, only the User Service would be
authenticated! We need TLS client authentication to make sure the User Service
doesn’t provide data to a random client.</p>

<h2 id="implementing-tls-client-authentication">Implementing TLS Client Authentication</h2>

<p>In our case, the client and server are internal services communicating with each
other. I won’t cover configuring a browser client or other clients that may be
not under your control. In this post, I’ll give examples for the technology we
use at Okta. Specifically, we use <a href="http://www.dropwizard.io/">Dropwizard</a> as
the server framework and <a href="https://jersey.java.net/">Jersey</a> for the client
framework. We’ll also use Java’s
<a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/keytool.html">keytool</a>
for building the key and trust stores in Java KeyStore (JKS) format. The
examples below use these technologies, but I hope they’ll be fairly transferable
to choices you make in your applications. In addition, these samples are not
meant to be complete, so you may need to modify them to fit in your environment.</p>

<h3 id="certificates-and-key-stores">Certificates and Key Stores</h3>

<p style="text-align: center"><img src="/assets/img/2015-10-29-tls-client-authentication-for-services-ca-chain.png" alt="CA heirarchy" width="540px" /></p>

<p>First, let’s setup our trust store, which is just a key store that will only
contain certificates. Let’s assume we have a layered Certificate Authority (CA)
structure, like the image above, with a root CA and a subordinate global CA. The
root CA has its private key stored offline and its certificate is the one we
want our services to trust. The root certificate is the <em>only</em> certificate we
want our services to trust on that channel. We don’t even want a certificate
issued by a reputable 3rd party CA to be trusted by our service. So our trust
store will contain only the root certificate, which means the server will only
establish connections from clients that have a certificate issued by the root CA
or its child, the global CA, which will be the issuer of our server’s
certificate. This way, it’s quite easy to rotate our server’s certificate,
either when it expires or if it is somehow compromised; we can just change it on
that service and don’t have to worry about the other services it communicates
with losing trust because they trust the root. If all our services trusted each
other explicitly, the rotation would be much more difficult, especially if you
can’t take downtime. We’ll use the trust store for both the client and the
server, so you only need to make one, which you can copy if you need to.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c"># Import your root certificate into a new trust store and follow the prompts</span>
keytool -import -alias root -file root.crt -keystore truststore.jks
</code></pre>
</div>

<p>Now that we’ve set up trust, we want to issue the certificate for our service
that chains up to the root. We’ll use the global CA to issue our server its
certificate, and since the global CA’s certificate is issued by the root CA,
we have a chain of trust. When we create the server’s certificate, we’ll include
the chain as well for clients to verify. The <a href="http://tools.ietf.org/html/rfc5246#section-7.4.2">TLS
standard</a> specifies that the
certificate chain does not require the actual root of trust since the endpoints
will have it already, so we’ll omit it to save bandwidth. Once we have the
certificate we’ll put it in a JKS for our Dropwizard application to use. If
your client does not have a certificate for service-to-service communication,
you can follow a similar pattern to create its certificate. But if it does have
an existing certificate, you can just reuse that one.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c"># Create our server's key</span>
openssl genrsa -out server.key 2048

<span class="c"># Create the csr and follow the prompts for country code, ou, etc</span>
openssl req -new -key server.key -sha256 -out server.csr

<span class="c"># Sign the csr with your CA</span>
openssl ca -in server.csr -days 365 -config my-ca-conf.cnf -out server.crt

<span class="c"># Cat the cert chain together (except the root)</span>
cat server.crt global.crt &gt; chain.crt

<span class="c"># Create pkcs12 file for key and cert chain</span>
openssl pkcs12 -export -name server-tls -in chain.crt -inkey server.key -out server.p12

<span class="c"># Create JKS for server</span>
keytool -importkeystore -destkeystore keystore.jks -srckeystore server.p12 -srcstoretype pkcs12 -alias server-tls
</code></pre>
</div>

<h3 id="server-configuration">Server Configuration</h3>

<p>Now that we have our key and trust stores, let’s configure the server’s
Dropwizard application connector.</p>

<div class="language-conf highlighter-rouge"><pre class="highlight"><code><span class="n">server</span>:
  <span class="n">applicationConnectors</span>:
    - <span class="n">type</span>: <span class="n">https</span>
    <span class="n">port</span>: <span class="m">8443</span>

    <span class="c"># Key store settings
</span>    <span class="n">keyStorePath</span>: <span class="n">path</span>/<span class="n">to</span>/<span class="n">keystore</span>.<span class="n">jks</span>
    <span class="n">keyStorePassword</span>: <span class="s2">"notsecret"</span>
    <span class="n">certAlias</span>: <span class="n">server</span>-<span class="n">tls</span>
    <span class="n">enableCRLDP</span>: <span class="n">true</span>

    <span class="c"># Trust store settings
</span>    <span class="n">trustStorePath</span>: <span class="n">path</span>/<span class="n">to</span>/<span class="n">truststore</span>.<span class="n">jks</span>
    <span class="n">trustStorePassword</span>: <span class="s2">"notsecret"</span>

    <span class="c"># Fail fast at startup if the certificates are invalid
</span>    <span class="n">validateCerts</span>: <span class="n">true</span>

    <span class="c"># Whether or not to require authentication by peer certificate.
</span>    <span class="n">needClientAuth</span>: <span class="n">true</span>

    <span class="c"># Check peer certificates for validity when establishing a connection
</span>    <span class="n">validatePeers</span>: <span class="n">true</span>

    <span class="c"># The list of supported SSL/TLS protocols. You may need to modify
</span>    <span class="c"># this section to support clients that you have.
</span>    <span class="n">supportedProtocols</span>: [<span class="s2">"TLSv1.2"</span>]
    <span class="n">supportedCipherSuites</span>: [<span class="s2">"TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"</span>]
    <span class="n">allowRenegotiation</span>: <span class="n">false</span>
</code></pre>
</div>

<p style="text-align: center;font-size: x-small;">Dropwizard code is Copyright © 2010-2013 Coda Hale, Yammer Inc., 2014-2015 Dropwizard Team and/or its affiliates.
<a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache 2.0</a>.</p>

<p>That was pretty easy, huh? No cryptic OpenSSL commands! Now our server should be
configured to refuse connections from clients not presenting a root issued
certificate chain. We can test to make sure that happens! We can start our
server, telling Java to debug the SSL handshakes, and make sure we see it
refusing the connection for the right reason. In one terminal start the
Dropwizard server debugging SSL.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>java -Djavax.net.debug<span class="o">=</span>SSL,keymanager,trustmanager -jar your/jar.jar server config.yml
</code></pre>
</div>

<p>In another terminal run the following curl commands and verify you get the
expected results. First, make sure that the server does not talk HTTP over our
port.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl localhost:443
curl: <span class="o">(</span>52<span class="o">)</span> Empty reply from server

<span class="c"># The server should print something like the following because of no TLS:</span>
<span class="c"># javax.net.ssl.SSLException: Unrecognized SSL message, plaintext connection?</span>
</code></pre>
</div>

<p>Next, check that the server is sending your certificate back over HTTPS.
curl has a preconfigured list of trusted certs and chances are your
root certificate is not in there.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl https://localhost:443
curl: <span class="o">(</span>60<span class="o">)</span> SSL certificate problem: Invalid certificate chain

<span class="c"># The server will print a bunch of stuff ending with something like:</span>
<span class="c"># javax.net.ssl.SSLException: Received close_notify during handshake</span>
</code></pre>
</div>

<p>Finally, ensure that the server terminates the connection if no client cert is
provided.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -k https://localhost:443
curl: <span class="o">(</span>35<span class="o">)</span> Server aborted the SSL handshake

<span class="c"># The server will, again, print a bunch of stuff ending with something like:</span>
<span class="c"># javax.net.ssl.SSLHandshakeException: null cert chain</span>
</code></pre>
</div>

<h3 id="client-configuration">Client Configuration</h3>

<p>Now we’ll configure our client to talk to the server. I’ll use the Jersey 2.X
API, but there are equivalents in the 1.X as well as in the Apache HTTP library.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="c1">// Assume the following variables are initialized already</span>
<span class="n">String</span> <span class="n">password</span><span class="o">;</span>
<span class="n">RSAPrivateKey</span> <span class="n">clientKey</span><span class="o">;</span>
<span class="n">X509Certificate</span> <span class="n">clientCert</span><span class="o">;</span>
<span class="n">X509Certificate</span> <span class="n">globalCert</span><span class="o">;</span>
<span class="n">X509Certificate</span> <span class="n">rootCert</span><span class="o">;</span>

<span class="n">X509Certificate</span><span class="o">[]</span> <span class="n">certChain</span> <span class="o">=</span> <span class="o">{</span><span class="n">clientCert</span><span class="o">,</span> <span class="n">globalCert</span><span class="o">};</span>

<span class="c1">// setup key store</span>
<span class="n">KeyStore</span> <span class="n">clientKeyStore</span> <span class="o">=</span> <span class="n">KeyStore</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"JKS"</span><span class="o">);</span>
<span class="n">clientKeyStore</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">password</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">());</span>
<span class="n">clientKeyStore</span><span class="o">.</span><span class="na">setKeyEntry</span><span class="o">(</span><span class="s">"service-tls"</span><span class="o">,</span> <span class="n">clientKey</span><span class="o">,</span> <span class="n">password</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">(),</span> <span class="n">certChain</span><span class="o">);</span>

<span class="c1">// setup trust store</span>
<span class="n">KeyStore</span> <span class="n">clientTrustStore</span> <span class="o">=</span> <span class="n">KeyStore</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"JKS"</span><span class="o">);</span>
<span class="n">clientTrustStore</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">password</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">());</span>
<span class="n">clientTrustStore</span><span class="o">.</span><span class="na">setCertificateEntry</span><span class="o">(</span><span class="s">"root-ca"</span><span class="o">,</span> <span class="n">rootCert</span><span class="o">);</span>

<span class="c1">// setup Jersey client</span>
<span class="n">SslConfigurator</span> <span class="n">sslConfig</span> <span class="o">=</span> <span class="n">SslConfigurator</span><span class="o">.</span><span class="na">newInstance</span><span class="o">()</span>
        <span class="o">.</span><span class="na">keyStore</span><span class="o">(</span><span class="n">clientKeyStore</span><span class="o">)</span>
        <span class="o">.</span><span class="na">keyStorePassword</span><span class="o">(</span><span class="n">password</span><span class="o">)</span>
        <span class="o">.</span><span class="na">keyPassword</span><span class="o">(</span><span class="n">password</span><span class="o">)</span>

        <span class="o">.</span><span class="na">trustStore</span><span class="o">(</span><span class="n">clientTrustStore</span><span class="o">)</span>
        <span class="o">.</span><span class="na">trustStorePassword</span><span class="o">(</span><span class="n">password</span><span class="o">)</span>

        <span class="o">.</span><span class="na">securityProtocol</span><span class="o">(</span><span class="s">"TLSv1.2"</span><span class="o">);</span>

<span class="n">SSLContext</span> <span class="n">sslContext</span> <span class="o">=</span> <span class="n">sslConfig</span><span class="o">.</span><span class="na">createSSLContext</span><span class="o">();</span>
<span class="n">Client</span> <span class="n">client</span> <span class="o">=</span> <span class="n">ClientBuilder</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">sslContext</span><span class="o">(</span><span class="n">sslContext</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</code></pre>
</div>

<p style="text-align: center;font-size: x-small;">Jersey code is Copyright © 2010-2015 Oracle and/or its affiliates.
<a href="https://jersey.java.net/license.html">GPL 2.0 Selected</a>.</p>

<p>Hooray authentication!</p>

<p style="text-align: center"><a href="https://xkcd.com/1121/"><img src="http://imgs.xkcd.com/comics/identity.png" alt="xkcd-identity" /></a></p>

<p style="text-align: center;font-size: x-small;">Comic is Copyright © <a href="https://xkcd.com">xkcd.com</a>.
<a href="http://creativecommons.org/licenses/by-nc/2.5/">CC BY-NC 2.5</a>.</p>

<h2 id="tightening-things-up">Tightening Things Up</h2>

<p>Now we are just granting any service with a certificate signed by our root CA to
talk to our server. Chances are we’d like to trim this down to only clients that
should be talking to the server so we can refuse some other service that has
no business with our server even though it has a certificate issued by our root
CA. This is useful for preventing another service we have from accessing our new
service. For example, suppose in addition to a User Service and a Home Page
Service, we have an Event Service. We may want to block the Event Service from
communicating with the User Service while allowing the Home Page Service to do
that communication.</p>

<p>To accomplish this, we could change our server’s trust store to only contain the
public key of the client, but this presents problems (and more work) when we try
to rotate that key pair. So, instead, let’s try having the server check that the
hostname of the client is one that it expects to hear from. We can also do this
in the other direction (client verifying the server).</p>

<p>Several options exist for verifying the hostname on the server side. The first
is one that Dropwizard supports this verification with a tricky configuration
change for the underlying Java SSL connection.</p>

<div class="language-conf highlighter-rouge"><pre class="highlight"><code><span class="n">server</span>:
  <span class="n">applicationConnectors</span>:
    - <span class="n">type</span>: <span class="n">https</span>
      <span class="c">#...
</span>      <span class="n">endpointIdentificationAlgorithm</span>: <span class="n">HTTPS</span>
</code></pre>
</div>

<p>The HTTPS endpoint identification algorithm will cause Java to do hostname
verification against your cert. Specifically, this will check the hostname of
the client that made the request against the DN that is given in the client’s
certificate. If they do not match, the connection will be refused. This is a
great, <a href="http://tools.ietf.org/html/rfc2818#section-3.1">standard</a> way to solve
this problem, however it can be tricky to know what the hostnames will be or to
make a wildcard pattern (or <a href="https://tools.ietf.org/html/rfc3280#section-4.2.1.7">subject alternative name
extension</a>) for your
clients. We can take a higher-level approach than hostname comparison.</p>

<p>We can, instead, provide our server with a regular expression that matches the
DNs that we expect in our certificates. This means we no longer have to worry
about hostnames. So as services move from host to host, they can keep the same
certificate and everything will Just Work™.
Additionally, a certificate can belong to a service rather than an individual
host now so there’s less management that needs to happen. To do this, we just
need to set up a filter in our server and configure a regex to match the DN in
the certificate(s) that are allowed to communicate with our service or else
return a 403 response.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">javax.annotation.Priority</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.Priorities</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.container.ContainerRequestContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.container.ContainerRequestFilter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.container.PreMatching</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.core.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.core.Response</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.security.cert.X509Certificate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.Pattern</span><span class="o">;</span>

<span class="cm">/**
* A ContainerRequestFilter to do certificate validation beyond the tls validation.
* For example, the filter matches the subject against a regex and will 403 if it doesn't match
*
* @author &lt;a href="mailto:wdawson@okta.com"&gt;wdawson&lt;/a&gt;
*/</span>
<span class="nd">@PreMatching</span>
<span class="nd">@Priority</span><span class="o">(</span><span class="n">Priorities</span><span class="o">.</span><span class="na">AUTHENTICATION</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CertificateValidationFilter</span> <span class="kd">implements</span> <span class="n">ContainerRequestFilter</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">X509_CERTIFICATE_ATTRIBUTE</span> <span class="o">=</span> <span class="s">"javax.servlet.request.X509Certificate"</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Pattern</span> <span class="n">dnRegex</span><span class="o">;</span>

    <span class="c1">// Although this is a class level field, Jersey actually injects a proxy</span>
    <span class="c1">// which is able to simultaneously serve more requests.</span>
    <span class="nd">@Context</span>
    <span class="kd">private</span> <span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">;</span>

    <span class="cm">/**
     * Constructor for the CertificateValidationFilter.
     *
     * @param dnRegex The regular expression to match subjects of certificates with.
     *                E.g.: "^CN=service1\.example\.com$"
     */</span>
    <span class="kd">public</span> <span class="nf">CertificateValidationFilter</span><span class="o">(</span><span class="n">String</span> <span class="n">dnRegex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dnRegex</span> <span class="o">=</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="n">dnRegex</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">filter</span><span class="o">(</span><span class="n">ContainerRequestContext</span> <span class="n">requestContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">X509Certificate</span><span class="o">[]</span> <span class="n">certificateChain</span> <span class="o">=</span> <span class="o">(</span><span class="n">X509Certificate</span><span class="o">[])</span> <span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">X509_CERTIFICATE_ATTRIBUTE</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">certificateChain</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">certificateChain</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">certificateChain</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">requestContext</span><span class="o">.</span><span class="na">abortWith</span><span class="o">(</span><span class="n">buildForbiddenResponse</span><span class="o">(</span><span class="s">"No certificate chain found!"</span><span class="o">));</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// The certificate of the client is always the first in the chain.</span>
        <span class="n">X509Certificate</span> <span class="n">clientCert</span> <span class="o">=</span> <span class="n">certificateChain</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
        <span class="n">String</span> <span class="n">clientCertDN</span> <span class="o">=</span> <span class="n">clientCert</span><span class="o">.</span><span class="na">getSubjectDN</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">dnRegex</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">clientCertDN</span><span class="o">).</span><span class="na">matches</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">requestContext</span><span class="o">.</span><span class="na">abortWith</span><span class="o">(</span><span class="n">buildForbiddenResponse</span><span class="o">(</span><span class="s">"Certificate subject is not recognized!"</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">Response</span> <span class="nf">buildForbiddenResponse</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">reutrn</span> <span class="n">Response</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="n">Response</span><span class="o">.</span><span class="na">Status</span><span class="o">.</span><span class="na">FORBIDDEN</span><span class="o">)</span>
                <span class="o">.</span><span class="na">entity</span><span class="o">(</span><span class="s">"{\"message\":\""</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s">"\"}"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p style="text-align: center;font-size: x-small;">Dropwizard code is Copyright © 2010-2013 Coda Hale, Yammer Inc., 2014-2015 Dropwizard Team and/or its affiliates.
<a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache 2.0</a>.
Jersey code is Copyright © 2010-2015 Oracle and/or its affiliates.
<a href="https://jersey.java.net/license.html">GPL 2.0 Selected</a>.</p>

<h2 id="circling-back">Circling Back</h2>

<p>We defined TLS client authentication and went over how it can help secure your
backend services. We walked through configuring a Dropwizard server with
mandatory TLS client authentication and creating a Jersey client to provide the
appropriate credentials when talking to that server. We also talked about
options to further restrict clients’ ability to talk to the server based on
their certificates. I hope you have a better understanding of how to implement
mutual SSL in your applications. Below are a few things to also keep in mind as
you implement these authentication concepts in your applications.</p>

<ul>
  <li><a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#Security">TLS Protocol Security</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#Cipher">Cipher Suites</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Authentication#Authorization">Authorization</a></li>
  <li><a href="https://www.java.com/en/download/faq/release_dates.xml">JVM Security Updates</a></li>
</ul>

<h4 id="references">References</h4>
<ol>
  <li><a href="https://www.sslshopper.com/article-most-common-java-keytool-keystore-commands.html">Common keytool commands</a></li>
  <li><a href="https://www.sslshopper.com/article-most-common-openssl-commands.html">Common openssl commands</a></li>
  <li><a href="http://www.dropwizard.io/0.7.0/docs/manual/configuration.html#man-configuration-https">Dropwizard https configuration manual</a></li>
  <li><a href="https://jersey.java.net/documentation/latest/client.html#d0e5128">Jersey client documentation</a></li>
</ol>

	  </section>
	</article>
</div>
</section>
<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2015/06/11/trustpage">The New Age of Trust</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-vimarsh_karbhari.jpg"
	           alt="avatar-vimarsh_karbhari.jpg"
	           class="author-avatar">
	      <address>Vimarsh Karbhari</address>
	      &nbsp;
		  <a class="social_link" href="https://github.com/vimarshkarbhari-okta"><i class="fa fa-github-square"></i></a>
		  <a class="social_link" href="https://twitter.com/VimarshApi"><i class="fa fa-twitter-square"></i></a>
		  <a class="social_link" href="https://medium.com/@vimarshk/"><i class="fa fa-external-link-square"></i></a>
		  <span class="sepr">&middot;</span>
	      <time datetime="2015-06-11">June 11, 2015</time>
	    </div>
	  </header>
	  <section class="post-content">
	    <p>I recently read an excellent <a href="http://www.viabilify.com/blog/trust">article</a> about how amazing products shape the <strong>trust relationship</strong> with customers. I think great products are the <em>first step</em> in building a trust relationship. And like other aspects of the product that are derived from the product but are not physically part of it, the trust relationship is now more important than ever before.</p>

<hr />

<blockquote>
  <p>When you use a product, every engagement with that product has a direct correlation with your perception of the value of that product. — From <a href="http://www.viabilify.com/blog/trust">Product Loyalty Follows Trust Like Form Follows Function</a></p>
</blockquote>

<hr />

<p>These days, making sure your product solves problems that customers face everyday is not just a <em>good idea</em>, it’s <strong>table stakes</strong>. And the bar is rising constantly. The more products improve, the less customers are willing to tolerate bad experiences. With the consumerization of the enterprise, the importance of product design and favorable user experiences is indispensable to every kind of product distribution model.</p>

<p>Two of the most important aspects of the product are Product Status/Trust and Customer Support. Having dissected both of these from many angles in my recent work, I know that businesses neglect them at their peril.</p>

<h3 id="communicate-transparently">Communicate transparently</h3>

<p>The Product Status/Trust page is the first place customers visit on your site when they have a problem. Consider yourself lucky if the customer only had an problem with a browser (like cache), or an issue with their laptop. For more serious issues, customers expect transparency and effective communication from the Product Status/Trust page. They want information that communicates exactly what the problem is. </p>

<h3 id="serve-multiple-audiences">Serve multiple audiences</h3>
<p>A Product Status/Trust page is also one of the first places that prospects are likely to visit. In fact, when the product is gaining momentum, prospect traffic may exceed customer traffic. </p>

<p>I’ve rarely seen a Status/Trust page actually serve both customers and prospects effectively. The key is to find the correct balance. As the product becomes popular, customers and prospects visit the page with very different mindsets.</p>

<p>For customers, the Status/Trust page must be the source of truth for issues, downtime, and root cause analysis. This requires radical transparency and effective communication.</p>

<p>For prospects, the Status/Trust page must do at least the following:</p>

<ul>
  <li>Display all the information they need to make an informed decision</li>
  <li>Make them love the product even more</li>
  <li>Serve as an effective talking point for your sales reps</li>
</ul>

<p>Once users get their hands on a product, they often find new ways to use it that the founders never imagined. This experimentation can shape the future of products and platforms. This is especially true of products that also provide APIs. The growth of B2B2C, B2C2B and other hybrid distribution models means that you are putting your product in front of many different types of audiences, including direct customers, partners, resellers, channel partners, and early and late stage prospects. Understanding how all of these audiences report on the service, interpret the SLA, and react to downtime is crucial if you want to create products that users value.</p>

<h3 id="be-highly-available-but-prepare-for-risk">Be highly available but prepare for risk </h3>

<p>It is a truism that one cannot solve for all technical constraints. Choosing the right platform on which to build your Product and Status/Trust pages is very important, but hosting both pages on the same platform risks both being down at the same time if your site crashes. </p>

<p>Obviously, you cannot afford to let your Trust/Status page go down, so <strong>high availability</strong> is key. But just in case the page ever <em>does</em> go down, you need a <strong>risk mitigation plan</strong>. Central to this is making sure that you are contsantly monitoring your Trust/Status page with enterprise-class monitoring tools.</p>

<h3 id="send-rapid-robust-and-consistent-notifications">Send rapid, robust, and consistent notifications</h3>
<p>In the event of trust page problems, make sure that you have ways to easily and automatically notify customers and site ops as soon as issues are detected. Employ RSS, Twitter, and other channels to notify customers; invest in monitoring tools to notify site ops.</p>

<p>If you send notifications manually, take care not to introduce human error when the site is having issues, as these are usually chaotic periods for your ops team.</p>

<p>Realize that many of your customers will probably check your trust page <em>and</em> call support, so it’s important that the trust page and the support team provide the same information. This also argues for ensuring that your support team is a key stakeholder in the development of your trust page. </p>

<h3 id="conclusion">Conclusion</h3>

<p>Designing and developing the Trust Page has taught me much in the last few months. I’d be happy to hear from you on this topic, so please feel free to send comments or questions to <a href="mailto:vimarsh.karbhari@okta.com">vimarsh.karbhari@okta.com</a>.</p>

<p><em>The Trust Page is the work of an amazing team that includes Tim Gu, Shawn Gupta, Nathan Tate, Wendy Liao, and myself.</em></p>

	  </section>
	</article>
</div>
</section>
<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2015/05/22/tcmalloc">How Okta Chased Down Severe System CPU Contention in MySQL</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-okta_logo.jpg"
	           alt="avatar-okta_logo.jpg"
	           class="author-avatar">
	      <address>Okta Staff</address>
	      &nbsp;
		  <span class="sepr">&middot;</span>
	      <time datetime="2015-05-22">May 22, 2015</time>
	    </div>
	  </header>
	  <section class="post-content">
	    <p>Sometimes fixing a problem causes or reveals a new one. And sometimes this sets off a chain reaction of problems and fixes, where each solution exposes a deeper issue. In technology, cascades like these are common, often painful, and occasionally welcome.</p>

<p>Our battle against CPU contention last fall is a good example of such a cascade. What began as a buffer pool adjustment triggered a series of issues and fixes that generated plenty of stress, but ultimately strengthened our platform.</p>

<p>Underlying each of the challenges we faced in that period was the huge amount of business our Sales organization had closed in late summer and early Fall of 2014. Growth brought a dramatic increase in the number of new customers running large import jobs and new orgs running agents.</p>

<p>As problems go, growing pains are good problems to have. But they usually come at a cost: the increased traffic caused significant CPU contention, as shown in the following image.</p>

<p><img style="width:55%" src="/assets/img/Pre-buffer_adjustment.png" alt="Before tuning the database" /></p>

<p>Those red and yellow spikes in late October, 2014 seized our attention and spurred an aggressive response from Okta’s site operations team. The team took immediate action to prevent this situation from getting worse and potentially causing a issue with our site.</p>

<h2 id="tuning-the-database">Tuning the database</h2>

<p>As a first step, we tuned our MySQL database to fully utilize the amount of RAM in our server instances. We had been running with a relatively small buffer pool
compared to the amount of available RAM, which meant that we were sacrificing both performance and money.  Increasing the size of the buffer pool decreased page response times and nearly eliminated disk reads.</p>

<p><img style="width:50%" src="/assets/img/EliminateDiskReads.png" alt="Almost eliminated disk reads" /></p>

<h2 id="doubling-hardware-resources">Doubling hardware resources</h2>

<p>Despite the buffer pool adjustment, we continued to see significant CPU contention. In response, we doubled the size of our servers (244 GB of RAM, 32 CPU cores, and 2 x 320 GB HDDs). CPU contention decreased (see the trough in the following image), but probably because of the Thanksgiving holiday, not the additional hardware.</p>

<p>After the holiday, CPU spikes returned, now worse than ever. Page render time slowed down, queries against the database took longer, and jobs backed up.</p>

<p><img style="width:50%" src="/assets/img/Thanksgiving.png" alt="Thanksgiving holiday" /></p>

<p><strong>Note:</strong> Flat areas in the graph showing no CPU usage indicate periods when we were running on a secondary server.</p>

<p>Why did CPU contention increase after we’d doubled the CPUs? Shouldn’t it have decreased?</p>

<h2 id="kernel-mutex-bottleneck">Kernel mutex bottleneck</h2>

<p>The alarming amount of yellow in our graphs showed extremely high <strong>system CPU usage</strong> (and <strong>user CPU usage</strong> was also too high). Clearly, the operating system was working very hard at <em>something</em>. The metrics we pulled revealed that all the InnoDB threads were busy waiting on the kernel mutex. We had known that kernel mutex was a bottleneck even before we’d doubled hardware resources, but we hadn’t understood why.</p>

<p>A closer look at the MySQL source code showed that kernel mutex was trying to allocate memory to all of our transactions. This is perfectly normal behavior, but it proved to be very limiting in our case because we perform approximately 85,000 transactions per minute. The kernel has to create a transaction ID for each transaction and allocate a tiny block of memory in RAM before giving it to the thread handling the transaction.</p>

<p>Now we knew why doubling the number of CPUs caused greater contention: instead of  providing transaction IDs and associated memory to approximately 24 InnoDB threads, kernel mutex was now working like mad to provide IDs and memory to approximately 48 InnoDB threads. Imagine having a single toll booth on a 16 lane highway and then <em>doubling the number of lanes</em>.</p>

<p>In the discussions that followed, some called for rolling back to the smaller machines, reasoning that fewer threads would mean less CPU contention. Others believed that rolling backward would be a mistake, arguing that our business growth required the more powerful servers in any case, and that doubling the number of CPUs was not itself a problem, but rather part of the ultimate solution because it exposed the root cause of the extreme system CPU usage.</p>

<p>The right course – the one we ultimately took – was to stick with the more powerful servers and tune them properly.</p>

<h2 id="adopting-tcmalloc">Adopting TCMalloc</h2>

<p>We quickly found several resources online, including a <a href="http://goog-perftools.sourceforge.net/doc/tcmalloc.html">key blog post</a> about <strong>TCMalloc</strong> (Thread-Caching Memory Allocation) and an article about <a href="http://www.olivierdoucet.info/blog/2012/05/19/debugging-a-mysql-stall/">debugging MySQL</a>.</p>

<p>Traditional memory allocation schemes, like the <strong>glibc</strong> malloc that we were then using, employ a mutex to prevent concurrent access to the transaction ID counter.  Preventing concurrency is totally wrong for a multi-core, multi-thread architecture like ours.</p>

<p>In contrast, TCMalloc allocates a small pool of memory to each CPU core. Individual processor threads obtain RAM directly from their core, ideally from the L2 cache nearest the thread’s section of the CPU. This sounded promising, so we switched to TCMalloc.</p>

<p>Following the switch, things looked pretty good. User CPU decreased dramatically, never to return to the +50% usage we’d seen before.  We had finally solved the memory allocation bottleneck. If we hadn’t doubled the number of CPUs, we wouldn’t have found the problem that lead us to adopt TCMalloc.</p>

<p><em>Had we finally solved our scalability problem?</em></p>

<h2 id="transparent-huge-pages-thanks-for-your-helpplease-dont-help">Transparent Huge Pages: Thanks for your help…please don’t help</h2>

<p>By the next morning <strong>CPU contention was worse</strong>.</p>

<p>The alarmingly high system CPU usage that we’d seen in the previous 3 months was always due to MySQL using kernel mutex. But since we’d fixed that problem, <em>what the heck was this?</em></p>

<p>We discussed turning off TCMalloc, but that would’ve been a mistake. Implementing TCMalloc was a critical link in the chain of problems and solutions that ultimately strengthened our platform.</p>

<p>We discovered very quickly that the culprit this time was a <em>khugepaged</em> enabled by a Linux kernel flag called <strong>Transparent Huge Pages</strong> (THP; turned on by default in most Linux distributions). Huge pages are designed to improve performance by helping the operating system manage large amounts of memory. They effectively increase the page size from the standard 4kb to 2MB or 1Gb (depending on how it is configured).</p>

<p><strong>THP</strong> makes huge pages easier to use by, among other things, arranging your memory into larger chunks.  It works great for app servers that are not performing memory-intensive operations.</p>

<p>Which is why THP is so wrong for our platform. By late 2014 we were using 95% of the RAM and 58% of the 32 CPU cores in our servers . In order to store all of those tiny transaction IDs, we were rewriting memory so rapidly that THP’s efforts to move pages around couldn’t keep up. Clearly, standard 4kb blocks were much more efficient for us than the larger page size that THP was “helping” us with. So we turned THP off. The following image tells the story.</p>

<p><img style="width:40%" src="/assets/img/TCMalloc.png" alt="TCMalloc" /></p>

<p><strong>Note:</strong> Flat areas in the graph showing no CPU usage indicate periods when we were running on a secondary server.</p>

<p>In a sense, encountering the dramatic effect of THP, an operating system problem, was clarifying. It validated our previous remedies, and turning it off definitely strengthened our platform.</p>

<h2 id="lessons-learned">Lessons learned</h2>

<p>Beyond the technical lessons we learned during this period, we were reminded that sometimes the best thing to do is stay the course. At times we were tempted to pull back, but moving forward ultimately paid off as each improvement we made exposed the inadequacy (for our platform) of a downstream component.</p>

	  </section>
	</article>
</div>
</section>
<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2015/05/08/software-engineering-design-principles">Okta Software Engineering Design Principles</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-jon_todd.jpg"
	           alt="avatar-jon_todd.jpg"
	           class="author-avatar">
	      <address>Jon Todd</address>
	      &nbsp;
		  <a class="social_link" href="https://github.com/jontodd"><i class="fa fa-github-square"></i></a>
		  <a class="social_link" href="https://twitter.com/jonrtodd"><i class="fa fa-twitter-square"></i></a>
		  <a class="social_link" href="http://www.jontodd.com"><i class="fa fa-external-link-square"></i></a>
		  <span class="sepr">&middot;</span>
	      <time datetime="2015-05-08">May 8, 2015</time>
	    </div>
	  </header>
	  <section class="post-content">
	    <p>Okta has been an agile development shop since the beginning. One important
aspect of being agile is enabling a mix of bottom-up and top-down decision
making. Specifically where high level vision and strategy is clearly
communicated enabling teams to autonomously deliver value while also feeding back
learnings from the trenches to inform the high level
goals.<sup id="fnref:the-knowledge-creating-company"><a href="#fn:the-knowledge-creating-company" class="footnote">1</a></sup> Below are the tacit engineering design
principles we’ve used to guide development at Okta. They continue to evolve
as we experiment and learn.</p>

<h2 id="1-create-user-value">1. Create User Value</h2>

<p>First and foremost, writing software is about creating value for users. This
seems straight forward, but as systems evolve and become more complex we
start introducing more abstraction and layering which brings us further away
from the concrete problem we’re trying to solve. It’s important to keep in mind
the reason for writing software in the first place and use the understanding
of the audience to inform priority.</p>

<p>At Okta, our entire company is aligned on this principle because our #1 core
value is <a href="https://www.okta.com/customers/focus-on-customer-success.html">customer
success</a>.  In
practice this means there’s almost always a number of customers eager to beta a
new feature we’re working on. We collaborate closely with customers while
building features allowing for continuous feedback as we iterate and get
changes out in weekly sprints.</p>

<p><img src="http://imgs.xkcd.com/comics/the_general_problem.png" alt="xkcd - pass the salt" /></p>

<h2 id="2-keep-it-simple">2. Keep it Simple</h2>

<blockquote>
  <p>Everything should be made as simple as possible, but no simpler — Albert
  Einstein</p>
</blockquote>

<p>This truism has been around for ages, and it goes hand-in-hand with the
first principle.  If it doesn’t add value to users now, <a href="http://en.wikipedia.org/wiki/You_aren%27t_gonna_need_it">you ain’t gonna
need it - YAGNI</a>!</p>

<p>We all encounter overly complex code where it’s nearly impossible to reason
about what it does. Part of this confusion is because it’s
generally <a href="http://www.joelonsoftware.com/articles/fog0000000069.html">harder to read code than to write
it</a> but beyond 
that, there are clearly fundamental qualities of some code making it
more intuitive than other code. There’s a lot of prior art on this topic and a
great place to start is <a href="http://books.google.com/books?id=dwSfGQAACAAJ">Clean
Code</a> by Robert C. Martin, aka
Uncle Bob. The book breaks down the qualities of code which make it
intuitive, and provides a framework for reasoning about code quality.</p>

<p>Here are some guiding principles about writing clean code we use in practice
which are also covered in the book.</p>

<p>Clean code:</p>

<ul>
  <li>Makes intent clear, use comments when code isn’t expressive enough</li>
  <li>Can be read and enhanced by others (or the author after a few
years)</li>
  <li>Provides one way, rather than many, to do a particular task</li>
  <li>Is idomatic</li>
  <li>Is broken into pieces which each does one thing and does it well</li>
</ul>

<p>At the end of the day there is no substitue for experience, like any craft,
writing clean code takes practice. At Okta every engineer is constantly honing
their skills, we rely heavily on code reviews and pair programming to help hone
each other’s skills.</p>

<p><img src="/assets/img/2015-05-08-software-engineering-design-principles-code_quality_wtfs_per_minute.jpg" alt="wtfs per minute" /></p>

<h2 id="3-know-thy-service-with-data">3. Know Thy-Service With Data</h2>

<p>In the world of “big data” this point needs little explanation. Okta collects
massive amounts of operational data about our systems to:</p>

<ul>
  <li>Monitor health</li>
  <li>Monitor performance</li>
  <li>Debug issues</li>
  <li>Audit security</li>
  <li>Make decisions</li>
</ul>

<p>With every new feature we add, developers are responsible for ensuring that
their designs provide visibility into these dimensions. In order to make this an
efficient process we’ve invested in:</p>

<ul>
  <li>Runtime logging control toggling by level, class, tenant, user</li>
  <li>Creation of dashboards and alerts is self-service</li>
  <li>Every developer has access to metrics and anonymous unstructured data</li>
  <li>Request ID generated at edge is passed along at every layer of stack for
correlation</li>
  <li>Engineering control panel for common operational tasks like taking threaddumps</li>
</ul>

<p>Technologies we use to gain visibility include: PagerDuty, RedShift,
Zabbix, ThousandEyes, Boundary, Pingdom, App Dynamics, Splunk, ELK, S3.</p>

<h2 id="4-make-failure-cheap">4. Make Failure Cheap</h2>

<p>Every software system will experience failures and all code has bugs. While we
constantly work at having fewer, it’s unrealistic to assume they won’t occur. So,
in addition to investing in prevention, we invest in making failure cheap.</p>

<p>The cost of failure becomes significantly more expensive 
further out on the development timeline. Making adjustments 
during requirements gather and design are significantly cheaper than 
finding issues in production.<sup id="fnref:agile-cost-curve"><a href="#fn:agile-cost-curve" class="footnote">2</a></sup></p>

<p><img src="/assets/img/2015-05-08-software-engineering-design-principles-agile-cost-curve.png" alt="cost curve of development" /></p>

<p>One fundamental we take from both Agile and XP is to invest in pushing failure
as early in the development timeline as possible. We mitigate failures from
poor requirements gathering by iterating quickly with the customer as described in
Principle 1. Once we get to design and development we make failure cheap through:</p>

<ul>
  <li>Design reviews with stakeholders ahead of writing code</li>
  <li>TDD - developers write all tests for their code; test isn’t a separate phase
from development</li>
  <li>Keeping master stable - check-in to master is gated by passing all unit,
functional and UI tests</li>
  <li>Developers can trigger CI on any topic branch; CI is massively parallelized
over a cloud of fast machines</li>
</ul>

<p>Since our testing phase is done during development the next phase is production
deployments. At this phase we reduce the cost of failure by:</p>

<ul>
  <li>Hiding beta features behind flags in the code</li>
  <li>Incremental rollout first to test accounts and then in batches of customers</li>
  <li>Automated deployment process</li>
  <li>Code and infrastructure is forwards and backwards compatible allowing
rollback</li>
  <li>Health check and automatically remove down nodes</li>
  <li>Return a degraded / read-only response over nothing at all</li>
</ul>

<blockquote>
  <p>An escalator can never break; it can only become stairs – Mitch Hedberg</p>
</blockquote>

<h2 id="5-automate-everything">5. Automate Everything</h2>

<p>All tasks performed routinely should
be automated. These are automation principles we follow:</p>

<ul>
  <li>Automate every aspect of the deployment including long running db migrations</li>
  <li>All artifacts are immutable and versioned</li>
  <li>All code modules get dependencies automatically from central artifact server</li>
  <li>Creation of base images and provisioning of new hardware is automated</li>
  <li>All forms of testing are automated</li>
  <li>Development environment setup is automated</li>
</ul>

<p>Tools we use:</p>

<ul>
  <li>AWS - Automated provisioning of hardware</li>
  <li>Chef - Configuration managment</li>
  <li>Ansible - Automated deployment orchestration</li>
  <li>Jenkins - Continuous integration</li>
  <li>Gearman - To get Jenkins to scale</li>
  <li>Docker - Containerizing services</li>
</ul>

<h2 id="6-with-performance-less-is-more">6. With Performance, Less is More</h2>

<p>We find especially with performance, there are typically huge wins to be had in
up front design decisions which may come at very little to no cost. Our design
mantras for performance are:</p>

<ol>
  <li>Don’t do it</li>
  <li>Do it, but don’t do it again</li>
  <li>Do it less</li>
  <li>Do it later</li>
  <li>Do it when they’re not looking</li>
  <li>Do it concurrently</li>
  <li>Do it cheaper</li>
</ol>

<p>In practice we implement a number of strategies to limit risk to poorly
performing code:</p>

<ul>
  <li>Major new features and performance tunings live behind feature flags allowing
slow rollout and tuning in real life environment</li>
  <li>Chunk everything that scales on order of N. When N is controlled by customer
enforce limits and design for infinity.</li>
  <li>Slow query and frequent query monitoring to detect poor access patterns</li>
</ul>

<p><img style="max-width:300px" src="/assets/img/2015-05-08-software-engineering-design-principles-more_is_less.jpg" alt="if less is more, does that mean more is less?" /></p>

<h3 id="reference">Reference</h3>

<div class="footnotes">
  <ol>
    <li id="fn:the-knowledge-creating-company">
      <p>Ikujiro Nonaka, and Hirotaka Takeuchi. The Knowledge Creating Company. Oxford University Press, 1995. Print. https://books.google.com/books/about/The_Knowledge_creating_Company.html?id=B-qxrPaU1-MC&nbsp;<a href="#fnref:the-knowledge-creating-company" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:agile-cost-curve">
      <p>Scott Ambler. Examining the Agile Cost of Change Curve. Website. http://www.agilemodeling.com/essays/costOfChange.htm&nbsp;<a href="#fnref:agile-cost-curve" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

	  </section>
	</article>
</div>
</section>
<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2015/05/08/productionalizing-active-mq">Productionalizing ActiveMQ</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-okta_logo.jpg"
	           alt="avatar-okta_logo.jpg"
	           class="author-avatar">
	      <address>Okta Staff</address>
	      &nbsp;
		  <span class="sepr">&middot;</span>
	      <time datetime="2015-05-08">May 8, 2015</time>
	    </div>
	  </header>
	  <section class="post-content">
	    <p>This post describes our odyssey with ActiveMQ, an open-source version of the Java Messaging Service (JMS) API. We use ActiveMQ as the message broker among our app servers.</p>

<p>First, a word of thanks. To overcome the challenges we faced with ActiveMQ, we are greatly indebted to a very thorough description of an <a href="https://bugs.openjdk.java.net/browse/JDK-8054446">OpenJDK bug</a>, as well as some other <a href="https://svn.apache.org/repos/asf/harmony/standard/classlib/trunk/modules/concurrent/src/main/java/java/util/concurrent/ConcurrentLinkedQueue.java">online resources</a>. If you’re having problems with ActiveMQ, read on. Maybe our story can help you.</p>

<h2 id="growing-pains">Growing Pains</h2>

<p>Our problems with ActiveMQ date all the way back to 2012. They centered around high memory and CPU usage, message timeout errors, and message queue delays.</p>

<p>Let’s pick up the action in the spring 2014. At that time we were battling a new wave of timeout storms and message queue delays caused by our mixed ActiveMQ configuration (broker <strong>5.4.1</strong>, client <strong>5.7</strong>) and increasing traffic on our site.</p>

<p>Of course we welcomed the growth in traffic as a byproduct of our growing business. And although we did plan to address our mixed ActiveMQ configuration, we decided to delay doing so at that time, opting instead to tune the configuration. So we increased the maximum session size from 500 to 2000, and the page size from 200 to 2000 messages. Increasing the page size served to minimize “hung queue” scenarios — a side effect of using <a href="http://docs.oracle.com/cd/E19798-01/821-1841/bncer/index.html">message selectors</a>.</p>

<h2 id="another-inflection-point">Another Inflection Point</h2>

<p>Business and site traffic continued to grow, contributing to another inflection point in the fall of 2014. Timeout storms, CPU spikes, and memory issues returned. It was clear that we could no longer put off upgrading to a newer version of ActiveMQ.</p>

<p>We decided to skip versions 5.7 and 5.8 in favor of 5.10, mainly because 5.7 was considered unstable, and 5.10 provided improved failover performance.</p>

<p>Would this upgrade finally deliver the stability that had eluded us for so long?</p>

<h2 id="when-upgrades-bite-back">When Upgrades Bite Back</h2>

<p>Unfortunately, no. Within 24 hours, memory usage soared, CPUs spiked, and instability returned. Note the dramatic CPU spikes in the following screenshot.</p>

<p><img style="width:50%" src="/assets/img/2015-05-08-productionalizing-active-mq-cpu-graph-1.png" alt="Active MQ CPU" /></p>

<p>To prevent these issues from impacting customers, we were forced to restart brokers, which is always an option of
last resort. Restarting brokers is a delicate operation, which can entail a less-than-smooth failover,
risking message loss.</p>

<p>We immediately increased memory, but within a day or two we ran out of memory again.</p>

<h2 id="searching-for-the-root-cause">Searching for the Root Cause</h2>

<p>An online search turned up an <a href="https://bugs.openjdk.java.net/browse/JDK-8054446">OpenJDK bug</a> that identified an out of memory issue in the
<em>ConcurrentLinkedQueue</em>, which is a class in the <strong>java.util.concurrent</strong> package included in <strong>JVM version 1.6</strong>.
When working properly, <em>ConcurrentLinkedQueue</em> allows elements to be added and removed from the queue in a
thread-safe manner.</p>

<p>The bug caused a null object to be created whenever an element at the end of the queue was added and
then deleted. This behavior is particularly unfavorable to the way we use queuing. We call ActiveMQ
to create and destroy objects in the queue very quickly, tens of millions of times a day, as users
and agents connect to Okta. As a result, null objects rapidly fill up the queue, memory usage soars,
and CPUs spike.</p>

<h2 id="conference-call">Conference Call</h2>

<p>With the site at risk of impacting customer authentication, several key engineers, including Hector
Aguilar, Okta’s CTO and SVP of Engineering, met on a Saturday afternoon conference call. Discussion was intense, and our options were few and unappealing:
(a) revert all the way back to broker version 5.4.1, or (b) upgrade to broker version 5.11, which
was still unreleased and might introduce new problems.</p>

<p>As team members recall, Hector said very little during the first half of the meeting.</p>

<p>A bug in the JVM surprised Hector, as critical JVM bugs are relatively rare. Fortunately, the
OpenJDK bug we’d found included a very thorough description of the problem, as well as sample code
to reproduce it.</p>

<p>Initially motivated by curiosity, Hector analyzed the code and the bug description. He saw where the
problem was, and then checked online to see if it had been fixed in newer JDK versions. He noticed that
several things were changing in the class, and that others had attempted to resolve the bug in
different ways, but none that would solve our particular problem. Hector developed a very simple fix
of his own, trying to remain consistent with the work of others. He then verified his fix using the
provided sample code.</p>

<p>The JVM has a mechanism called <em>endorsed libraries</em> that allows developers to override an existing
class with a new class, effectively patching the JVM. Hector used this mechanism, packaged his fix
into a jar file, tried it against ActiveMQ, and found that it worked.</p>

<p>The mood and direction of the meeting shifted dramatically when Hector said, <em>“Guys, I have a wild
idea. What if we patch the JVM?”</em> As none of us had ever patched a JVM before, this seemed like a novel approach, even a long
shot.</p>

<h2 id="the-fix">The Fix</h2>

<p>Hector sent his JVM patch and sample code to the team and walked us through it. First, he explained
why the other attempted fixes wouldn’t solve our particular problem. He then demonstrated how his override effectively patched the original (faulty) removal method. Members of the
team volunteered to test the override at scale with our simulated environments. Within a few hours,
we were fairly sure that Hector’s fix would work.</p>

<h2 id="deploying-the-patch">Deploying the Patch</h2>

<p>We deployed the patch and restarted brokers. It was a success! ActiveMQ no longer ran out of memory
and the CPU spikes ceased.</p>

<p><img style="width:50%" src="/assets/img/2015-05-08-productionalizing-active-mq-cpu-graph-2.png" alt="Active MQ CPU" /></p>

<p>Some minor memory leaks remained, but these were eliminated by upgrading to <strong>java-1.7.0</strong>.</p>

<h2 id="stable-and-looking-at-other-solutions">Stable, and looking at other solutions</h2>

<p>Patching the <em>ConcurrentLinkedQueue</em> with ActiveMQ v5.10 and upgrading to java-1.7.0 provided
acceptable stability and faster failover performance. While this is a significant improvement over
where we were last fall, our goal is <strong>zero failover time</strong>, which ActiveMQ cannot deliver. So, we’re exploring other messaging solutions.</p>

<p>In telling our story, we couldn’t resist tooting our own horn a bit. How many CTOs actually get
their hands dirty tackling product issues? Our CTO doesn’t code very often, but when
he does, he patches the JVM.</p>

	  </section>
	</article>
</div>
</section>
<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2015/04/23/android-unit-testing-part-4">Android Unit Testing Part IV&#58; Mocking</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-victor_ronin.png"
	           alt="avatar-victor_ronin.png"
	           class="author-avatar">
	      <address>Victor Ronin</address>
	      &nbsp;
		  <a class="social_link" href="https://github.com/vronin"><i class="fa fa-github-square"></i></a>
		  <a class="social_link" href="http://victorronin.com/en/"><i class="fa fa-external-link-square"></i></a>
		  <span class="sepr">&middot;</span>
	      <time datetime="2015-04-23">April 23, 2015</time>
	    </div>
	  </header>
	  <section class="post-content">
	    <p><em>This is the third of a four part series on Android Unit Testing. In
the last two articles I discussed the <a href="https://www.okta.com/blog/2015/01/android-unit-testing-part-i-what-makes-strong-test-automation/">general principles of having
good
tests</a>
and the way to <a href="/blog/2015/04/07/android-unit-testing-part-2">run Android tests on JVM making them
fast</a> and <a href="/blog/2015/04/14/android-unit-testing-part-3/">how to make
your code less coupled</a>.
This article will explain how to make tests isolated.</em></p>

<p>We need to mock a dependency, inject it, and then modify our test to
indicate that we are not testing an end-to-end scenario anymore, but
are now testing just one class at a time.</p>

<ul>
  <li>
    <p>Modify application Gradle file</p>

    <p>Add the following code under the dependency section:</p>

    <div class="language-conf highlighter-rouge"><pre class="highlight"><code><span class="n">androidTestCompile</span> <span class="s1">'org.easymock:easymock:3.1'</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>Replace <code class="highlighter-rouge">FooTest</code> with the following code:</p>

    <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">myapplication</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">junit.framework.Assert</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.easymock.EasyMockSupport</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Before</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.robolectric.RobolectricTestRunner</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">EasyMock</span><span class="o">.</span><span class="na">expect</span><span class="o">;</span>

<span class="nd">@RunWith</span><span class="o">(</span><span class="n">RobolectricTestRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FooTest</span> <span class="kd">extends</span> <span class="n">EasyMockSupport</span> <span class="o">{</span>
    <span class="n">Foo</span> <span class="n">sut</span><span class="o">;</span>

    <span class="c1">// Mocks</span>
    <span class="n">Bar</span> <span class="n">barMock</span><span class="o">;</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">sut</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Foo</span><span class="o">();</span>

        <span class="c1">// Create mocks</span>
        <span class="n">barMock</span> <span class="o">=</span> <span class="n">createMock</span><span class="o">(</span><span class="n">Bar</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="c1">// Inject mock</span>
        <span class="n">InjectHelper</span><span class="o">.</span><span class="na">injectMock</span><span class="o">(</span><span class="n">sut</span><span class="o">,</span> <span class="n">barMock</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGetFoo_returns4</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// Arrange</span>
        <span class="n">expect</span><span class="o">(</span><span class="n">barMock</span><span class="o">.</span><span class="na">getBar</span><span class="o">()).</span><span class="na">andReturn</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
        <span class="n">replayAll</span><span class="o">();</span>

        <span class="c1">// Act</span>
        <span class="kt">int</span> <span class="n">actualResult</span> <span class="o">=</span> <span class="n">sut</span><span class="o">.</span><span class="na">getFoo</span><span class="o">();</span>

        <span class="c1">// Assert</span>
        <span class="n">verifyAll</span><span class="o">();</span>
        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="n">actualResult</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>Create a class <code class="highlighter-rouge">InjectHelper</code> under <code class="highlighter-rouge">androidTest</code></p>

    <p>(I believe the original code for injecting fields is from <strong>Spring</strong>; however, it was modified afterwards.)</p>

    <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">myapplication</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">InjectHelper</span> <span class="o">{</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">injectMock</span><span class="o">(</span><span class="n">Object</span> <span class="n">target</span><span class="o">,</span> <span class="n">Object</span> <span class="n">mock</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">Class</span> <span class="n">targetClass</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
        <span class="k">do</span> <span class="o">{</span>
            <span class="n">Field</span><span class="o">[]</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">targetClass</span><span class="o">.</span><span class="na">getDeclaredFields</span><span class="o">();</span>
            <span class="c1">// Iterate through all members</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Field</span> <span class="n">field</span> <span class="o">:</span> <span class="n">fields</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Skip all non injectable members</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">field</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">Inject</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="k">continue</span><span class="o">;</span>

                <span class="c1">// Make private/prptected members accessible</span>
                <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

                <span class="c1">// Get a class of the member</span>
                <span class="n">Class</span> <span class="n">injectedClass</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="na">getType</span><span class="o">();</span>
                <span class="n">Class</span> <span class="n">mockClass</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>

                <span class="c1">// Check that mock is essentially the same class</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">injectedClass</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">mockClass</span><span class="o">))</span>
                    <span class="k">continue</span><span class="o">;</span>

                <span class="k">try</span> <span class="o">{</span>
                    <span class="c1">// Inject mock</span>
                    <span class="n">field</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">mock</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span>
                <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="c1">// return accessibility</span>
                <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">targetClass</span> <span class="o">=</span> <span class="n">targetClass</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">targetClass</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">targetClass</span> <span class="o">!=</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
    </div>

    <p><strong>Woo-Hoo! We are finally done!</strong></p>

    <p>Now, your tests are:</p>

    <ul>
      <li><strong>fast</strong> — they are executed on a JVM and don’t require going to the network or a persistent layer.</li>
      <li><strong>repeatable</strong> — they don’t depend on emulator stability or network quality.</li>
      <li>(potentially!) <strong>simple</strong> and <strong>consistent</strong> — there is a lot of good information out there on how to write good unit tests.</li>
      <li><strong>independent</strong> — since the persistent layer isn’t used, one test won’t influence another.</li>
    </ul>

    <p>In addition to all of this awesomeness, your code should actually be
better off, too. Hopefully writing unit tests will force you to
simplify classes with too many dependencies and more carefully think
through interfaces.</p>

    <p>Thanks!</p>

    <p>Let me mention several people who helped me to put this article
together: <a href="https://www.linkedin.com/pub/william-dawson/43/140/837">Wils Dawson</a> made the initial move to use Robolectric,
<a href="https://www.linkedin.com/in/nadeemlinkedin">Nadeem Khan</a> figured out all those pesky details about usage of
Robolectric, and <a href="https://www.linkedin.com/pub/hans-reichenbach/20/94b/5b8">Hans Reichenbach</a> put a lot of these integration
steps in writing on our wiki. Thanks guys!</p>

    <p><a href="https://github.com/vronin-okta/okta_blog_samples/tree/master/android_unit_testing">https://github.com/vronin-okta/okta_blog_samples/tree/master/android_unit_testing</a></p>
  </li>
</ul>

	  </section>
	</article>
</div>
</section>
<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2015/04/14/android-unit-testing-part-3">Android Unit Testing Part III&#58; Disintegration</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-victor_ronin.png"
	           alt="avatar-victor_ronin.png"
	           class="author-avatar">
	      <address>Victor Ronin</address>
	      &nbsp;
		  <a class="social_link" href="https://github.com/vronin"><i class="fa fa-github-square"></i></a>
		  <a class="social_link" href="http://victorronin.com/en/"><i class="fa fa-external-link-square"></i></a>
		  <span class="sepr">&middot;</span>
	      <time datetime="2015-04-14">April 14, 2015</time>
	    </div>
	  </header>
	  <section class="post-content">
	    <p><em>This is the third of a four part series on Android Unit Testing. In
the last two articles I discussed the <a href="https://www.okta.com/blog/2015/01/android-unit-testing-part-i-what-makes-strong-test-automation/">general principles of having
good
tests</a>
and the way to <a href="/blog/2015/04/07/android-unit-testing-part-2">run Android tests on JVM making them
fast</a>. This
part will show how to make your Android code less heavily
coupled. This is a preparation step to ensure that your tests are
isolated from each other.</em></p>

<p>We want to test each unit of work separately to make sure that each
piece of our machinery is working properly. We need to be able to
inject all dependencies into classes under the test (instead of this
class instantiating a production dependency). I am not a fan of
manual dependency injection (i.e., passing them through a
constructor or setters). Such a manual method requires a lot of code
and drags all dependencies through multiple classes to inject them
into the end class.</p>

<p>There are a lot of dependency injection frameworks for Android out
there: Dagger, RoboGuice, SpringAndroid, Guice, and Transfuse are a
few. I won’t go into a detailed comparison, but I like Dagger the
most because it provides compile time injection, and doesn’t
influence runtime (specifically startup time) too much.</p>

<p>Again, here there are detailed tutorials at the end of this post and
my summary is below:</p>

<h2 id="my-summary">My Summary</h2>

<ul>
  <li>
    <p>Modify the application Gradle file</p>

    <p>Add the following code under the dependency section:</p>

    <div class="language-conf highlighter-rouge"><pre class="highlight"><code><span class="n">compile</span> <span class="s1">'com.squareup.dagger:dagger:1.2.1'</span>
<span class="n">provided</span> <span class="s1">'com.squareup.dagger:dagger-compiler:1.2.1'</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>Modify the manifest</p>

    <p>Add the following code to the Application tags:</p>

    <div class="language-conf highlighter-rouge"><pre class="highlight"><code><span class="n">android</span>:<span class="n">name</span>=<span class="s2">".MyApplication"</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>Create the classes</p>

    <p>Add the <code class="highlighter-rouge">MyApplication</code> class.</p>

    <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyApplication</span> <span class="kd">extends</span> <span class="n">Application</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">ObjectGraph</span> <span class="n">applicationGraph</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>

        <span class="n">applicationGraph</span> <span class="o">=</span> <span class="n">ObjectGraph</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">getModules</span><span class="o">().</span><span class="na">toArray</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">getModules</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Arrays</span><span class="o">.&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="n">asList</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">MyModule</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
        <span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inject</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">applicationGraph</span><span class="o">.</span><span class="na">inject</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>Add the <code class="highlighter-rouge">MyModule</code> class.</p>

    <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">myapplication</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">dagger.Module</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">dagger.Provides</span><span class="o">;</span>

<span class="nd">@Module</span><span class="o">(</span>
        <span class="n">injects</span> <span class="o">=</span> <span class="o">{</span>
                <span class="n">MainActivity</span><span class="o">.</span><span class="na">class</span>
        <span class="o">}</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyModule</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">MyApplication</span> <span class="n">application</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MyModule</span><span class="o">(</span><span class="n">MyApplication</span> <span class="n">application</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">application</span> <span class="o">=</span> <span class="n">application</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>Modify <code class="highlighter-rouge">MainActivity</code> and replace code <code class="highlighter-rouge">private Foo
foo = new Foo();</code> with:</p>

    <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@Inject</span>
<span class="n">Foo</span> <span class="n">foo</span><span class="o">;</span>
</code></pre>
    </div>

    <p>and add following code to <code class="highlighter-rouge">onCreate()</code>:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>// This will inject all @Inject members
// recursively for everything what is marked as @Inject
((MyApplication)getApplicationContext()).inject(this);
</code></pre>
    </div>
  </li>
  <li>
    <p>Modify the <code class="highlighter-rouge">Foo</code> class and replace code <code class="highlighter-rouge">Bar bar = new Bar();</code> with:</p>

    <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@Inject</span>
<span class="n">Bar</span> <span class="n">bar</span><span class="o">;</span>
</code></pre>
    </div>

    <p>Modify Bar class and add</p>

    <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@Inject</span>
<span class="n">Bar</span><span class="o">()</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre>
    </div>
  </li>
</ul>

<p>Now, instances of <code class="highlighter-rouge">Foo</code> and <code class="highlighter-rouge">Bar</code> are
automatically injected in the runtime. However, your test will fail
with NPE, because the Foo class has a Bar dependency which wasn’t
delivered. I.e., we don’t want it injected by Dagger -— we want mocked
dependency, not a real one.</p>

<h2 id="resources">Resources</h2>

<ul>
  <li><a href="http://antonioleiva.com/dependency-injection-android-dagger-part-1/">Dependency injection on Android: Dagger (Part 1)</a></li>
  <li><a href="http://antonioleiva.com/dagger-android-part-2/">Dependency injection on Android: Dagger (Part 2)</a></li>
</ul>

<p>Stay tuned for the final part of our series, where I will show you
how to make tests isolated. You can also check out the full code at
<a href="https://github.com/vronin-okta/okta_blog_samples/tree/master/android_unit_testing">GitHub</a>.</p>

	  </section>
	</article>
</div>
</section>
<section >
<div class="wrap">
	<article class="post-block">
	  <header class="post-title-block">
	    <h1><a href="/blog/2015/04/07/android-unit-testing-part-2">Android Unit Testing Part II&#58; Escaping Dalvik’s Hold</a></h1>
	    <div class="attribution">
	      <img src="/assets/img/avatar-victor_ronin.png"
	           alt="avatar-victor_ronin.png"
	           class="author-avatar">
	      <address>Victor Ronin</address>
	      &nbsp;
		  <a class="social_link" href="https://github.com/vronin"><i class="fa fa-github-square"></i></a>
		  <a class="social_link" href="http://victorronin.com/en/"><i class="fa fa-external-link-square"></i></a>
		  <span class="sepr">&middot;</span>
	      <time datetime="2015-04-07">April 7, 2015</time>
	    </div>
	  </header>
	  <section class="post-content">
	    <p><em>This is the second of a four part series on Android Unit Testing. In
these posts, we’ll walk through the key steps engineers should take
to make Android test fast by running them on JVM (versus running
them on emulator).</em></p>

<p><em>For background information on the importance of Android testing, <a href="https://www.okta.com/blog/2015/01/android-unit-testing-part-i-what-makes-strong-test-automation/">visit Part I of the series</a>.</em></p>

<p>It appears that the need to run tests on an Android device or an
emulator has concerned Android engineers for almost as long as Android
has existed – and <a href="https://www.linkedin.com/pub/christian-williams/8/4/30b">Christian Williams</a> created <a href="http://robolectric.org/">Robolectric</a> to solve
this problem. Robolectric allows you to run unmodified test code
(referring to Android specific classes) on your desktop (in a JVM)
instead of running them on an emulator or device in the Android
Virtual Machine, or <a href="http://en.wikipedia.org/wiki/Dalvik_%28software%29">Dalvik</a>.</p>

<p>I have listed several good tutorials at the end of this post that
illustrate exactly how this can be done, but they also include some
details you may not yet need. So, use the tutorial links for details,
but check out “My Summary” for a short overview of what you need to
do:</p>

<h2 id="my-summary">My Summary</h2>

<ul>
  <li>
    <p>Create a new project in Android Studio (I used Studio 0.8.14)</p>

    <p>Choose as example Blank Activity project.</p>
  </li>
  <li>
    <p>Modify the TOP Gradle file</p>

    <p>Add the following code to the dependencies section:</p>

    <div class="language-conf highlighter-rouge"><pre class="highlight"><code><span class="n">classpath</span> <span class="s1">'org.robolectric:robolectric-gradle-plugin:0.12.+'</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>Modify the application Gradle file</p>

    <p>Add the following code under <code class="highlighter-rouge">apply plugin: ‘com.android.application'</code>:</p>

    <div class="language-conf highlighter-rouge"><pre class="highlight"><code><span class="n">apply</span> <span class="n">plugin</span>: <span class="s1">'robolectric'</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>Add the following under the dependencies section:</p>

    <div class="language-conf highlighter-rouge"><pre class="highlight"><code><span class="n">androidTestCompile</span>(<span class="s1">'junit:junit:4.11'</span>)
<span class="n">androidTestCompile</span>(<span class="s1">'org.robolectric:robolectric:2.3'</span>)
</code></pre>
    </div>
  </li>
  <li>
    <p>Add this section:</p>

    <div class="language-conf highlighter-rouge"><pre class="highlight"><code><span class="n">robolectric</span> {
        <span class="n">include</span> <span class="s1">'**/*Test.class'</span>
}
</code></pre>
    </div>
  </li>
  <li>
    <p>Create the code that you want to test</p>

    <p>Modify <code class="highlighter-rouge">MainActivity</code>. Add the following code to it:</p>

    <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">private</span> <span class="n">Foo</span> <span class="n">foo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Foo</span><span class="o">();</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getSomething</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">foo</span><span class="o">.</span><span class="na">getFoo</span><span class="o">();</span>
<span class="o">}</span>
</code></pre>
    </div>

    <p>Add the <code class="highlighter-rouge">Foo</code> class:</p>

    <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">myapplication</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
    <span class="n">Bar</span> <span class="n">bar</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bar</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getFoo</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">bar</span><span class="o">.</span><span class="na">getBar</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>Add the <code class="highlighter-rouge">Bar</code> class:</p>

    <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">myapplication</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Bar</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getBar</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">4</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>Create a test</p>

    <p>Delete the <code class="highlighter-rouge">ApplicationTest</code> file.</p>

    <p>Create the following <code class="highlighter-rouge">FooTest</code> class under your <code class="highlighter-rouge">androidTest</code>:</p>

    <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">myapplication</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">junit.framework.Assert</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Before</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.robolectric.RobolectricTestRunner</span><span class="o">;</span>

<span class="nd">@RunWith</span><span class="o">(</span><span class="n">RobolectricTestRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FooTest</span> <span class="o">{</span>
    <span class="n">Foo</span> <span class="n">sut</span><span class="o">;</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">sut</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Foo</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGetFoo_returns4</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// Arrange</span>

        <span class="c1">// Act</span>
        <span class="kt">int</span> <span class="n">actualResult</span> <span class="o">=</span> <span class="n">sut</span><span class="o">.</span><span class="na">getFoo</span><span class="o">();</span>

        <span class="c1">// Assert</span>
        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="n">actualResult</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>Create the configuration</p>

    <ol>
      <li>Create a <strong>gradle</strong> configuration.</li>
      <li>Set “<strong>Tests</strong>” as a name.</li>
      <li>Choose the top gradle file as a project.</li>
      <li>Type <em>test</em> in <strong>Tasks</strong>.</li>
    </ol>

    <p>Now, without launching the emulator, you can run this configuration
and see that your test has passed. It is much faster than before—and
repeatable. You can put this under build automation and it will
totally work.</p>
  </li>
  <li>
    <p>JVM</p>

    <p>There are alternative ways to run the test on a JVM. For example,
you can create a <strong>JUnit</strong> task and ensure that all your tests and
classes don’t touch any Android specific classes. However, this is
not easy, as you must design all your code with this restriction in
mind.</p>

    <p>The changes which we did to run on JVM are great, but we are still
facing the limitations of using integration tests. For example, if
the implementation of a <code class="highlighter-rouge">Bar</code> class changes and now uses the network,
you might start seeing flakiness in the <code class="highlighter-rouge">testGetFoo_returns4</code> test
because of a bad network connection.</p>
  </li>
</ul>

<h2 id="additional-resources">Additional Resources</h2>

<ul>
  <li><a href="https://github.com/codepath/android_guides/wiki/Robolectric-Installation-for-Unit-Testing">Robolectric Installation for Unit Testing</a></li>
  <li><a href="http://www.peterfriese.de/android-testing-with-robolectric/">Android Testing With Robolectric</a></li>
  <li><a href="https://github.com/robolectric/robolectric-gradle-plugin">Robolectric Gradle Plugin</a></li>
</ul>

<p>Stay tuned for part three of our series, where I will show you how
to achieve test isolation using dependency injection. You can also
check out the full code at <a href="https://github.com/vronin-okta/okta_blog_samples/tree/master/android_unit_testing">GitHub</a>.</p>

	  </section>
	</article>
</div>
</section>

	</div>
</section>

		
	</div><footer class="footer">
      <div class="Wrap">
        <ul>
          <li>
            <a href="https://www.okta.com" target="_blank">Okta.com</a>
          </li>
          <li>
            <a href="/blog">Blog</a>
          </li>
          <li>
            <a href="/docs/platform-release-notes/platform-release-notes.html">Platform Release Notes</a>
          </li>
          <li>
            <a href="/terms/">Terms & Conditions</a>
          </li>
          <li>
            <a href="/3rd_party_notices/">3rd Party Notices</a>
          </li>
          <li>
            <a href="/privacy/">Privacy Policy</a>
          </li>
          <li>
            <a href="https://okta.com/developer/contact/">Contact Sales</a>
          </li>
          <li>
            <a href="mailto:developers@okta.com">Contact Support</a>
          </li>
        </ul>
        <ul>
          <li>
            <a class="icon" href="http://github.com/oktadeveloper" target="_blank"><i class="fa fa-github"></i></a>
          </li>
          <li>
            <a class="icon" href="http://twitter.com/okta" target="_blank"><i class="fa fa-twitter"></i></a>
          </li>
          <li>
            <a class="icon" href="http://stackoverflow.com/search?q=okta" target="_blank"><i class="fa fa-stack-overflow"></i></a>
          </li>
          <li>
            <a class="icon" href="http://feeds.feedburner.com/OktaBlog" target="_blank"><i class="fa fa-rss"></i></a>
          </li><!-- <li><a class="icon" href="http://community.okta.com" target="_blank"><i class="fa fa-comments"></i></a></li> -->
        </ul>
      </div>
    </footer>
    <script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous">
    </script>
    <script src="/assets/js/master.js">
    </script> <!-- Remarketing tag -->
    <script type="text/javascript">
        /* <![CDATA[ */
        var google_conversion_id = 1006913831;
        var google_custom_params = window.google_tag_params;
        var google_remarketing_only = true;
        /* ]]> */
    </script>
    <div style="display:none;">
      <script type="text/javascript" src="//www.googleadservices.com/pagead/conversion.js">
      </script>
    </div><noscript>
    <div style="display:inline;"><img height="1" width="1" style="border-style:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/1006913831/?value=0&amp;guid=ON&amp;script=0"></div></noscript> <!-- End Remarketing tag -->
     <!-- Crazy Egg Tracking -->
    <script type="text/javascript">
    setTimeout(function(){var a=document.createElement("script");
    var b=document.getElementsByTagName("script")[0];
    a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0021/9333.js?"+Math.floor(new Date().getTime()/3600000);
    a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
    </script> <!-- End Crazy Egg Tracking -->

</body>
</html>
